<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Solanaä¸Šå®ç°ETFä»£å¸çš„èµå›åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»£å¸é”€æ¯ã€æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§å’Œå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶">
<meta property="og:type" content="article">
<meta property="og:title" content="Solanaå®æˆ˜-ETFçš„èµå›">
<meta property="og:url" content="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/index.html">
<meta property="og:site_name" content="samxie52">
<meta property="og:description" content="æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Solanaä¸Šå®ç°ETFä»£å¸çš„èµå›åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»£å¸é”€æ¯ã€æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§å’Œå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-22T02:56:26.000Z">
<meta property="article:modified_time" content="2025-09-22T03:09:04.058Z">
<meta property="article:author" content="samxie">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/","path":"2025/09/22/Solanaå®æˆ˜-ETFçš„èµå›/","title":"Solanaå®æˆ˜-ETFçš„èµå›"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Solanaå®æˆ˜-ETFçš„èµå› | samxie52</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">samxie52</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">æ¦‚è¿°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41-ETF%E4%BB%A3%E5%B8%81%E9%94%80%E6%AF%81%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">æ­¥éª¤1: ETFä»£å¸é”€æ¯é€»è¾‘å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B%E5%AF%B9%E6%AF%94"><span class="nav-number">2.1.</span> <span class="nav-text">1. æƒé™æ¨¡å‹å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B5%84%E4%BA%A7%E6%B5%81%E5%90%91%E5%AF%B9%E6%AF%94"><span class="nav-number">2.2.</span> <span class="nav-text">2. èµ„äº§æµå‘å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-PDA%E7%AD%BE%E5%90%8D%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">2.3.</span> <span class="nav-text">3. PDAç­¾åæœºåˆ¶æ·±åº¦è§£æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%AA%8C%E8%AF%81"><span class="nav-number">2.4.</span> <span class="nav-text">4. æ•°é‡è®¡ç®—éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42-%E6%B3%A8%E5%86%8CETF%E8%B5%8E%E5%9B%9E%E6%8C%87%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">æ­¥éª¤2: æ³¨å†ŒETFèµå›æŒ‡ä»¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A4%8D%E7%94%A8%E8%B4%A6%E6%88%B7%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">1. å¤ç”¨è´¦æˆ·ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8F%82%E6%95%B0%E7%AE%80%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">2. å‚æ•°ç®€åŒ–</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B5%8E%E5%9B%9E%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">æ­¥éª¤3: å®¢æˆ·ç«¯èµå›å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B4%A6%E6%88%B7%E9%A1%BA%E5%BA%8F%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-number">4.1.</span> <span class="nav-text">1. è´¦æˆ·é¡ºåºçš„é‡è¦æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%94%99%E8%AF%AF%E9%A2%84%E9%98%B2%E6%9C%BA%E5%88%B6"><span class="nav-number">4.2.</span> <span class="nav-text">2. é”™è¯¯é¢„é˜²æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%B4%A6%E6%88%B7%E5%AD%98%E5%9C%A8%E6%80%A7%E9%AA%8C%E8%AF%81"><span class="nav-number">4.3.</span> <span class="nav-text">3. è´¦æˆ·å­˜åœ¨æ€§éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44-%E5%AE%8C%E6%95%B4%E8%B5%8E%E5%9B%9E%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">æ­¥éª¤4: å®Œæ•´èµå›æµç¨‹ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">æŠ€æœ¯æ·±åº¦è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B5%8E%E5%9B%9E%E6%93%8D%E4%BD%9C%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="nav-number">6.1.</span> <span class="nav-text">1. èµå›æ“ä½œçš„åŸå­æ€§ä¿éšœ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%8B%E5%8A%A1%E5%AE%8C%E6%95%B4%E6%80%A7"><span class="nav-number">6.1.1.</span> <span class="nav-text">A. äº‹åŠ¡å®Œæ•´æ€§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">6.1.2.</span> <span class="nav-text">B. çŠ¶æ€ä¸€è‡´æ€§</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">2. æƒé™éªŒè¯æœºåˆ¶æ·±åº¦åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-PDA%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">6.2.1.</span> <span class="nav-text">A. PDAæƒé™æ§åˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="nav-number">6.2.2.</span> <span class="nav-text">B. ç”¨æˆ·æƒé™éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E7%9A%84%E7%B2%BE%E7%A1%AE%E6%80%A7"><span class="nav-number">6.3.</span> <span class="nav-text">3. æ•°é‡è®¡ç®—çš„ç²¾ç¡®æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%9D%83%E9%87%8D%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F"><span class="nav-number">6.3.1.</span> <span class="nav-text">A. æƒé‡è®¡ç®—å…¬å¼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%B2%BE%E5%BA%A6%E5%A4%84%E7%90%86%E8%80%83%E8%99%91"><span class="nav-number">6.3.2.</span> <span class="nav-text">B. ç²¾åº¦å¤„ç†è€ƒè™‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%B2%BE%E5%BA%A6%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">6.3.3.</span> <span class="nav-text">C. ç²¾åº¦ä¼˜åŒ–å»ºè®®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">6.4.</span> <span class="nav-text">4. é”™è¯¯å¤„ç†æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.4.1.</span> <span class="nav-text">A. å¸¸è§é”™è¯¯ç±»å‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E9%94%99%E8%AF%AF%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5"><span class="nav-number">6.4.2.</span> <span class="nav-text">B. é”™è¯¯æ¢å¤ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">6.5.</span> <span class="nav-text">5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E4%BC%98%E5%8C%96"><span class="nav-number">6.5.1.</span> <span class="nav-text">A. æ‰¹é‡æ“ä½œä¼˜åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E8%AE%A1%E7%AE%97%E5%8D%95%E5%85%83%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4"><span class="nav-number">6.5.2.</span> <span class="nav-text">B. è®¡ç®—å•å…ƒåŠ¨æ€è°ƒæ•´</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E8%B4%A6%E6%88%B7%E9%A2%84%E5%8F%96%E4%BC%98%E5%8C%96"><span class="nav-number">6.5.3.</span> <span class="nav-text">C. è´¦æˆ·é¢„å–ä¼˜åŒ–</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.</span> <span class="nav-text">å®‰å…¨æ€§è€ƒè™‘ä¸æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB%E9%98%B2%E6%8A%A4"><span class="nav-number">7.1.</span> <span class="nav-text">1. é‡å…¥æ”»å‡»é˜²æŠ¤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%E9%A1%BA%E5%BA%8F"><span class="nav-number">7.1.1.</span> <span class="nav-text">A. çŠ¶æ€æ£€æŸ¥é¡ºåº</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-number">7.1.2.</span> <span class="nav-text">B. çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BB%B7%E6%A0%BC%E6%93%8D%E7%BA%B5%E9%98%B2%E6%8A%A4"><span class="nav-number">7.2.</span> <span class="nav-text">2. ä»·æ ¼æ“çºµé˜²æŠ¤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E8%B5%8E%E5%9B%9E%E9%99%90%E5%88%B6%E6%9C%BA%E5%88%B6"><span class="nav-number">7.2.1.</span> <span class="nav-text">A. èµå›é™åˆ¶æœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E4%BB%B7%E6%A0%BC%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-number">7.2.2.</span> <span class="nav-text">B. ä»·æ ¼éªŒè¯æœºåˆ¶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%81%E5%8A%A8%E6%80%A7%E9%A3%8E%E9%99%A9%E7%AE%A1%E7%90%86"><span class="nav-number">7.3.</span> <span class="nav-text">3. æµåŠ¨æ€§é£é™©ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%89%98%E7%AE%A1%E8%B5%84%E4%BA%A7%E5%85%85%E8%B6%B3%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-number">7.3.1.</span> <span class="nav-text">A. æ‰˜ç®¡èµ„äº§å……è¶³æ€§æ£€æŸ¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%B4%A7%E6%80%A5%E6%9A%82%E5%81%9C%E6%9C%BA%E5%88%B6"><span class="nav-number">7.3.2.</span> <span class="nav-text">B. ç´§æ€¥æš‚åœæœºåˆ¶</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AE%AE"><span class="nav-number">8.</span> <span class="nav-text">æ‰©å±•åŠŸèƒ½å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E5%88%86%E8%B5%8E%E5%9B%9E%E4%B8%8E%E5%AE%8C%E6%95%B4%E8%B5%8E%E5%9B%9E"><span class="nav-number">8.1.</span> <span class="nav-text">1. éƒ¨åˆ†èµå›ä¸å®Œæ•´èµå›</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BB%B6%E8%BF%9F%E8%B5%8E%E5%9B%9E%E6%9C%BA%E5%88%B6"><span class="nav-number">8.2.</span> <span class="nav-text">2. å»¶è¿Ÿèµå›æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%B5%8E%E5%9B%9E%E8%B4%B9%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">8.3.</span> <span class="nav-text">3. èµå›è´¹ç”¨æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%B5%8E%E5%9B%9E%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95"><span class="nav-number">8.4.</span> <span class="nav-text">4. èµå›å†å²è®°å½•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4%E6%8C%87%E5%8D%97"><span class="nav-number">9.</span> <span class="nav-text">æ•…éšœæ’é™¤æŒ‡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%9C%BA%E6%99%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">9.1.</span> <span class="nav-text">1. å¸¸è§é”™è¯¯åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E2%80%9CInvalidAccounts%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.1.</span> <span class="nav-text">A. â€œInvalidAccountsâ€ é”™è¯¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E2%80%9CInsufficientBalance%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.2.</span> <span class="nav-text">B. â€œInsufficientBalanceâ€ é”™è¯¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E2%80%9CTokenAccountNotFoundError%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.3.</span> <span class="nav-text">C. â€œTokenAccountNotFoundErrorâ€ é”™è¯¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.</span> <span class="nav-text">2. è°ƒè¯•æŠ€å·§ä¸å·¥å…·</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">9.2.1.</span> <span class="nav-text">A. äº¤æ˜“æ—¥å¿—åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E9%AA%8C%E8%AF%81%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.2.</span> <span class="nav-text">B. çŠ¶æ€éªŒè¯å·¥å…·</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-number">9.3.</span> <span class="nav-text">3. æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">9.3.1.</span> <span class="nav-text">A. äº¤æ˜“æˆæœ¬åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E6%89%B9%E9%87%8F%E8%B5%8E%E5%9B%9E%E4%BC%98%E5%8C%96"><span class="nav-number">9.3.2.</span> <span class="nav-text">B. æ‰¹é‡èµå›ä¼˜åŒ–</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.</span> <span class="nav-text">ä»£ç ä¼˜åŒ–å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Rust%E7%A8%8B%E5%BA%8F%E7%AB%AF%E4%BC%98%E5%8C%96"><span class="nav-number">10.1.</span> <span class="nav-text">1. Rustç¨‹åºç«¯ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%A2%9E%E5%BC%BA"><span class="nav-number">10.1.1.</span> <span class="nav-text">A. é”™è¯¯å¤„ç†å¢å¼º</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.1.2.</span> <span class="nav-text">B. æ€§èƒ½ä¼˜åŒ–å»ºè®®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-TypeScript%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%98%E5%8C%96"><span class="nav-number">10.2.</span> <span class="nav-text">2. TypeScriptå®¢æˆ·ç«¯ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E5%A2%9E%E5%BC%BA"><span class="nav-number">10.2.1.</span> <span class="nav-text">A. ç±»å‹å®‰å…¨å¢å¼º</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E4%BC%98%E5%8C%96"><span class="nav-number">10.2.2.</span> <span class="nav-text">B. ç”¨æˆ·ä½“éªŒä¼˜åŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9E%B6%E6%9E%84%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.3.</span> <span class="nav-text">3. æ¶æ„å±‚é¢ä¼˜åŒ–å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%A8%A1%E5%9D%97%E5%8C%96%E9%87%8D%E6%9E%84"><span class="nav-number">10.3.1.</span> <span class="nav-text">A. æ¨¡å—åŒ–é‡æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E9%85%8D%E7%BD%AE%E5%8C%96%E7%AE%A1%E7%90%86"><span class="nav-number">10.3.2.</span> <span class="nav-text">B. é…ç½®åŒ–ç®¡ç†</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="nav-number">11.</span> <span class="nav-text">æœ€ä½³å®è·µæ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E5%BB%BA%E8%AE%AE"><span class="nav-number">11.1.</span> <span class="nav-text">1. å¼€å‘æµç¨‹å»ºè®®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95"><span class="nav-number">11.2.</span> <span class="nav-text">2. å®‰å…¨æ£€æŸ¥æ¸…å•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A6%81%E7%82%B9"><span class="nav-number">11.3.</span> <span class="nav-text">3. æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E5%85%B3%E6%B3%A8%E7%82%B9"><span class="nav-number">11.4.</span> <span class="nav-text">4. ç”¨æˆ·ä½“éªŒå…³æ³¨ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">12.</span> <span class="nav-text">ç»“è®º</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">samxie</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="samxie">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="samxie52">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Solanaå®æˆ˜-ETFçš„èµå› | samxie52">
      <meta itemprop="description" content="æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Solanaä¸Šå®ç°ETFä»£å¸çš„èµå›åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»£å¸é”€æ¯ã€æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§å’Œå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Solanaå®æˆ˜-ETFçš„èµå›
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-22 10:56:26 / ä¿®æ”¹æ—¶é—´ï¼š11:09:04" itemprop="dateCreated datePublished" datetime="2025-09-22T10:56:26+08:00">2025-09-22</time>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Solanaä¸Šå®ç°ETFä»£å¸çš„èµå›åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»£å¸é”€æ¯ã€æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§å’Œå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><strong>ETFèµå›çš„æ ¸å¿ƒæœºåˆ¶</strong></p>
<p>åœ¨åŒºå—é“¾ETFç³»ç»Ÿä¸­ï¼Œèµå›ETFä»£å¸çš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯<strong>è´­ä¹°çš„é€†å‘æ“ä½œ</strong>ï¼š</p>
<ol>
<li><strong>ä»£å¸é”€æ¯</strong>ï¼šé”€æ¯ç”¨æˆ·æŒæœ‰çš„ETFä»£å¸</li>
<li><strong>èµ„äº§é‡Šæ”¾</strong>ï¼šä»ETFåˆçº¦æ‰˜ç®¡è´¦æˆ·ä¸­æŒ‰æƒé‡æ¯”ä¾‹è½¬ç§»åº•å±‚ä»£å¸ç»™ç”¨æˆ·</li>
<li><strong>ä»·å€¼ä¿æŒ</strong>ï¼šç¡®ä¿ç”¨æˆ·è·å¾—çš„åº•å±‚èµ„äº§ä»·å€¼ä¸é”€æ¯çš„ETFä»£å¸ä»·å€¼ç›¸ç­‰</li>
</ol>
<p><strong>æœ¬æ•™ç¨‹å®ç°çš„åŠŸèƒ½</strong>ï¼š</p>
<ul>
<li>éªŒè¯ç”¨æˆ·æŒæœ‰è¶³å¤Ÿçš„ETFä»£å¸ä½™é¢</li>
<li>æŒ‰æƒé‡æ¯”ä¾‹ä»ETFæ‰˜ç®¡è´¦æˆ·è½¬ç§»åº•å±‚ä»£å¸åˆ°ç”¨æˆ·è´¦æˆ·</li>
<li>é”€æ¯ç›¸åº”æ•°é‡çš„ETFä»£å¸</li>
<li>å¤„ç†å¤æ‚çš„è´¦æˆ·æƒé™å’ŒPDAç­¾åæœºåˆ¶</li>
</ul>
<p><strong>èµå›ä¸è´­ä¹°çš„å¯¹æ¯”</strong>ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ETFè´­ä¹°æµç¨‹ï¼š</span><br><span class="line">ç”¨æˆ·åº•å±‚ä»£å¸ â†’ ETFæ‰˜ç®¡è´¦æˆ·</span><br><span class="line">åŒæ—¶ï¼šæ—  â†’ ç”¨æˆ·è·å¾—ETFä»£å¸</span><br><span class="line"></span><br><span class="line">ETFèµå›æµç¨‹ï¼š</span><br><span class="line">ETFæ‰˜ç®¡è´¦æˆ· â†’ ç”¨æˆ·åº•å±‚ä»£å¸è´¦æˆ·  </span><br><span class="line">åŒæ—¶ï¼šç”¨æˆ·ETFä»£å¸ â†’ é”€æ¯</span><br></pre></td></tr></table></figure>

<h2 id="æ­¥éª¤1-ETFä»£å¸é”€æ¯é€»è¾‘å®ç°"><a href="#æ­¥éª¤1-ETFä»£å¸é”€æ¯é€»è¾‘å®ç°" class="headerlink" title="æ­¥éª¤1: ETFä»£å¸é”€æ¯é€»è¾‘å®ç°"></a>æ­¥éª¤1: ETFä»£å¸é”€æ¯é€»è¾‘å®ç°</h2><p><strong>ç›®çš„</strong>ï¼šå®ç°å®Œæ•´çš„ETFèµå›æµç¨‹ï¼ŒåŒ…æ‹¬åº•å±‚èµ„äº§è½¬ç§»å’ŒETFä»£å¸é”€æ¯ã€‚</p>
<p><strong>æ–‡ä»¶ä½ç½®</strong>ï¼š<code>../ibuidl-etf-dapp/anchor/programs/counter/src/instructions/etf_token_burn.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::get_associated_token_address, </span><br><span class="line">    token::&#123;burn, transfer, Burn, Transfer&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::&#123;</span><br><span class="line">    accounts_ix::EtfTokenTransaction, </span><br><span class="line">    states::&#123;EtfToken, TokenMintError&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”¥ ETFä»£å¸èµå›çš„æ ¸å¿ƒå®ç°å‡½æ•°</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°å¤„ç†ETFä»£å¸çš„é”€æ¯å’Œåº•å±‚èµ„äº§çš„è¿”è¿˜</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// è¦èµå›çš„ETFä»£å¸æ•°é‡ï¼ˆä»¥æœ€å°å•ä½è®¡ç®—ï¼‰</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ” å‡†å¤‡ETFä¿¡æ¯è´¦æˆ·(PDA)çš„ç­¾åç§å­</span></span><br><span class="line">    <span class="comment">// ETFæ‰˜ç®¡è´¦æˆ·çš„ä»£å¸è½¬ç§»éœ€è¦PDAç­¾åæˆæƒ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// &quot;etf_token_v3&quot; - å›ºå®šå‰ç¼€</span></span><br><span class="line">        m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// mintè´¦æˆ·åœ°å€</span></span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],        <span class="comment">// bumpå€¼ï¼Œç¡®ä¿PDAç­¾åæœ‰æ•ˆ</span></span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ“‹ æ„å»ºå‰©ä½™è´¦æˆ·çš„å¿«é€ŸæŸ¥æ‰¾æ˜ å°„è¡¨</span></span><br><span class="line">    <span class="comment">// remaining_accountsåŒ…å«æ‰€æœ‰åº•å±‚ä»£å¸çš„ç”¨æˆ·è´¦æˆ·å’ŒETFæ‰˜ç®¡è´¦æˆ·</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">        .remaining_accounts</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))    <span class="comment">// å°†è´¦æˆ·åœ°å€ä½œä¸ºkeyï¼Œè´¦æˆ·ä¿¡æ¯ä½œä¸ºvalue</span></span><br><span class="line">        .collect::&lt;HashMap&lt;_, _&gt;&gt;();        <span class="comment">// åˆ›å»ºHashMapç”¨äºO(1)æ—¶é—´å¤æ‚åº¦çš„æŸ¥æ‰¾</span></span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;ğŸ“Š Processing &#123;&#125; constituent tokens for redemption&quot;</span>, ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">len</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ”„ éå†ETFçš„æ¯ä¸ªç»„æˆä»£å¸ï¼Œæ‰§è¡Œèµ„äº§è¿”è¿˜</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ğŸ” è·å–ETFæ‰˜ç®¡çš„åº•å±‚ä»£å¸è´¦æˆ·åœ°å€</span></span><br><span class="line">        <span class="comment">// è¿™æ˜¯ETFåˆçº¦æ§åˆ¶çš„åº•å±‚ä»£å¸å­˜å‚¨è´¦æˆ·</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">from_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ETFä¿¡æ¯è´¦æˆ·åœ°å€ï¼ˆä½œä¸ºæ‰˜ç®¡æ–¹ï¼‰</span></span><br><span class="line">                &amp;x.token,                            <span class="comment">// åº•å±‚ä»£å¸mintåœ°å€</span></span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°è´¦æˆ·ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ” è·å–ç”¨æˆ·çš„åº•å±‚ä»£å¸å…³è”è´¦æˆ·åœ°å€</span></span><br><span class="line">        <span class="comment">// è¿™æ˜¯ç”¨æˆ·æ¥æ”¶è¿”è¿˜ä»£å¸çš„è´¦æˆ·</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">to_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ç”¨æˆ·åœ°å€</span></span><br><span class="line">                &amp;x.token,                       <span class="comment">// åº•å±‚ä»£å¸mintåœ°å€</span></span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°è´¦æˆ·ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ’° è®¡ç®—éœ€è¦è¿”è¿˜ç»™ç”¨æˆ·çš„åº•å±‚ä»£å¸æ•°é‡</span></span><br><span class="line">        <span class="comment">// å…¬å¼: (æƒé‡ / 100) * èµå›çš„ETFæ•°é‡</span></span><br><span class="line">        <span class="comment">// è¿™ç¡®ä¿äº†æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ’¸ æ‰§è¡Œåº•å±‚ä»£å¸è½¬ç§»æ“ä½œ</span></span><br><span class="line">        <span class="comment">// ä»ETFæ‰˜ç®¡è´¦æˆ·è½¬ç§»åˆ°ç”¨æˆ·è´¦æˆ· - è¿™ä¸è´­ä¹°æ—¶çš„æ–¹å‘ç›¸å</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// SPL Tokenç¨‹åº</span></span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: from_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// è½¬å‡ºè´¦æˆ·ï¼ˆETFæ‰˜ç®¡ï¼‰</span></span><br><span class="line">                    to: to_ata.<span class="title function_ invoke__">to_account_info</span>(),              <span class="comment">// è½¬å…¥è´¦æˆ·ï¼ˆç”¨æˆ·ï¼‰</span></span><br><span class="line">                    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// è½¬ç§»æˆæƒè€…ï¼ˆETF PDAï¼‰</span></span><br><span class="line">                &#125;,</span><br><span class="line">                signer_seeds  <span class="comment">// PDAç­¾åï¼Œè¯æ˜ETFåˆçº¦æœ‰æƒé™è½¬ç§»æ‰˜ç®¡èµ„äº§</span></span><br><span class="line">            ),</span><br><span class="line">            amount,  <span class="comment">// è½¬ç§»æ•°é‡</span></span><br><span class="line">        )?;</span><br><span class="line"></span><br><span class="line">        msg!(<span class="string">&quot;âœ… Successfully transferred &#123;&#125; units of token &#123;&#125; from ETF to user&quot;</span>, </span><br><span class="line">             amount, x.token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ”¥ é”€æ¯ç”¨æˆ·çš„ETFä»£å¸</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯èµå›è¿‡ç¨‹çš„æœ€åä¸€æ­¥ï¼Œç¡®ä¿ETFä»£å¸ä¾›åº”é‡çš„æ­£ç¡®æ€§</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),   <span class="comment">// SPL Tokenç¨‹åº</span></span><br><span class="line">            Burn &#123;</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// ETFä»£å¸mint</span></span><br><span class="line">                from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// ç”¨æˆ·çš„ETFä»£å¸è´¦æˆ·</span></span><br><span class="line">                authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// é”€æ¯æˆæƒè€…ï¼ˆç”¨æˆ·ï¼‰</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        lamports,  <span class="comment">// é”€æ¯çš„ETFä»£å¸æ•°é‡</span></span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;ğŸ”¥ Successfully burned &#123;&#125; ETF tokens from user account &#123;&#125;&quot;</span>, </span><br><span class="line">         lamports, ctx.accounts.etf_token_ata.<span class="title function_ invoke__">key</span>());</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ¸å¿ƒé€»è¾‘è§£æ</strong>ï¼š</p>
<h3 id="1-æƒé™æ¨¡å‹å¯¹æ¯”"><a href="#1-æƒé™æ¨¡å‹å¯¹æ¯”" class="headerlink" title="1. æƒé™æ¨¡å‹å¯¹æ¯”"></a>1. æƒé™æ¨¡å‹å¯¹æ¯”</h3><p><strong>è´­ä¹°æ—¶çš„æƒé™æµ</strong>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è´­ä¹°ï¼šç”¨æˆ·æˆæƒè½¬ç§»åº•å±‚ä»£å¸</span></span><br><span class="line">Transfer &#123;</span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// ç”¨æˆ·ç­¾å</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´­ä¹°ï¼šPDAæˆæƒé“¸é€ ETFä»£å¸  </span></span><br><span class="line">MintTo &#123;</span><br><span class="line">    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// PDAç­¾å</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>èµå›æ—¶çš„æƒé™æµ</strong>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµå›ï¼šPDAæˆæƒè½¬ç§»æ‰˜ç®¡èµ„äº§</span></span><br><span class="line">Transfer &#123;</span><br><span class="line">    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// PDAç­¾å</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµå›ï¼šç”¨æˆ·æˆæƒé”€æ¯ETFä»£å¸</span></span><br><span class="line">Burn &#123;</span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// ç”¨æˆ·ç­¾å  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-èµ„äº§æµå‘å¯¹æ¯”"><a href="#2-èµ„äº§æµå‘å¯¹æ¯”" class="headerlink" title="2. èµ„äº§æµå‘å¯¹æ¯”"></a>2. èµ„äº§æµå‘å¯¹æ¯”</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">è´­ä¹°æµç¨‹ï¼š</span><br><span class="line">ç”¨æˆ·USDCè´¦æˆ· â†’ ETFæ‰˜ç®¡USDCè´¦æˆ·</span><br><span class="line">ç”¨æˆ·SOLè´¦æˆ·  â†’ ETFæ‰˜ç®¡SOLè´¦æˆ·</span><br><span class="line">æ—           â†’ ç”¨æˆ·ETFä»£å¸è´¦æˆ·</span><br><span class="line"></span><br><span class="line">èµå›æµç¨‹ï¼š</span><br><span class="line">ETFæ‰˜ç®¡USDCè´¦æˆ· â†’ ç”¨æˆ·USDCè´¦æˆ·</span><br><span class="line">ETFæ‰˜ç®¡SOLè´¦æˆ·  â†’ ç”¨æˆ·SOLè´¦æˆ·  </span><br><span class="line">ç”¨æˆ·ETFä»£å¸è´¦æˆ· â†’ é”€æ¯</span><br></pre></td></tr></table></figure>

<h3 id="3-PDAç­¾åæœºåˆ¶æ·±åº¦è§£æ"><a href="#3-PDAç­¾åæœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="3. PDAç­¾åæœºåˆ¶æ·±åº¦è§£æ"></a>3. PDAç­¾åæœºåˆ¶æ·±åº¦è§£æ</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">    EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// ç±»å‹æ ‡è¯†ç¬¦</span></span><br><span class="line">    m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// ç»‘å®šç‰¹å®šETF</span></span><br><span class="line">    &amp;[ctx.bumps.etf_token_info],        <span class="comment">// ç¡®ä¿åœ°å€å”¯ä¸€æ€§</span></span><br><span class="line">]];</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆéœ€è¦PDAç­¾å</strong>ï¼š</p>
<ul>
<li>ETFåˆçº¦éœ€è¦èƒ½å¤Ÿæ§åˆ¶æ‰˜ç®¡çš„åº•å±‚èµ„äº§</li>
<li>åªæœ‰æ­£ç¡®çš„PDAæ‰èƒ½ä»£è¡¨ETFåˆçº¦æ‰§è¡Œè½¬ç§»æ“ä½œ</li>
<li>é˜²æ­¢æ¶æ„åˆçº¦æˆ–ç”¨æˆ·ç›—å–æ‰˜ç®¡èµ„äº§</li>
</ul>
<h3 id="4-æ•°é‡è®¡ç®—éªŒè¯"><a href="#4-æ•°é‡è®¡ç®—éªŒè¯" class="headerlink" title="4. æ•°é‡è®¡ç®—éªŒè¯"></a>4. æ•°é‡è®¡ç®—éªŒè¯</h3><p><strong>èµå›æ•°é‡è®¡ç®—ç¤ºä¾‹</strong>ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·èµå› 1000ä¸ªETFä»£å¸ï¼ŒETFç»„æˆä¸ºï¼š</span><br><span class="line">- SOL (æƒé‡40%): è¿”è¿˜ 40 * 1000 / 100 = 400ä¸ªSOL</span><br><span class="line">- USDC (æƒé‡30%): è¿”è¿˜ 30 * 1000 / 100 = 300ä¸ªUSDC</span><br><span class="line">- BTC (æƒé‡20%): è¿”è¿˜ 20 * 1000 / 100 = 200ä¸ªBTC  </span><br><span class="line">- ETH (æƒé‡10%): è¿”è¿˜ 10 * 1000 / 100 = 100ä¸ªETH</span><br><span class="line"></span><br><span class="line">éªŒè¯: 40% + 30% + 20% + 10% = 100% âœ“</span><br></pre></td></tr></table></figure>

<h2 id="æ­¥éª¤2-æ³¨å†ŒETFèµå›æŒ‡ä»¤"><a href="#æ­¥éª¤2-æ³¨å†ŒETFèµå›æŒ‡ä»¤" class="headerlink" title="æ­¥éª¤2: æ³¨å†ŒETFèµå›æŒ‡ä»¤"></a>æ­¥éª¤2: æ³¨å†ŒETFèµå›æŒ‡ä»¤</h2><p><strong>ç›®çš„</strong>ï¼šåœ¨ä¸»ç¨‹åºä¸­æš´éœ²ETFèµå›åŠŸèƒ½çš„å…¬å…±æ¥å£ã€‚</p>
<p><strong>æ–‡ä»¶ä½ç½®</strong>ï¼š<code>../ibuidl-etf-dapp/anchor/programs/counter/src/lib.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ”¥ ETFä»£å¸èµå›çš„å…¬å…±æ¥å£</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œç”¨äºèµå›ETFä»£å¸å¹¶è·å¾—åº•å±‚èµ„äº§</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// è¦èµå›çš„ETFä»£å¸æ•°é‡</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç°</span></span><br><span class="line">    <span class="comment">// ä¿æŒæ¥å£ç®€æ´ï¼Œå°†å¤æ‚é€»è¾‘å°è£…åœ¨ç‹¬ç«‹æ¨¡å—ä¸­</span></span><br><span class="line">    instructions::<span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ¥å£è®¾è®¡è€ƒè™‘</strong>ï¼š</p>
<h3 id="1-å¤ç”¨è´¦æˆ·ç»“æ„"><a href="#1-å¤ç”¨è´¦æˆ·ç»“æ„" class="headerlink" title="1. å¤ç”¨è´¦æˆ·ç»“æ„"></a>1. å¤ç”¨è´¦æˆ·ç»“æ„</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµå›å’Œè´­ä¹°ä½¿ç”¨ç›¸åŒçš„è´¦æˆ·ç»“æ„ä½“</span></span><br><span class="line">Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>ä»£ç å¤ç”¨</strong>ï¼šå‡å°‘é‡å¤çš„è´¦æˆ·å®šä¹‰</li>
<li><strong>ä¸€è‡´æ€§</strong>ï¼šä¿æŒè´­ä¹°å’Œèµå›æ“ä½œçš„ä¸€è‡´æ€§</li>
<li><strong>ç»´æŠ¤æ€§</strong>ï¼šåªéœ€è¦ç»´æŠ¤ä¸€å¥—è´¦æˆ·éªŒè¯é€»è¾‘</li>
</ul>
<h3 id="2-å‚æ•°ç®€åŒ–"><a href="#2-å‚æ•°ç®€åŒ–" class="headerlink" title="2. å‚æ•°ç®€åŒ–"></a>2. å‚æ•°ç®€åŒ–</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lamports: <span class="type">u64</span>,  <span class="comment">// å•ä¸€å‚æ•°ï¼Œç®€åŒ–æ¥å£</span></span><br></pre></td></tr></table></figure>

<p><strong>è®¾è®¡ç†å¿µ</strong>ï¼š</p>
<ul>
<li>ç”¨æˆ·åªéœ€è¦æŒ‡å®šè¦èµå›çš„ETFæ•°é‡</li>
<li>åº•å±‚èµ„äº§çš„åˆ†é…ç”±ç¨‹åºè‡ªåŠ¨è®¡ç®—</li>
<li>å‡å°‘ç”¨æˆ·æ“ä½œçš„å¤æ‚æ€§</li>
</ul>
<h2 id="æ­¥éª¤3-å®¢æˆ·ç«¯èµå›å®ç°"><a href="#æ­¥éª¤3-å®¢æˆ·ç«¯èµå›å®ç°" class="headerlink" title="æ­¥éª¤3: å®¢æˆ·ç«¯èµå›å®ç°"></a>æ­¥éª¤3: å®¢æˆ·ç«¯èµå›å®ç°</h2><p><strong>ç›®çš„</strong>ï¼šæä¾›å®Œæ•´çš„å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹ï¼Œå¤„ç†è´¦æˆ·ç®¡ç†å’Œäº¤æ˜“å‘é€ã€‚</p>
<p><strong>æ–‡ä»¶ä½ç½®</strong>ï¼š<code>../ibuidl-etf-dapp/anchor/example/api/etf_token.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&quot;./const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">BN</span> &#125; <span class="keyword">from</span> <span class="string">&quot;bn.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@solana/web3.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getAssociatedTokenAddressSync &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/spl-token&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; deriveEtfokenInfoAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./address&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”¥ ETFä»£å¸èµå›çš„å®Œæ•´å®¢æˆ·ç«¯å®ç°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurn</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,      <span class="comment">// ç”¨æˆ·é’±åŒ…</span></span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,      <span class="comment">// ETFä»£å¸çš„mintåœ°å€</span></span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span>,           <span class="comment">// èµå›æ•°é‡ï¼ˆæœ€å°å•ä½ï¼‰</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ“ æ´¾ç”ŸETFä¿¡æ¯è´¦æˆ·åœ°å€</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç¡®å®šæ€§ç®—æ³•ç”ŸæˆETFé…ç½®ä¿¡æ¯çš„å­˜å‚¨åœ°å€</span></span><br><span class="line">    <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(etfAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ“– è·å–ETFé…ç½®ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// ä»é“¾ä¸Šè¯»å–ETFçš„ç»„æˆä»£å¸å’Œæƒé‡é…ç½®</span></span><br><span class="line">    <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ“Š ETF Configuration for redemption:&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">constituent</span>: etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> (&#123;</span><br><span class="line">            <span class="attr">token</span>: c.<span class="property">token</span>.<span class="title function_">toString</span>(),</span><br><span class="line">            <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">        &#125;)),</span><br><span class="line">        <span class="attr">totalConstituents</span>: etfInfo.<span class="property">constituent</span>.<span class="property">length</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ“ æ„å»ºå‰©ä½™è´¦æˆ·åˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// åŒ…å«æ‰€æœ‰åº•å±‚ä»£å¸çš„ç”¨æˆ·è´¦æˆ·å’ŒETFæ‰˜ç®¡è´¦æˆ·</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šé¡ºåºå¾ˆé‡è¦ï¼å¿…é¡»ä¸ç¨‹åºä¸­çš„å¤„ç†é¡ºåºä¸€è‡´</span></span><br><span class="line">    <span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment">// ç”¨æˆ·çš„åº•å±‚ä»£å¸æ¥æ”¶è´¦æˆ·ï¼ˆèµå›æ—¶æ¥æ”¶è¿”è¿˜çš„ä»£å¸ï¼‰</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">            <span class="comment">// ETFåˆçº¦çš„åº•å±‚ä»£å¸æ‰˜ç®¡è´¦æˆ·ï¼ˆèµå›æ—¶è½¬å‡ºä»£å¸çš„æºè´¦æˆ·ï¼‰</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">        ]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ“‹ Remaining accounts for redemption:&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">totalAccounts</span>: remainingAccounts.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">accountsPerToken</span>: <span class="number">2</span>, <span class="comment">// æ¯ä¸ªä»£å¸éœ€è¦2ä¸ªè´¦æˆ·ï¼šç”¨æˆ·è´¦æˆ· + ETFæ‰˜ç®¡è´¦æˆ·</span></span><br><span class="line">        <span class="attr">expectedPairs</span>: etfInfo.<span class="property">constituent</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ› ï¸ æ„å»ºETFèµå›æŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">const</span> ix = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">        .<span class="title function_">etfTokenBurn</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(lamports))           <span class="comment">// èµå›æ•°é‡</span></span><br><span class="line">        .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">            <span class="attr">etfTokenMintAccount</span>: etfAddress,      <span class="comment">// ETFä»£å¸mintåœ°å€</span></span><br><span class="line">            <span class="comment">// authorityä¼šè‡ªåŠ¨ä»é’±åŒ…æ¨æ–­ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">remainingAccounts</span>(</span><br><span class="line">            <span class="comment">// æ·»åŠ æ‰€æœ‰åº•å±‚ä»£å¸ç›¸å…³è´¦æˆ·</span></span><br><span class="line">            remainingAccounts.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123; </span><br><span class="line">                <span class="attr">pubkey</span>: item, </span><br><span class="line">                <span class="attr">isWritable</span>: <span class="literal">true</span>,    <span class="comment">// éœ€è¦å†™å…¥æƒé™ï¼ˆè½¬ç§»ä»£å¸ï¼‰</span></span><br><span class="line">                <span class="attr">isSigner</span>: <span class="literal">false</span>      <span class="comment">// ä¸éœ€è¦ç­¾åï¼ˆç”±PDAæˆ–ç”¨æˆ·ç­¾åï¼‰</span></span><br><span class="line">            &#125;)),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">transaction</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš¡ è®¾ç½®è®¡ç®—å•å…ƒé™åˆ¶</span></span><br><span class="line">    <span class="comment">// ETFèµå›æ¶‰åŠå¤šä¸ªä»£å¸è½¬ç§»å’Œä»£å¸é”€æ¯ï¼Œéœ€è¦è¶³å¤Ÿçš„è®¡ç®—èµ„æº</span></span><br><span class="line">    <span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">        <span class="attr">units</span>: <span class="number">400_000</span>,  <span class="comment">// 40ä¸‡è®¡ç®—å•å…ƒï¼Œè¶³å¤Ÿå¤„ç†å¤æ‚çš„å¤šä»£å¸æ“ä½œ</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ“¦ æ„å»ºå¹¶å‘é€æœ€ç»ˆäº¤æ˜“</span></span><br><span class="line">    <span class="keyword">const</span> tx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>().<span class="title function_">add</span>(ix).<span class="title function_">add</span>(modifyComputeUnits);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸš€ Sending ETF redemption transaction...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€äº¤æ˜“å¹¶ç­‰å¾…ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">        provider.<span class="property">connection</span>,</span><br><span class="line">        tx,</span><br><span class="line">        [wallet.<span class="property">payer</span>]  <span class="comment">// äº¤æ˜“ç­¾åè€…</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å®¢æˆ·ç«¯å®ç°è¦ç‚¹</strong>ï¼š</p>
<h3 id="1-è´¦æˆ·é¡ºåºçš„é‡è¦æ€§"><a href="#1-è´¦æˆ·é¡ºåºçš„é‡è¦æ€§" class="headerlink" title="1. è´¦æˆ·é¡ºåºçš„é‡è¦æ€§"></a>1. è´¦æˆ·é¡ºåºçš„é‡è¦æ€§</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…³é”®ï¼šè´¦æˆ·é¡ºåºå¿…é¡»ä¸ç¨‹åºä¸­çš„å¤„ç†é€»è¾‘ä¸€è‡´</span></span><br><span class="line"><span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªï¼šç”¨æˆ·è´¦æˆ·ï¼ˆæ¥æ”¶è¿”è¿˜ä»£å¸ï¼‰</span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªï¼šETFæ‰˜ç®¡è´¦æˆ·ï¼ˆè½¬å‡ºä»£å¸ï¼‰  </span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>ç¨‹åºç«¯å¯¹åº”çš„å¤„ç†</strong>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¨‹åºä¸­çš„è´¦æˆ·æŸ¥æ‰¾é€»è¾‘å¿…é¡»ä¸å®¢æˆ·ç«¯é¡ºåºåŒ¹é…</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">from_ata</span> = accounts.<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">    &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ETFæ‰˜ç®¡è´¦æˆ·</span></span><br><span class="line">    &amp;x.token,</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">to_ata</span> = accounts.<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">    &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),       <span class="comment">// ç”¨æˆ·è´¦æˆ·</span></span><br><span class="line">    &amp;x.token,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<h3 id="2-é”™è¯¯é¢„é˜²æœºåˆ¶"><a href="#2-é”™è¯¯é¢„é˜²æœºåˆ¶" class="headerlink" title="2. é”™è¯¯é¢„é˜²æœºåˆ¶"></a>2. é”™è¯¯é¢„é˜²æœºåˆ¶</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®æ·»åŠ ä½™é¢æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkUserEtfBalance</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">requiredAmount</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; requiredAmount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Insufficient ETF balance. Required: <span class="subst">$&#123;requiredAmount&#125;</span>, Available: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âœ… Sufficient ETF balance: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETF token account not found or insufficient balance: <span class="subst">$&#123;e&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨èµå›å‰è°ƒç”¨æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">checkUserEtfBalance</span>(wallet, etfAddress, lamports);</span><br></pre></td></tr></table></figure>

<h3 id="3-è´¦æˆ·å­˜åœ¨æ€§éªŒè¯"><a href="#3-è´¦æˆ·å­˜åœ¨æ€§éªŒè¯" class="headerlink" title="3. è´¦æˆ·å­˜åœ¨æ€§éªŒè¯"></a>3. è´¦æˆ·å­˜åœ¨æ€§éªŒè¯</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®æ·»åŠ ç”¨æˆ·åº•å±‚ä»£å¸è´¦æˆ·æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ensureUserTokenAccounts</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">constituents</span>: <span class="built_in">any</span>[]</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> setupTx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> constituents) &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»ºç”¨æˆ·çš„åº•å±‚ä»£å¸æ¥æ”¶è´¦æˆ·</span></span><br><span class="line">                setupTx.<span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">createAssociatedTokenAccountInstruction</span>(</span><br><span class="line">                        wallet.<span class="property">payer</span>.<span class="property">publicKey</span>,</span><br><span class="line">                        userAta,</span><br><span class="line">                        wallet.<span class="property">publicKey</span>,</span><br><span class="line">                        token,</span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (setupTx.<span class="property">instructions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">            provider.<span class="property">connection</span>,</span><br><span class="line">            setupTx,</span><br><span class="line">            [wallet.<span class="property">payer</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="æ­¥éª¤4-å®Œæ•´èµå›æµç¨‹ç¤ºä¾‹"><a href="#æ­¥éª¤4-å®Œæ•´èµå›æµç¨‹ç¤ºä¾‹" class="headerlink" title="æ­¥éª¤4: å®Œæ•´èµå›æµç¨‹ç¤ºä¾‹"></a>æ­¥éª¤4: å®Œæ•´èµå›æµç¨‹ç¤ºä¾‹</h2><p><strong>ç›®çš„</strong>ï¼šå±•ç¤ºä»ETFåˆ›å»ºåˆ°èµå›çš„å®Œæ•´ä½¿ç”¨æµç¨‹ã€‚</p>
<p><strong>æ–‡ä»¶ä½ç½®</strong>ï¼š<code>../ibuidl-etf-dapp/anchor/example/index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; deriveEtfTokenMintAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./api/address&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useDefaultWallet, useVisitorWallet &#125; <span class="keyword">from</span> <span class="string">&quot;./api/const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createTokenMintAccount, etfTokenMint, etfTokenBurn &#125; <span class="keyword">from</span> <span class="string">&quot;./api/etf_token&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span>;</span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// ğŸ”‘ åˆå§‹åŒ–é’±åŒ…</span></span><br><span class="line">    <span class="keyword">const</span> defaultWallet = <span class="title function_">useDefaultWallet</span>();  <span class="comment">// ETFç®¡ç†è€…é’±åŒ…</span></span><br><span class="line">    <span class="keyword">const</span> visitorWallet = <span class="title function_">useVisitorWallet</span>();  <span class="comment">// ETFç”¨æˆ·é’±åŒ…</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ“‹ å®šä¹‰ETFå‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> [name, <span class="built_in">symbol</span>, description, url] = [</span><br><span class="line">        <span class="string">&quot;yama4&quot;</span>,                    <span class="comment">// ETFåç§°</span></span><br><span class="line">        <span class="string">&quot;YAMA4&quot;</span>,                   <span class="comment">// ETFç¬¦å·</span></span><br><span class="line">        <span class="string">&quot;yama4 description&quot;</span>,       <span class="comment">// ETFæè¿°</span></span><br><span class="line">        <span class="string">&quot;https://note-public-img.oss-cn-beijing.aliyuncs.com/nya/nya.json&quot;</span>  <span class="comment">// å…ƒæ•°æ®URL</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ—ï¸ ETFåˆ›å»ºç¤ºä¾‹ï¼ˆæ³¨é‡ŠçŠ¶æ€ï¼Œæ¼”ç¤ºç”¨ï¼‰</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ç§åº•å±‚ä»£å¸çš„ETFï¼Œæƒé‡åˆ†åˆ«ä¸º20%å’Œ80%</span></span><br><span class="line">    <span class="comment">// const r1 = await createTokenMintAccount(</span></span><br><span class="line">    <span class="comment">//     defaultWallet,</span></span><br><span class="line">    <span class="comment">//     name,</span></span><br><span class="line">    <span class="comment">//     symbol,</span></span><br><span class="line">    <span class="comment">//     description,</span></span><br><span class="line">    <span class="comment">//     url,</span></span><br><span class="line">    <span class="comment">//     [</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // åº•å±‚ä»£å¸1ï¼šæƒé‡20%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;4NQZAkYZdWZNBYW1JCoDgjZn9So1GaVz7wu3WLRUup7e&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 20,</span></span><br><span class="line">    <span class="comment">//         &#125;,</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // åº•å±‚ä»£å¸2ï¼šæƒé‡80%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;7mVM7bRnnHNVoLUT6HL8pq2NoLBi84dm2JtwSCqdPgLm&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 80,</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     ]</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ¯ è·å–ETFåœ°å€</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç¬¦å·æ´¾ç”ŸETF mintè´¦æˆ·åœ°å€</span></span><br><span class="line">    <span class="keyword">const</span> [etf,] = <span class="title function_">deriveEtfTokenMintAccount</span>(<span class="built_in">symbol</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ·ï¸ ETF Address: <span class="subst">$&#123;etf&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ’° è´­ä¹°ETFä»£å¸ï¼ˆæ³¨é‡ŠçŠ¶æ€ï¼Œæ¼”ç¤ºå®Œæ•´æµç¨‹ï¼‰</span></span><br><span class="line">    <span class="comment">// å…ˆè´­ä¹°600,000,000ä¸ªæœ€å°å•ä½çš„ETFä»£å¸</span></span><br><span class="line">    <span class="comment">// const r2 = await etfTokenMint(</span></span><br><span class="line">    <span class="comment">//     defaultWallet,      // è´­ä¹°è€…é’±åŒ…</span></span><br><span class="line">    <span class="comment">//     etf,               // ETFä»£å¸åœ°å€</span></span><br><span class="line">    <span class="comment">//     600000000          // è´­ä¹°æ•°é‡ï¼ˆlamportsï¼‰</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line">    <span class="comment">// console.log(`âœ… ETF Mint Transaction: $&#123;r2&#125;`);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ”¥ æ‰§è¡ŒETFèµå›</span></span><br><span class="line">    <span class="comment">// èµå›600,000,000ä¸ªæœ€å°å•ä½çš„ETFä»£å¸ï¼Œè·å¾—å¯¹åº”çš„åº•å±‚èµ„äº§</span></span><br><span class="line">    <span class="keyword">const</span> r3 = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(</span><br><span class="line">        defaultWallet,      <span class="comment">// èµå›è€…é’±åŒ…</span></span><br><span class="line">        etf,               <span class="comment">// ETFä»£å¸åœ°å€  </span></span><br><span class="line">        <span class="number">600000000</span>          <span class="comment">// èµå›æ•°é‡ï¼ˆlamportsï¼‰</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ”¥ ETF Burn Transaction: <span class="subst">$&#123;r3&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ“Š äº¤æ˜“å®Œæˆåçš„çŠ¶æ€æ£€æŸ¥å»ºè®®</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ“‹ Transaction completed. Recommended next steps:&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1. Check user&#x27;s bottom token balances&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2. Verify ETF token balance reduction&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3. Confirm ETF total supply decrease&quot;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p><strong>å®Œæ•´æµç¨‹æ—¶é—´çº¿</strong>ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1ï¸âƒ£ åˆ›å»ºETF</span><br><span class="line">   â”œâ”€â”€ å®šä¹‰åº•å±‚ä»£å¸ç»„åˆ (å¦‚: SOL 40%, USDC 60%)</span><br><span class="line">   â”œâ”€â”€ è®¾ç½®ETFå…ƒæ•°æ® (åç§°ã€ç¬¦å·ã€æè¿°)</span><br><span class="line">   â””â”€â”€ éƒ¨ç½²ETFåˆçº¦</span><br><span class="line"></span><br><span class="line">2ï¸âƒ£ è´­ä¹°ETF (ç”¨æˆ·ç§¯ç´¯ETFä»£å¸)</span><br><span class="line">   â”œâ”€â”€ ç”¨æˆ·æä¾›åº•å±‚ä»£å¸ (400 SOL + 600 USDC)</span><br><span class="line">   â”œâ”€â”€ åº•å±‚ä»£å¸è½¬å…¥ETFæ‰˜ç®¡</span><br><span class="line">   â””â”€â”€ ç”¨æˆ·æ”¶åˆ° 1000 ä¸ªETFä»£å¸</span><br><span class="line"></span><br><span class="line">3ï¸âƒ£ èµå›ETF (æœ¬æ•™ç¨‹é‡ç‚¹)</span><br><span class="line">   â”œâ”€â”€ ç”¨æˆ·æäº¤èµå›è¯·æ±‚ (èµå› 500 ä¸ªETFä»£å¸)</span><br><span class="line">   â”œâ”€â”€ ETFåˆçº¦è¿”è¿˜åº•å±‚èµ„äº§ (200 SOL + 300 USDC)</span><br><span class="line">   â””â”€â”€ é”€æ¯å¯¹åº”çš„ETFä»£å¸ (500 ä¸ª)</span><br><span class="line"></span><br><span class="line">4ï¸âƒ£ ç»“æœéªŒè¯</span><br><span class="line">   â”œâ”€â”€ ç”¨æˆ·ä½™é¢: 500 ä¸ªETF + 200 SOL + 300 USDC  </span><br><span class="line">   â”œâ”€â”€ ETFæ‰˜ç®¡ä½™é¢: 200 SOL + 300 USDC</span><br><span class="line">   â””â”€â”€ ETFæ€»ä¾›åº”é‡: å‡å°‘ 500 ä¸ª</span><br></pre></td></tr></table></figure>

<h2 id="æŠ€æœ¯æ·±åº¦è§£æ"><a href="#æŠ€æœ¯æ·±åº¦è§£æ" class="headerlink" title="æŠ€æœ¯æ·±åº¦è§£æ"></a>æŠ€æœ¯æ·±åº¦è§£æ</h2><h3 id="1-èµå›æ“ä½œçš„åŸå­æ€§ä¿éšœ"><a href="#1-èµå›æ“ä½œçš„åŸå­æ€§ä¿éšœ" class="headerlink" title="1. èµå›æ“ä½œçš„åŸå­æ€§ä¿éšœ"></a>1. èµå›æ“ä½œçš„åŸå­æ€§ä¿éšœ</h3><h4 id="A-äº‹åŠ¡å®Œæ•´æ€§"><a href="#A-äº‹åŠ¡å®Œæ•´æ€§" class="headerlink" title="A. äº‹åŠ¡å®Œæ•´æ€§"></a>A. äº‹åŠ¡å®Œæ•´æ€§</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰€æœ‰æ“ä½œåœ¨å•ä¸€äº‹åŠ¡ä¸­å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">    <span class="comment">// è½¬ç§»åº•å±‚èµ„äº§ç»™ç”¨æˆ·</span></span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// å¦‚æœä»»ä½•ä¸€ä¸ªè½¬ç§»å¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é”€æ¯ETFä»£å¸</span></span><br><span class="line"><span class="title function_ invoke__">burn</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// å¦‚æœé”€æ¯å¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š</span></span><br></pre></td></tr></table></figure>

<h4 id="B-çŠ¶æ€ä¸€è‡´æ€§"><a href="#B-çŠ¶æ€ä¸€è‡´æ€§" class="headerlink" title="B. çŠ¶æ€ä¸€è‡´æ€§"></a>B. çŠ¶æ€ä¸€è‡´æ€§</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æˆåŠŸåœºæ™¯ï¼š</span><br><span class="line">- æ‰€æœ‰åº•å±‚èµ„äº§éƒ½æˆåŠŸè½¬ç§»ç»™ç”¨æˆ· âœ“</span><br><span class="line">- ETFä»£å¸æˆåŠŸé”€æ¯ âœ“</span><br><span class="line">- ETFæ€»ä¾›åº”é‡æ­£ç¡®å‡å°‘ âœ“</span><br><span class="line"></span><br><span class="line">å¤±è´¥åœºæ™¯ï¼š</span><br><span class="line">- ä»»ä½•åº•å±‚èµ„äº§è½¬ç§»å¤±è´¥ â†’ æ•´ä¸ªäº¤æ˜“å›æ»š âœ“</span><br><span class="line">- ETFä»£å¸é”€æ¯å¤±è´¥ â†’ æ•´ä¸ªäº¤æ˜“å›æ»š âœ“</span><br><span class="line">- ç”¨æˆ·ä¸ä¼šæŸå¤±ä»»ä½•èµ„äº§ âœ“</span><br></pre></td></tr></table></figure>

<h3 id="2-æƒé™éªŒè¯æœºåˆ¶æ·±åº¦åˆ†æ"><a href="#2-æƒé™éªŒè¯æœºåˆ¶æ·±åº¦åˆ†æ" class="headerlink" title="2. æƒé™éªŒè¯æœºåˆ¶æ·±åº¦åˆ†æ"></a>2. æƒé™éªŒè¯æœºåˆ¶æ·±åº¦åˆ†æ</h3><h4 id="A-PDAæƒé™æ§åˆ¶"><a href="#A-PDAæƒé™æ§åˆ¶" class="headerlink" title="A. PDAæƒé™æ§åˆ¶"></a>A. PDAæƒé™æ§åˆ¶</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETFåˆçº¦é€šè¿‡PDAæ§åˆ¶æ‰˜ç®¡èµ„äº§</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">    EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// ç±»å‹æ ‡è¯†</span></span><br><span class="line">    m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// ETFç‰¹å®šæ ‡è¯†</span></span><br><span class="line">    &amp;[ctx.bumps.etf_token_info],        <span class="comment">// å”¯ä¸€æ€§ä¿è¯</span></span><br><span class="line">]];</span><br></pre></td></tr></table></figure>

<p><strong>å®‰å…¨æ€§ä¿éšœ</strong>ï¼š</p>
<ul>
<li>åªæœ‰æ­£ç¡®çš„ETFç¨‹åºå®ä¾‹æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆçš„PDAç­¾å</li>
<li>é˜²æ­¢æ¶æ„ç¨‹åºç›—å–æ‰˜ç®¡èµ„äº§</li>
<li>ç¡®ä¿æ¯ä¸ªETFçš„èµ„äº§éš”ç¦»</li>
</ul>
<h4 id="B-ç”¨æˆ·æƒé™éªŒè¯"><a href="#B-ç”¨æˆ·æƒé™éªŒè¯" class="headerlink" title="B. ç”¨æˆ·æƒé™éªŒè¯"></a>B. ç”¨æˆ·æƒé™éªŒè¯</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æˆ·å¿…é¡»æ‹¥æœ‰è¶³å¤Ÿçš„ETFä»£å¸æ‰èƒ½èµå›</span></span><br><span class="line">Burn &#123;</span><br><span class="line">    from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// ç”¨æˆ·çš„ETFè´¦æˆ·</span></span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// ç”¨æˆ·ç­¾å</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>éªŒè¯å±‚æ¬¡</strong>ï¼š</p>
<ol>
<li><strong>ç­¾åéªŒè¯</strong>ï¼šç¡®è®¤æ˜¯ä»£å¸æ‰€æœ‰è€…å‘èµ·çš„æ“ä½œ</li>
<li><strong>ä½™é¢éªŒè¯</strong>ï¼šSPL Tokenè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿä½™é¢</li>
<li><strong>è´¦æˆ·éªŒè¯</strong>ï¼šç¡®è®¤æ“ä½œçš„æ˜¯æ­£ç¡®çš„ä»£å¸è´¦æˆ·</li>
</ol>
<h3 id="3-æ•°é‡è®¡ç®—çš„ç²¾ç¡®æ€§"><a href="#3-æ•°é‡è®¡ç®—çš„ç²¾ç¡®æ€§" class="headerlink" title="3. æ•°é‡è®¡ç®—çš„ç²¾ç¡®æ€§"></a>3. æ•°é‡è®¡ç®—çš„ç²¾ç¡®æ€§</h3><h4 id="A-æƒé‡è®¡ç®—å…¬å¼"><a href="#A-æƒé‡è®¡ç®—å…¬å¼" class="headerlink" title="A. æƒé‡è®¡ç®—å…¬å¼"></a>A. æƒé‡è®¡ç®—å…¬å¼</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h4 id="B-ç²¾åº¦å¤„ç†è€ƒè™‘"><a href="#B-ç²¾åº¦å¤„ç†è€ƒè™‘" class="headerlink" title="B. ç²¾åº¦å¤„ç†è€ƒè™‘"></a>B. ç²¾åº¦å¤„ç†è€ƒè™‘</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">æ½œåœ¨é—®é¢˜ï¼šæ•´æ•°é™¤æ³•å¯èƒ½å¯¼è‡´ç²¾åº¦ä¸¢å¤±</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹ï¼š</span><br><span class="line">- ç”¨æˆ·èµå› 1000 ä¸ªETFä»£å¸  </span><br><span class="line">- æŸä»£å¸æƒé‡ 33%</span><br><span class="line">- è®¡ç®—: 33 * 1000 / 100 = 330 âœ“</span><br><span class="line"></span><br><span class="line">è¾¹ç•Œæƒ…å†µï¼š</span><br><span class="line">- ç”¨æˆ·èµå› 100 ä¸ªETFä»£å¸</span><br><span class="line">- æŸä»£å¸æƒé‡ 33%  </span><br><span class="line">- è®¡ç®—: 33 * 100 / 100 = 33 âœ“</span><br><span class="line"></span><br><span class="line">æç«¯æƒ…å†µï¼š</span><br><span class="line">- ç”¨æˆ·èµå› 10 ä¸ªETFä»£å¸</span><br><span class="line">- æŸä»£å¸æƒé‡ 33%</span><br><span class="line">- è®¡ç®—: 33 * 10 / 100 = 3.3 â†’ 3 (ç²¾åº¦ä¸¢å¤±)</span><br></pre></td></tr></table></figure>

<h4 id="C-ç²¾åº¦ä¼˜åŒ–å»ºè®®"><a href="#C-ç²¾åº¦ä¼˜åŒ–å»ºè®®" class="headerlink" title="C. ç²¾åº¦ä¼˜åŒ–å»ºè®®"></a>C. ç²¾åº¦ä¼˜åŒ–å»ºè®®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„è®¡ç®—</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redeem_amount</span>(weight: <span class="type">u32</span>, lamports: <span class="type">u64</span>, precision: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ›´å¤§çš„ç²¾åº¦åŸºæ•°ï¼Œå¦‚10000è€Œä¸æ˜¯100</span></span><br><span class="line">    weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / precision</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šæƒé‡3300è¡¨ç¤º33%ï¼ŒåŸºæ•°10000</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">amount</span> = <span class="title function_ invoke__">calculate_redeem_amount</span>(<span class="number">3300</span>, lamports, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-é”™è¯¯å¤„ç†æœºåˆ¶"><a href="#4-é”™è¯¯å¤„ç†æœºåˆ¶" class="headerlink" title="4. é”™è¯¯å¤„ç†æœºåˆ¶"></a>4. é”™è¯¯å¤„ç†æœºåˆ¶</h3><h4 id="A-å¸¸è§é”™è¯¯ç±»å‹"><a href="#A-å¸¸è§é”™è¯¯ç±»å‹" class="headerlink" title="A. å¸¸è§é”™è¯¯ç±»å‹"></a>A. å¸¸è§é”™è¯¯ç±»å‹</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è´¦æˆ·ç›¸å…³é”™è¯¯</span></span><br><span class="line">TokenMintError::InvalidAccounts    <span class="comment">// è´¦æˆ·åœ°å€ä¸åŒ¹é…æˆ–ä¸¢å¤±</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä½™é¢ç›¸å…³é”™è¯¯ï¼ˆSPL Tokenè‡ªåŠ¨æ£€æŸ¥ï¼‰</span></span><br><span class="line"><span class="comment">// - InsufficientBalance: ETFä»£å¸ä½™é¢ä¸è¶³</span></span><br><span class="line"><span class="comment">// - InsufficientFunds: æ‰˜ç®¡è´¦æˆ·åº•å±‚èµ„äº§ä¸è¶³</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æƒé™ç›¸å…³é”™è¯¯ï¼ˆAnchorè‡ªåŠ¨æ£€æŸ¥ï¼‰</span></span><br><span class="line"><span class="comment">// - Unauthorized: ç­¾åéªŒè¯å¤±è´¥</span></span><br><span class="line"><span class="comment">// - ConstraintRaw: è´¦æˆ·çº¦æŸéªŒè¯å¤±è´¥</span></span><br></pre></td></tr></table></figure>

<h4 id="B-é”™è¯¯æ¢å¤ç­–ç•¥"><a href="#B-é”™è¯¯æ¢å¤ç­–ç•¥" class="headerlink" title="B. é”™è¯¯æ¢å¤ç­–ç•¥"></a>B. é”™è¯¯æ¢å¤ç­–ç•¥</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®¢æˆ·ç«¯é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurnWithRetry</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">maxRetries</span>: <span class="built_in">number</span> = <span class="number">3</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> attempt = <span class="number">1</span>; attempt &lt;= maxRetries; attempt++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âŒ Attempt <span class="subst">$&#123;attempt&#125;</span> failed:`</span>, error.<span class="property">message</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;TokenAccountNotFoundError&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»ºç¼ºå¤±çš„ç”¨æˆ·ä»£å¸æ¥æ”¶è´¦æˆ·</span></span><br><span class="line">                <span class="keyword">await</span> <span class="title function_">ensureUserTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// é‡è¯•</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;InsufficientBalance&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ç”¨æˆ·ETFä½™é¢ä¸è¶³ï¼Œæ— æ³•èµå›<span class="subst">$&#123;lamports&#125;</span>ä¸ªä»£å¸`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (attempt === maxRetries) &#123;</span><br><span class="line">                <span class="keyword">throw</span> error; <span class="comment">// æœ€åä¸€æ¬¡å°è¯•å¤±è´¥ï¼ŒæŠ›å‡ºåŸå§‹é”™è¯¯</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•</span></span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span> * attempt));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><h4 id="A-æ‰¹é‡æ“ä½œä¼˜åŒ–"><a href="#A-æ‰¹é‡æ“ä½œä¼˜åŒ–" class="headerlink" title="A. æ‰¹é‡æ“ä½œä¼˜åŒ–"></a>A. æ‰¹é‡æ“ä½œä¼˜åŒ–</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰å®ç°ï¼šé€ä¸ªå¤„ç†æ¯ä¸ªåº•å±‚ä»£å¸</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// æ¯ä¸ªä»£å¸ä¸€ä¸ªCPIè°ƒç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–å»ºè®®ï¼šè€ƒè™‘æ‰¹é‡è½¬ç§»ï¼ˆéœ€è¦è‡ªå®šä¹‰å®ç°ï¼‰</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">batch_transfer_constituent_tokens</span>(</span><br><span class="line">    ctx: &amp;Context&lt;EtfTokenTransaction&gt;,</span><br><span class="line">    amounts: &amp;[<span class="type">u64</span>],</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// æ‰¹é‡å¤„ç†å¤šä¸ªè½¬ç§»æ“ä½œï¼Œå‡å°‘CPIè°ƒç”¨å¼€é”€</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-è®¡ç®—å•å…ƒåŠ¨æ€è°ƒæ•´"><a href="#B-è®¡ç®—å•å…ƒåŠ¨æ€è°ƒæ•´" class="headerlink" title="B. è®¡ç®—å•å…ƒåŠ¨æ€è°ƒæ•´"></a>B. è®¡ç®—å•å…ƒåŠ¨æ€è°ƒæ•´</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®ETFå¤æ‚åº¦åŠ¨æ€è®¡ç®—æ‰€éœ€è®¡ç®—å•å…ƒ</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">calculateComputeUnits</span> = (<span class="params"><span class="attr">constituentCount</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseUnits = <span class="number">150_000</span>;        <span class="comment">// åŸºç¡€æ“ä½œå•å…ƒ</span></span><br><span class="line">    <span class="keyword">const</span> perTokenUnits = <span class="number">50_000</span>;     <span class="comment">// æ¯ä¸ªåº•å±‚ä»£å¸çš„é¢å¤–å•å…ƒ</span></span><br><span class="line">    <span class="keyword">const</span> burnUnits = <span class="number">25_000</span>;         <span class="comment">// ä»£å¸é”€æ¯æ“ä½œå•å…ƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(</span><br><span class="line">        <span class="number">1_400_000</span>,  <span class="comment">// Solanaæœ€å¤§é™åˆ¶</span></span><br><span class="line">        baseUnits + (constituentCount * perTokenUnits) + burnUnits</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„è®¡ç®—å•å…ƒ</span></span><br><span class="line"><span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line"><span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">    <span class="attr">units</span>: computeUnits,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="C-è´¦æˆ·é¢„å–ä¼˜åŒ–"><a href="#C-è´¦æˆ·é¢„å–ä¼˜åŒ–" class="headerlink" title="C. è´¦æˆ·é¢„å–ä¼˜åŒ–"></a>C. è´¦æˆ·é¢„å–ä¼˜åŒ–</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¢„å–æ‰€æœ‰ç›¸å…³è´¦æˆ·ä¿¡æ¯ï¼Œå‡å°‘RPCè°ƒç”¨</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">preloadAccountInfo</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">addresses</span>: <span class="title class_">PublicKey</span>[]</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> accountInfos = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getMultipleAccountsInfo</span>(addresses);</span><br><span class="line">    <span class="keyword">return</span> addresses.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, addr, index</span>) =&gt;</span> &#123;</span><br><span class="line">        acc[addr.<span class="title function_">toString</span>()] = accountInfos[index];</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;, &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">AccountInfo</span>&lt;<span class="title class_">Buffer</span>&gt; | <span class="literal">null</span>&gt;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="å®‰å…¨æ€§è€ƒè™‘ä¸æœ€ä½³å®è·µ"><a href="#å®‰å…¨æ€§è€ƒè™‘ä¸æœ€ä½³å®è·µ" class="headerlink" title="å®‰å…¨æ€§è€ƒè™‘ä¸æœ€ä½³å®è·µ"></a>å®‰å…¨æ€§è€ƒè™‘ä¸æœ€ä½³å®è·µ</h2><h3 id="1-é‡å…¥æ”»å‡»é˜²æŠ¤"><a href="#1-é‡å…¥æ”»å‡»é˜²æŠ¤" class="headerlink" title="1. é‡å…¥æ”»å‡»é˜²æŠ¤"></a>1. é‡å…¥æ”»å‡»é˜²æŠ¤</h3><h4 id="A-çŠ¶æ€æ£€æŸ¥é¡ºåº"><a href="#A-çŠ¶æ€æ£€æŸ¥é¡ºåº" class="headerlink" title="A. çŠ¶æ€æ£€æŸ¥é¡ºåº"></a>A. çŠ¶æ€æ£€æŸ¥é¡ºåº</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ç¡®çš„æ“ä½œé¡ºåºï¼šå…ˆæ£€æŸ¥ï¼Œåä¿®æ”¹çŠ¶æ€</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_secure</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. é¢„å…ˆéªŒè¯æ‰€æœ‰æ¡ä»¶</span></span><br><span class="line">    require!(lamports &gt; <span class="number">0</span>, TokenMintError::InvalidAmount);</span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">len</span>() &gt; <span class="number">0</span>,</span><br><span class="line">        TokenMintError::EmptyConstituent</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ‰§è¡Œæ‰€æœ‰è½¬ç§»æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æœ€åé”€æ¯ETFä»£å¸ï¼ˆä¸å¯é€†æ“ä½œï¼‰</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(<span class="comment">/* ... */</span>)?;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥"><a href="#B-çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥" class="headerlink" title="B. çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥"></a>B. çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®æ·»åŠ çš„çŠ¶æ€éªŒè¯</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_state</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// éªŒè¯æƒé‡æ€»å’Œ</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">total_weight</span>: <span class="type">u32</span> = <span class="keyword">self</span>.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|c| c.weight).<span class="title function_ invoke__">sum</span>();</span><br><span class="line">        require!(total_weight == <span class="number">100</span>, TokenMintError::InvalidWeightSum);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éªŒè¯æ²¡æœ‰é‡å¤çš„ä»£å¸</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">seen_tokens</span> = std::collections::HashSet::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.constituent &#123;</span><br><span class="line">            require!(</span><br><span class="line">                seen_tokens.<span class="title function_ invoke__">insert</span>(constituent.token),</span><br><span class="line">                TokenMintError::DuplicateToken</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-ä»·æ ¼æ“çºµé˜²æŠ¤"><a href="#2-ä»·æ ¼æ“çºµé˜²æŠ¤" class="headerlink" title="2. ä»·æ ¼æ“çºµé˜²æŠ¤"></a>2. ä»·æ ¼æ“çºµé˜²æŠ¤</h3><h4 id="A-èµå›é™åˆ¶æœºåˆ¶"><a href="#A-èµå›é™åˆ¶æœºåˆ¶" class="headerlink" title="A. èµå›é™åˆ¶æœºåˆ¶"></a>A. èµå›é™åˆ¶æœºåˆ¶</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®æ·»åŠ çš„èµå›é™åˆ¶</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfRedemptionLimits</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> min_redemption: <span class="type">u64</span>,        <span class="comment">// æœ€å°èµå›é‡</span></span><br><span class="line">    <span class="keyword">pub</span> max_redemption_per_tx: <span class="type">u64</span>, <span class="comment">// å•æ¬¡æœ€å¤§èµå›é‡</span></span><br><span class="line">    <span class="keyword">pub</span> daily_redemption_limit: <span class="type">u64</span>,<span class="comment">// æ—¥èµå›é™åˆ¶</span></span><br><span class="line">    <span class="keyword">pub</span> redemption_fee_bps: <span class="type">u16</span>,    <span class="comment">// èµå›è´¹ç”¨ï¼ˆåŸºç‚¹ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_limits</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    limits: &amp;EtfRedemptionLimits,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// éªŒè¯èµå›é™åˆ¶</span></span><br><span class="line">    require!(lamports &gt;= limits.min_redemption, TokenMintError::BelowMinRedemption);</span><br><span class="line">    require!(lamports &lt;= limits.max_redemption_per_tx, TokenMintError::ExceedsMaxRedemption);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶æ”¶å–èµå›è´¹ç”¨</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = lamports * limits.redemption_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">net_redemption</span> = lamports - fee;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œèµå›é€»è¾‘</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, net_redemption)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-ä»·æ ¼éªŒè¯æœºåˆ¶"><a href="#B-ä»·æ ¼éªŒè¯æœºåˆ¶" class="headerlink" title="B. ä»·æ ¼éªŒè¯æœºåˆ¶"></a>B. ä»·æ ¼éªŒè¯æœºåˆ¶</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é›†æˆä»·æ ¼é¢„è¨€æœºéªŒè¯</span></span><br><span class="line"><span class="keyword">use</span> pyth_solana_receiver_sdk::price_update::PriceUpdateV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_price_check</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithOracle&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    max_price_deviation_bps: <span class="type">u16</span>, <span class="comment">// æœ€å¤§ä»·æ ¼åå·®</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// éªŒè¯åº•å±‚èµ„äº§ä»·æ ¼çš„åˆç†æ€§</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total_value</span> = <span class="number">0u64</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i, constituent) <span class="keyword">in</span> ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="comment">// è·å–ä»·æ ¼æ•°æ®</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_feed</span> = &amp;ctx.remaining_accounts[i];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_update</span> = PriceUpdateV2::<span class="title function_ invoke__">try_deserialize</span>(&amp;<span class="keyword">mut</span> price_feed.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—è¯¥ä»£å¸çš„ä»·å€¼</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">token_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">token_value</span> = token_amount * price_update.price <span class="keyword">as</span> <span class="type">u64</span>;</span><br><span class="line">        total_value += token_value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éªŒè¯æ€»ä»·å€¼ä¸ETFä»·æ ¼çš„ä¸€è‡´æ€§</span></span><br><span class="line">    <span class="comment">// å®é™…å®ç°éœ€è¦ETFæœ¬èº«çš„ä»·æ ¼æ•°æ®</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ ‡å‡†èµå›æµç¨‹</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">into</span>(), lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-æµåŠ¨æ€§é£é™©ç®¡ç†"><a href="#3-æµåŠ¨æ€§é£é™©ç®¡ç†" class="headerlink" title="3. æµåŠ¨æ€§é£é™©ç®¡ç†"></a>3. æµåŠ¨æ€§é£é™©ç®¡ç†</h3><h4 id="A-æ‰˜ç®¡èµ„äº§å……è¶³æ€§æ£€æŸ¥"><a href="#A-æ‰˜ç®¡èµ„äº§å……è¶³æ€§æ£€æŸ¥" class="headerlink" title="A. æ‰˜ç®¡èµ„äº§å……è¶³æ€§æ£€æŸ¥"></a>A. æ‰˜ç®¡èµ„äº§å……è¶³æ€§æ£€æŸ¥</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨èµå›å‰éªŒè¯æ‰˜ç®¡èµ„äº§æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_custody_balances</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: &amp;Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">required_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–ETFæ‰˜ç®¡è´¦æˆ·ä½™é¢</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">custody_ata</span> = <span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">            &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">            &amp;constituent.token,</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦å®é™…è·å–è´¦æˆ·ä½™é¢è¿›è¡ŒéªŒè¯</span></span><br><span class="line">        <span class="comment">// let custody_balance = get_account_balance(custody_ata)?;</span></span><br><span class="line">        <span class="comment">// require!(custody_balance &gt;= required_amount, TokenMintError::InsufficientCustodyBalance);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-ç´§æ€¥æš‚åœæœºåˆ¶"><a href="#B-ç´§æ€¥æš‚åœæœºåˆ¶" class="headerlink" title="B. ç´§æ€¥æš‚åœæœºåˆ¶"></a>B. ç´§æ€¥æš‚åœæœºåˆ¶</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETFçŠ¶æ€ç®¡ç†</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> mint_account: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> constituent: <span class="type">Vec</span>&lt;EtfTokenConstituent&gt;,</span><br><span class="line">    <span class="keyword">pub</span> is_paused: <span class="type">bool</span>,           <span class="comment">// ç´§æ€¥æš‚åœæ ‡å¿—</span></span><br><span class="line">    <span class="keyword">pub</span> emergency_admin: Pubkey,   <span class="comment">// ç´§æ€¥ç®¡ç†å‘˜</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç´§æ€¥æš‚åœèµå›</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">emergency_pause_redemption</span>(</span><br><span class="line">    ctx: Context&lt;EmergencyPause&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">key</span>() == ctx.accounts.etf_token_info.emergency_admin,</span><br><span class="line">        TokenMintError::UnauthorizedEmergencyAction</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.etf_token_info.is_paused = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    msg!(<span class="string">&quot;ğŸš¨ ETF redemption has been emergency paused&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨èµå›å‡½æ•°ä¸­æ£€æŸ¥æš‚åœçŠ¶æ€</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_pause_check</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    require!(!ctx.accounts.etf_token_info.is_paused, TokenMintError::RedemptionPaused);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ‰©å±•åŠŸèƒ½å»ºè®®"><a href="#æ‰©å±•åŠŸèƒ½å»ºè®®" class="headerlink" title="æ‰©å±•åŠŸèƒ½å»ºè®®"></a>æ‰©å±•åŠŸèƒ½å»ºè®®</h2><h3 id="1-éƒ¨åˆ†èµå›ä¸å®Œæ•´èµå›"><a href="#1-éƒ¨åˆ†èµå›ä¸å®Œæ•´èµå›" class="headerlink" title="1. éƒ¨åˆ†èµå›ä¸å®Œæ•´èµå›"></a>1. éƒ¨åˆ†èµå›ä¸å®Œæ•´èµå›</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†èµå›ï¼šç”¨æˆ·æŒ‡å®šèµå›æ•°é‡</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">partial_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// éƒ¨åˆ†èµå›æ•°é‡</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// æŒ‰æ¯”ä¾‹è¿”è¿˜åº•å±‚èµ„äº§</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæ•´èµå›ï¼šèµå›ç”¨æˆ·æŒæœ‰çš„æ‰€æœ‰ETFä»£å¸</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">full_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·çš„ETFä»£å¸ä½™é¢</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_balance</span> = ctx.accounts.etf_token_ata.amount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èµå›å…¨éƒ¨ä½™é¢</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, user_balance)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-å»¶è¿Ÿèµå›æœºåˆ¶"><a href="#2-å»¶è¿Ÿèµå›æœºåˆ¶" class="headerlink" title="2. å»¶è¿Ÿèµå›æœºåˆ¶"></a>2. å»¶è¿Ÿèµå›æœºåˆ¶</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»¶è¿Ÿèµå›çŠ¶æ€</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PendingRedemption</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> request_time: <span class="type">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> execution_time: <span class="type">i64</span>,  <span class="comment">// é¢„è®¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="keyword">pub</span> is_executed: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤èµå›è¯·æ±‚</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">request_redemption</span>(</span><br><span class="line">    ctx: Context&lt;RequestRedemption&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    delay_seconds: <span class="type">i64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_time</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.pending_redemption.<span class="title function_ invoke__">set_inner</span>(PendingRedemption &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount: lamports,</span><br><span class="line">        request_time: current_time,</span><br><span class="line">        execution_time: current_time + delay_seconds,</span><br><span class="line">        is_executed: <span class="literal">false</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    msg!(<span class="string">&quot;ğŸ“‹ Redemption request submitted, will execute at: &#123;&#125;&quot;</span>, current_time + delay_seconds);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå»¶è¿Ÿèµå›</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">execute_pending_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_time</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pending</span> = &amp;ctx.accounts.pending_redemption;</span><br><span class="line">    </span><br><span class="line">    require!(!pending.is_executed, TokenMintError::AlreadyExecuted);</span><br><span class="line">    require!(current_time &gt;= pending.execution_time, TokenMintError::TooEarly);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œèµå›</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, pending.amount)?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‡è®°ä¸ºå·²æ‰§è¡Œ</span></span><br><span class="line">    ctx.accounts.pending_redemption.is_executed = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-èµå›è´¹ç”¨æœºåˆ¶"><a href="#3-èµå›è´¹ç”¨æœºåˆ¶" class="headerlink" title="3. èµå›è´¹ç”¨æœºåˆ¶"></a>3. èµå›è´¹ç”¨æœºåˆ¶</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è´¹ç”¨è®¡ç®—å’Œæ”¶å–</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_fees</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithFees&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    fee_recipient: Pubkey,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee_bps</span> = <span class="number">50</span>; <span class="comment">// 0.5% èµå›è´¹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee_amount</span> = lamports * fee_bps / <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">net_amount</span> = lamports - fee_amount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ”¶å–è´¹ç”¨ï¼šå°†è´¹ç”¨å¯¹åº”çš„ETFä»£å¸è½¬ç»™è´¹ç”¨æ¥æ”¶è€…</span></span><br><span class="line">    <span class="keyword">if</span> fee_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    to: ctx.accounts.fee_recipient_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                &#125;,</span><br><span class="line">            ),</span><br><span class="line">            fee_amount,</span><br><span class="line">        )?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå‡€é¢èµå›</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">into</span>(), net_amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-èµå›å†å²è®°å½•"><a href="#4-èµå›å†å²è®°å½•" class="headerlink" title="4. èµå›å†å²è®°å½•"></a>4. èµå›å†å²è®°å½•</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµå›è®°å½•ç»“æ„</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RedemptionHistory</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_burned: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> underlying_assets: <span class="type">Vec</span>&lt;AssetRedemption&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(AnchorSerialize, AnchorDeserialize, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">AssetRedemption</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> token_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_received: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> weight_at_redemption: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•èµå›å†å²</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_history</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithHistory&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ ‡å‡†èµå›</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">clone</span>().<span class="title function_ invoke__">into</span>(), lamports)?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•èµå›å†å²</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">underlying_assets</span>: <span class="type">Vec</span>&lt;AssetRedemption&gt; = ctx.accounts.etf_token_info.constituent</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|c| AssetRedemption &#123;</span><br><span class="line">            token_mint: c.token,</span><br><span class="line">            amount_received: c.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>,</span><br><span class="line">            weight_at_redemption: c.weight,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.redemption_history.<span class="title function_ invoke__">set_inner</span>(RedemptionHistory &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount_burned: lamports,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">        underlying_assets,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ•…éšœæ’é™¤æŒ‡å—"><a href="#æ•…éšœæ’é™¤æŒ‡å—" class="headerlink" title="æ•…éšœæ’é™¤æŒ‡å—"></a>æ•…éšœæ’é™¤æŒ‡å—</h2><h3 id="1-å¸¸è§é”™è¯¯åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ"><a href="#1-å¸¸è§é”™è¯¯åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="1. å¸¸è§é”™è¯¯åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ"></a>1. å¸¸è§é”™è¯¯åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ</h3><h4 id="A-â€œInvalidAccountsâ€-é”™è¯¯"><a href="#A-â€œInvalidAccountsâ€-é”™è¯¯" class="headerlink" title="A. â€œInvalidAccountsâ€ é”™è¯¯"></a>A. â€œInvalidAccountsâ€ é”™è¯¯</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šå‰©ä½™è´¦æˆ·é¡ºåºæˆ–åœ°å€ä¸åŒ¹é…</span></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">debugAccountOrder</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">etfInfo</span>: <span class="built_in">any</span>, <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>, <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ” è°ƒè¯•è´¦æˆ·é¡ºåº:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    etfInfo.<span class="property">constituent</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ä»£å¸ <span class="subst">$&#123;index + <span class="number">1</span>&#125;</span> (<span class="subst">$&#123;item.token&#125;</span>):`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  ç”¨æˆ·ATA: <span class="subst">$&#123;userAta&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  ETFæ‰˜ç®¡ATA: <span class="subst">$&#123;etfAta&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  æƒé‡: <span class="subst">$&#123;item.weight&#125;</span>%`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿è´¦æˆ·é¡ºåºä¸ç¨‹åºæœŸæœ›ä¸€è‡´</span></span><br><span class="line"><span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),      <span class="comment">// ç”¨æˆ·è´¦æˆ·</span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),  <span class="comment">// ETFæ‰˜ç®¡è´¦æˆ·</span></span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="B-â€œInsufficientBalanceâ€-é”™è¯¯"><a href="#B-â€œInsufficientBalanceâ€-é”™è¯¯" class="headerlink" title="B. â€œInsufficientBalanceâ€ é”™è¯¯"></a>B. â€œInsufficientBalanceâ€ é”™è¯¯</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜1ï¼šç”¨æˆ·ETFä»£å¸ä½™é¢ä¸è¶³</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkEtfBalance</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>, <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>, <span class="attr">required</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ“Š ç”¨æˆ·ETFä½™é¢: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ“Š éœ€è¦èµå›: <span class="subst">$&#123;required&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; required) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETFä½™é¢ä¸è¶³ï¼éœ€è¦: <span class="subst">$&#123;required&#125;</span>, å¯ç”¨: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;âŒ è·å–ETFä½™é¢å¤±è´¥:&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;ETFä»£å¸è´¦æˆ·ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é—®é¢˜2ï¼šETFæ‰˜ç®¡è´¦æˆ·åº•å±‚èµ„äº§ä¸è¶³</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkCustodyBalances</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">etfInfo</span>: <span class="built_in">any</span>, <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span>, <span class="attr">redeemAmount</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ” æ£€æŸ¥ETFæ‰˜ç®¡è´¦æˆ·ä½™é¢:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> constituent <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(constituent.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> requiredAmount = constituent.<span class="property">weight</span> * redeemAmount / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ä»£å¸ <span class="subst">$&#123;constituent.token&#125;</span>:`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  æ‰˜ç®¡ä½™é¢: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  éœ€è¦è½¬å‡º: <span class="subst">$&#123;requiredAmount&#125;</span>`</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; requiredAmount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETFæ‰˜ç®¡èµ„äº§ä¸è¶³ï¼ä»£å¸: <span class="subst">$&#123;constituent.token&#125;</span>, éœ€è¦: <span class="subst">$&#123;requiredAmount&#125;</span>, å¯ç”¨: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`âŒ æ£€æŸ¥æ‰˜ç®¡ä½™é¢å¤±è´¥ (<span class="subst">$&#123;constituent.token&#125;</span>):`</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="C-â€œTokenAccountNotFoundErrorâ€-é”™è¯¯"><a href="#C-â€œTokenAccountNotFoundErrorâ€-é”™è¯¯" class="headerlink" title="C. â€œTokenAccountNotFoundErrorâ€ é”™è¯¯"></a>C. â€œTokenAccountNotFoundErrorâ€ é”™è¯¯</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šç”¨æˆ·ç¼ºå°‘åº•å±‚ä»£å¸æ¥æ”¶è´¦æˆ·</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šè‡ªåŠ¨åˆ›å»ºç¼ºå¤±è´¦æˆ·</span></span><br><span class="line"><span class="keyword">const</span> createMissingTokenAccounts = <span class="title function_">async</span> (</span><br><span class="line">    <span class="attr">wallet</span>: anchor.<span class="property">Wallet</span>, </span><br><span class="line">    <span class="attr">constituents</span>: <span class="built_in">any</span>[]</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span> | <span class="literal">null</span>&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> setupTx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>();</span><br><span class="line">    <span class="keyword">let</span> needsSetup = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> constituents) &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âœ… ç”¨æˆ·ä»£å¸è´¦æˆ·å·²å­˜åœ¨: <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ—ï¸ éœ€è¦åˆ›å»ºä»£å¸è´¦æˆ·: <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">                setupTx.<span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">createAssociatedTokenAccountInstruction</span>(</span><br><span class="line">                        wallet.<span class="property">payer</span>.<span class="property">publicKey</span>,  <span class="comment">// ä»˜è´¹è€…</span></span><br><span class="line">                        userAta,                 <span class="comment">// è¦åˆ›å»ºçš„è´¦æˆ·</span></span><br><span class="line">                        wallet.<span class="property">publicKey</span>,        <span class="comment">// è´¦æˆ·æ‰€æœ‰è€…</span></span><br><span class="line">                        token,                   <span class="comment">// ä»£å¸mint</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">                needsSetup = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (needsSetup) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸš€ å‘é€è´¦æˆ·åˆ›å»ºäº¤æ˜“...&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> signature = <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">            provider.<span class="property">connection</span>,</span><br><span class="line">            setupTx,</span><br><span class="line">            [wallet.<span class="property">payer</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âœ… è´¦æˆ·åˆ›å»ºå®Œæˆ: <span class="subst">$&#123;signature&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> signature;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨èµå›å‰è°ƒç”¨</span></span><br><span class="line"><span class="keyword">const</span> setupSignature = <span class="keyword">await</span> <span class="title function_">createMissingTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line"><span class="keyword">if</span> (setupSignature) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;â³ ç­‰å¾…è´¦æˆ·åˆ›å»ºç¡®è®¤...&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">2000</span>)); <span class="comment">// ç­‰å¾…ç¡®è®¤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-è°ƒè¯•æŠ€å·§ä¸å·¥å…·"><a href="#2-è°ƒè¯•æŠ€å·§ä¸å·¥å…·" class="headerlink" title="2. è°ƒè¯•æŠ€å·§ä¸å·¥å…·"></a>2. è°ƒè¯•æŠ€å·§ä¸å·¥å…·</h3><h4 id="A-äº¤æ˜“æ—¥å¿—åˆ†æ"><a href="#A-äº¤æ˜“æ—¥å¿—åˆ†æ" class="headerlink" title="A. äº¤æ˜“æ—¥å¿—åˆ†æ"></a>A. äº¤æ˜“æ—¥å¿—åˆ†æ</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¦ç»†çš„äº¤æ˜“æ‰§è¡Œå’Œæ—¥å¿—åˆ†æ</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">executeRedemptionWithLogging</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸš€ å¼€å§‹æ‰§è¡ŒETFèµå›...&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ“Š å‚æ•°: ETF=<span class="subst">$&#123;etfAddress&#125;</span>, æ•°é‡=<span class="subst">$&#123;lamports&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> signature = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âœ… äº¤æ˜“æˆåŠŸ: <span class="subst">$&#123;signature&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–è¯¦ç»†çš„äº¤æ˜“æ—¥å¿—</span></span><br><span class="line">        <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">            <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">            <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (txDetails?.<span class="property">meta</span>?.<span class="property">logMessages</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ“‹ äº¤æ˜“æ—¥å¿—:&quot;</span>);</span><br><span class="line">            txDetails.<span class="property">meta</span>.<span class="property">logMessages</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">log, index</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  <span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>. <span class="subst">$&#123;log&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†æè®¡ç®—å•å…ƒä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> (txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`âš¡ è®¡ç®—å•å…ƒæ¶ˆè€—: <span class="subst">$&#123;txDetails.meta.computeUnitsConsumed&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> signature;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;âŒ èµå›å¤±è´¥:&quot;</span>, error);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•è§£æAnchoré”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;0x&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> errorCode = error.<span class="property">message</span>.<span class="title function_">match</span>(<span class="regexp">/0x[0-9a-fA-F]+/</span>)?.[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ” é”™è¯¯ä»£ç : <span class="subst">$&#123;errorCode&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-çŠ¶æ€éªŒè¯å·¥å…·"><a href="#B-çŠ¶æ€éªŒè¯å·¥å…·" class="headerlink" title="B. çŠ¶æ€éªŒè¯å·¥å…·"></a>B. çŠ¶æ€éªŒè¯å·¥å…·</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµå›å‰åçŠ¶æ€å¯¹æ¯”å·¥å…·</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">captureEtfState</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> state = &#123;</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">        <span class="attr">userEtfBalance</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">userTokenBalances</span>: &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;,</span><br><span class="line">        <span class="attr">etfCustodyBalances</span>: &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·ETFä½™é¢</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        state.<span class="property">userEtfBalance</span> = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ç”¨æˆ·ETFè´¦æˆ·ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·åº•å±‚ä»£å¸ä½™é¢</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">            state.<span class="property">userTokenBalances</span>[token.<span class="title function_">toString</span>()] = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            state.<span class="property">userTokenBalances</span>[token.<span class="title function_">toString</span>()] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ETFæ‰˜ç®¡ä½™é¢</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">            state.<span class="property">etfCustodyBalances</span>[token.<span class="title function_">toString</span>()] = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            state.<span class="property">etfCustodyBalances</span>[token.<span class="title function_">toString</span>()] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> stateBefore = <span class="keyword">await</span> <span class="title function_">captureEtfState</span>(wallet, etfAddress, etfCoreAddress, etfInfo);</span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line"><span class="keyword">const</span> stateAfter = <span class="keyword">await</span> <span class="title function_">captureEtfState</span>(wallet, etfAddress, etfCoreAddress, etfInfo);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ“Š çŠ¶æ€å¯¹æ¯”:&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;èµå›å‰:&quot;</span>, stateBefore);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;èµå›å:&quot;</span>, stateAfter);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–"><a href="#3-æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–" class="headerlink" title="3. æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–"></a>3. æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–</h3><h4 id="A-äº¤æ˜“æˆæœ¬åˆ†æ"><a href="#A-äº¤æ˜“æˆæœ¬åˆ†æ" class="headerlink" title="A. äº¤æ˜“æˆæœ¬åˆ†æ"></a>A. äº¤æ˜“æˆæœ¬åˆ†æ</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼°ç®—èµå›äº¤æ˜“çš„æ€»æˆæœ¬</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">estimateRedemptionCost</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseFee = <span class="number">5000</span>; <span class="comment">// åŸºç¡€äº¤æ˜“è´¹ç”¨ (lamports)</span></span><br><span class="line">    <span class="keyword">const</span> computeUnitPrice = <span class="number">1000</span>; <span class="comment">// æ¯è®¡ç®—å•å…ƒä»·æ ¼ (micro-lamports)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—æ‰€éœ€è®¡ç®—å•å…ƒ</span></span><br><span class="line">    <span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">const</span> computeFee = computeUnits * computeUnitPrice / <span class="number">1_000_000</span>; <span class="comment">// è½¬æ¢ä¸ºlamports</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¼°ç®—è´¦æˆ·åˆ›å»ºæˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> accountCreationCost = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œåº”è¯¥æ£€æŸ¥å“ªäº›è´¦æˆ·éœ€è¦åˆ›å»º</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> totalCost = baseFee + computeFee + accountCreationCost;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ğŸ’° äº¤æ˜“æˆæœ¬ä¼°ç®—:&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  åŸºç¡€è´¹ç”¨: <span class="subst">$&#123;baseFee&#125;</span> lamports (<span class="subst">$&#123;baseFee / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  è®¡ç®—è´¹ç”¨: <span class="subst">$&#123;computeFee&#125;</span> lamports (<span class="subst">$&#123;computeFee / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  è´¦æˆ·åˆ›å»º: <span class="subst">$&#123;accountCreationCost&#125;</span> lamports (<span class="subst">$&#123;accountCreationCost / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  æ€»æˆæœ¬: <span class="subst">$&#123;totalCost&#125;</span> lamports (<span class="subst">$&#123;totalCost / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> totalCost;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-æ‰¹é‡èµå›ä¼˜åŒ–"><a href="#B-æ‰¹é‡èµå›ä¼˜åŒ–" class="headerlink" title="B. æ‰¹é‡èµå›ä¼˜åŒ–"></a>B. æ‰¹é‡èµå›ä¼˜åŒ–</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰¹é‡å¤„ç†å¤šä¸ªç”¨æˆ·çš„èµå›è¯·æ±‚</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">batchRedemption</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">redemptionRequests</span>: <span class="title class_">Array</span>&lt;&#123;</span></span><br><span class="line"><span class="params">        wallet: anchor.Wallet,</span></span><br><span class="line"><span class="params">        etfAddress: PublicKey,</span></span><br><span class="line"><span class="params">        amount: <span class="built_in">number</span></span></span><br><span class="line"><span class="params">    &#125;&gt;</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŒ‰ETFåœ°å€åˆ†ç»„ï¼Œä¼˜åŒ–RPCè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">const</span> groupedRequests = redemptionRequests.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, req</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> key = req.<span class="property">etfAddress</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">if</span> (!acc[key]) acc[key] = [];</span><br><span class="line">        acc[key].<span class="title function_">push</span>(req);</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;, &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="keyword">typeof</span> redemptionRequests&gt;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [etfAddress, requests] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(groupedRequests)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ”„ å¤„ç†ETF <span class="subst">$&#123;etfAddress&#125;</span> çš„ <span class="subst">$&#123;requests.length&#125;</span> ä¸ªèµå›è¯·æ±‚`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é¢„åŠ è½½ETFä¿¡æ¯ï¼Œé¿å…é‡å¤æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(<span class="keyword">new</span> <span class="title class_">PublicKey</span>(etfAddress));</span><br><span class="line">        <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¹¶è¡Œå¤„ç†åŒä¸€ETFçš„å¤šä¸ªèµå›è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(</span><br><span class="line">            requests.<span class="title function_">map</span>(<span class="function"><span class="params">req</span> =&gt;</span> </span><br><span class="line">                <span class="title function_">etfTokenBurn</span>(req.<span class="property">wallet</span>, req.<span class="property">etfAddress</span>, req.<span class="property">amount</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        results.<span class="title function_">push</span>(...batchResults);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»Ÿè®¡ç»“æœ</span></span><br><span class="line">    <span class="keyword">const</span> successful = results.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>).<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> failed = results.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">status</span> === <span class="string">&#x27;rejected&#x27;</span>).<span class="property">length</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ğŸ“Š æ‰¹é‡èµå›å®Œæˆ: æˆåŠŸ <span class="subst">$&#123;successful&#125;</span>, å¤±è´¥ <span class="subst">$&#123;failed&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="ä»£ç ä¼˜åŒ–å»ºè®®"><a href="#ä»£ç ä¼˜åŒ–å»ºè®®" class="headerlink" title="ä»£ç ä¼˜åŒ–å»ºè®®"></a>ä»£ç ä¼˜åŒ–å»ºè®®</h2><h3 id="1-Rustç¨‹åºç«¯ä¼˜åŒ–"><a href="#1-Rustç¨‹åºç«¯ä¼˜åŒ–" class="headerlink" title="1. Rustç¨‹åºç«¯ä¼˜åŒ–"></a>1. Rustç¨‹åºç«¯ä¼˜åŒ–</h3><h4 id="A-é”™è¯¯å¤„ç†å¢å¼º"><a href="#A-é”™è¯¯å¤„ç†å¢å¼º" class="headerlink" title="A. é”™è¯¯å¤„ç†å¢å¼º"></a>A. é”™è¯¯å¤„ç†å¢å¼º</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ä»£ç çš„æ”¹è¿›å»ºè®®</span></span><br><span class="line"><span class="keyword">use</span> thiserror::Error;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Error, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">EtfRedemptionError</span> &#123;</span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Invalid account provided: &#123;account&#125;&quot;</span>)]</span></span><br><span class="line">    InvalidAccount &#123; account: <span class="type">String</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Insufficient ETF token balance: required &#123;required&#125;, available &#123;available&#125;&quot;</span>)]</span></span><br><span class="line">    InsufficientEtfBalance &#123; required: <span class="type">u64</span>, available: <span class="type">u64</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Insufficient custody balance for token &#123;token&#125;: required &#123;required&#125;, available &#123;available&#125;&quot;</span>)]</span></span><br><span class="line">    InsufficientCustodyBalance &#123; token: <span class="type">String</span>, required: <span class="type">u64</span>, available: <span class="type">u64</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Weight calculation overflow for token &#123;token&#125;&quot;</span>)]</span></span><br><span class="line">    WeightCalculationOverflow &#123; token: <span class="type">String</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;ETF redemption is currently paused&quot;</span>)]</span></span><br><span class="line">    RedemptionPaused,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¹è¿›åçš„èµå›å‡½æ•°</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_enhanced</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// è¾“å…¥éªŒè¯</span></span><br><span class="line">    require!(lamports &gt; <span class="number">0</span>, EtfRedemptionError::InvalidAmount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ETFæ˜¯å¦æš‚åœ</span></span><br><span class="line">    require!(</span><br><span class="line">        !ctx.accounts.etf_token_info.is_paused.<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>),</span><br><span class="line">        EtfRedemptionError::RedemptionPaused</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é¢„å…ˆéªŒè¯ç”¨æˆ·ETFä½™é¢</span></span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.etf_token_ata.amount &gt;= lamports,</span><br><span class="line">        EtfRedemptionError::InsufficientEtfBalance &#123;</span><br><span class="line">            required: lamports,</span><br><span class="line">            available: ctx.accounts.etf_token_ata.amount</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç°æœ‰çš„èµå›é€»è¾‘...</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        m.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],</span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">        .remaining_accounts</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">        .collect::&lt;HashMap&lt;_, _&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œè½¬ç§»æ“ä½œï¼Œæ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">from_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">                &amp;x.token,</span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(EtfRedemptionError::InvalidAccount &#123; </span><br><span class="line">                account: <span class="built_in">format!</span>(<span class="string">&quot;ETF custody account for token &#123;&#125;&quot;</span>, x.token) </span><br><span class="line">            &#125;)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">to_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">                &amp;x.token,</span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(EtfRedemptionError::InvalidAccount &#123; </span><br><span class="line">                account: <span class="built_in">format!</span>(<span class="string">&quot;User account for token &#123;&#125;&quot;</span>, x.token) </span><br><span class="line">            &#125;)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œè½¬ç§»</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: from_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    to: to_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                &#125;,</span><br><span class="line">                signer_seeds,</span><br><span class="line">            ),</span><br><span class="line">            amount</span><br><span class="line">        ).<span class="title function_ invoke__">map_err</span>(|_| EtfRedemptionError::InsufficientCustodyBalance &#123;</span><br><span class="line">            token: x.token.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            required: amount,</span><br><span class="line">            available: <span class="number">0</span>, <span class="comment">// è¿™é‡Œåº”è¯¥è·å–å®é™…ä½™é¢</span></span><br><span class="line">        &#125;)?;</span><br><span class="line"></span><br><span class="line">        msg!(<span class="string">&quot;âœ… Transferred &#123;&#125; units of token &#123;&#125; from ETF to user&quot;</span>, amount, x.token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯ETFä»£å¸</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            Burn &#123;</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        lamports,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;ğŸ”¥ Successfully burned &#123;&#125; ETF tokens&quot;</span>, lamports);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å‡ºèµå›äº‹ä»¶</span></span><br><span class="line">    emit!(RedemptionEvent &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount_burned: lamports,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµå›äº‹ä»¶å®šä¹‰</span></span><br><span class="line"><span class="meta">#[event]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RedemptionEvent</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_burned: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">i64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#B-æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="B. æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>B. æ€§èƒ½ä¼˜åŒ–å»ºè®®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¢„è®¡ç®—ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜æƒé‡è®¡ç®—ç»“æœ</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redemption_amounts</span>(&amp;<span class="keyword">self</span>, lamports: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;(Pubkey, <span class="type">u64</span>)&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.constituent</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map</span>(|x| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">                (x.token, amount)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">collect</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éªŒè¯æƒé‡æ€»å’Œï¼ˆåº”è¯¥åœ¨ETFåˆ›å»ºæ—¶éªŒè¯ï¼Œè€Œä¸æ˜¯æ¯æ¬¡èµå›æ—¶éªŒè¯ï¼‰</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_weights</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">total_weight</span>: <span class="type">u32</span> = <span class="keyword">self</span>.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|c| c.weight).<span class="title function_ invoke__">sum</span>();</span><br><span class="line">        require!(total_weight == <span class="number">100</span>, TokenMintError::InvalidWeightSum);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ“ä½œä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">batch_transfer_for_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    token_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    transfers: <span class="type">Vec</span>&lt;TransferParams&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// æ‰¹é‡æ‰§è¡Œè½¬ç§»æ“ä½œï¼Œå‡å°‘CPIè°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">transfer_params</span> <span class="keyword">in</span> transfers &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">                transfer_params.transfer_accounts,</span><br><span class="line">                signer_seeds,</span><br><span class="line">            ),</span><br><span class="line">            transfer_params.amount,</span><br><span class="line">        )?;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-TypeScriptå®¢æˆ·ç«¯ä¼˜åŒ–"><a href="#2-TypeScriptå®¢æˆ·ç«¯ä¼˜åŒ–" class="headerlink" title="2. TypeScriptå®¢æˆ·ç«¯ä¼˜åŒ–"></a>2. TypeScriptå®¢æˆ·ç«¯ä¼˜åŒ–</h3><h4 id="A-ç±»å‹å®‰å…¨å¢å¼º"><a href="#A-ç±»å‹å®‰å…¨å¢å¼º" class="headerlink" title="A. ç±»å‹å®‰å…¨å¢å¼º"></a>A. ç±»å‹å®‰å…¨å¢å¼º</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸¥æ ¼çš„ç±»å‹æ¥å£</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EtfRedemptionConfig</span> &#123;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">amount</span>: <span class="variable constant_">BN</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">slippageTolerance</span>?: <span class="built_in">number</span>; <span class="comment">// æ»‘ç‚¹å®¹å¿åº¦</span></span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">deadline</span>?: <span class="built_in">number</span>; <span class="comment">// æˆªæ­¢æ—¶é—´</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EtfRedemptionResult</span> &#123;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">signature</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">slot</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">blockTime</span>: <span class="built_in">number</span> | <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">fee</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">computeUnitsUsed</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">underlyingAssetsReceived</span>: <span class="title class_">Array</span>&lt;&#123;</span><br><span class="line">        <span class="attr">token</span>: <span class="title class_">PublicKey</span>;</span><br><span class="line">        <span class="attr">amount</span>: <span class="variable constant_">BN</span>;</span><br><span class="line">        <span class="attr">weight</span>: <span class="built_in">number</span>;</span><br><span class="line">    &#125;&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¹è¿›çš„èµå›å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurnTyped</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// è¾“å…¥éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">amount</span>.<span class="title function_">lte</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;èµå›æ•°é‡å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(config.<span class="property">etfAddress</span>);</span><br><span class="line">    <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">deadline</span> &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() &gt; config.<span class="property">deadline</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;äº¤æ˜“å·²è¶…è¿‡æˆªæ­¢æ—¶é—´&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é¢„å…ˆéªŒè¯ç”¨æˆ·ä½™é¢</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">validateUserEtfBalance</span>(wallet, config.<span class="property">etfAddress</span>, config.<span class="property">amount</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„å»ºäº¤æ˜“</span></span><br><span class="line">    <span class="keyword">const</span> &#123; transaction, computeUnits &#125; = <span class="keyword">await</span> <span class="title function_">buildRedemptionTransaction</span>(</span><br><span class="line">        wallet,</span><br><span class="line">        config,</span><br><span class="line">        etfInfo,</span><br><span class="line">        etfCoreAddress</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€äº¤æ˜“</span></span><br><span class="line">    <span class="keyword">const</span> signature = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">sendTransaction</span>(transaction, [wallet.<span class="property">payer</span>], &#123;</span><br><span class="line">        <span class="attr">skipPreflight</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">preflightCommitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">const</span> confirmation = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">confirmTransaction</span>(&#123;</span><br><span class="line">        signature,</span><br><span class="line">        <span class="attr">blockhash</span>: (<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>()).<span class="property">blockhash</span>,</span><br><span class="line">        <span class="attr">lastValidBlockHeight</span>: (<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>()).<span class="property">lastValidBlockHeight</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (confirmation.<span class="property">value</span>.<span class="property">err</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`äº¤æ˜“å¤±è´¥: <span class="subst">$&#123;confirmation.value.err&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–äº¤æ˜“è¯¦æƒ…</span></span><br><span class="line">    <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">        <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—æ¥æ”¶åˆ°çš„åº•å±‚èµ„äº§</span></span><br><span class="line">    <span class="keyword">const</span> underlyingAssetsReceived = etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">token</span>: c.<span class="property">token</span>,</span><br><span class="line">        <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(c.<span class="property">weight</span>).<span class="title function_">mul</span>(config.<span class="property">amount</span>).<span class="title function_">div</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">100</span>)),</span><br><span class="line">        <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        signature,</span><br><span class="line">        <span class="attr">slot</span>: confirmation.<span class="property">context</span>.<span class="property">slot</span>,</span><br><span class="line">        <span class="attr">blockTime</span>: txDetails?.<span class="property">blockTime</span> || <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">fee</span>: txDetails?.<span class="property">meta</span>?.<span class="property">fee</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">computeUnitsUsed</span>: txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span> || <span class="number">0</span>,</span><br><span class="line">        underlyingAssetsReceived,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">validateUserEtfBalance</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">requiredAmount</span>: BN</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="keyword">const</span> balance = <span class="keyword">new</span> <span class="title function_">BN</span>(account.<span class="property">amount</span>.<span class="title function_">toString</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (balance.<span class="title function_">lt</span>(requiredAmount)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">                <span class="string">`ETFä½™é¢ä¸è¶³: éœ€è¦ <span class="subst">$&#123;requiredAmount.toString()&#125;</span>, å¯ç”¨ <span class="subst">$&#123;balance.toString()&#125;</span>`</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;ETFä»£å¸è´¦æˆ·ä¸å­˜åœ¨ï¼Œç”¨æˆ·å¯èƒ½ä»æœªæŒæœ‰æ­¤ETFä»£å¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">buildRedemptionTransaction</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">transaction</span>: <span class="title class_">Transaction</span>, <span class="attr">computeUnits</span>: <span class="built_in">number</span> &#125;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> [</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> ix = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">        .<span class="title function_">etfTokenBurn</span>(config.<span class="property">amount</span>)</span><br><span class="line">        .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">            <span class="attr">etfTokenMintAccount</span>: config.<span class="property">etfAddress</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">remainingAccounts</span>(</span><br><span class="line">            remainingAccounts.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123;</span><br><span class="line">                <span class="attr">pubkey</span>: item,</span><br><span class="line">                <span class="attr">isWritable</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">isSigner</span>: <span class="literal">false</span>,</span><br><span class="line">            &#125;))</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">instruction</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">const</span> modifyComputeUnits = <span class="title class_">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">        <span class="attr">units</span>: computeUnits,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> transaction = <span class="keyword">new</span> <span class="title class_">Transaction</span>().<span class="title function_">add</span>(ix).<span class="title function_">add</span>(modifyComputeUnits);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€è¿‘çš„åŒºå—å“ˆå¸Œ</span></span><br><span class="line">    <span class="keyword">const</span> &#123; blockhash &#125; = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>();</span><br><span class="line">    transaction.<span class="property">recentBlockhash</span> = blockhash;</span><br><span class="line">    transaction.<span class="property">feePayer</span> = wallet.<span class="property">payer</span>.<span class="property">publicKey</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; transaction, computeUnits &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-ç”¨æˆ·ä½“éªŒä¼˜åŒ–"><a href="#B-ç”¨æˆ·ä½“éªŒä¼˜åŒ–" class="headerlink" title="B. ç”¨æˆ·ä½“éªŒä¼˜åŒ–"></a>B. ç”¨æˆ·ä½“éªŒä¼˜åŒ–</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµå›è¿›åº¦è·Ÿè¸ª</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EtfRedemptionTracker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> steps = [</span><br><span class="line">        <span class="string">&quot;éªŒè¯ç”¨æˆ·ä½™é¢&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æ£€æŸ¥æ‰˜ç®¡èµ„äº§&quot;</span>,</span><br><span class="line">        <span class="string">&quot;åˆ›å»ºç¼ºå¤±è´¦æˆ·&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æ„å»ºäº¤æ˜“&quot;</span>,</span><br><span class="line">        <span class="string">&quot;å‘é€äº¤æ˜“&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ç­‰å¾…ç¡®è®¤&quot;</span>,</span><br><span class="line">        <span class="string">&quot;éªŒè¯ç»“æœ&quot;</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> currentStep = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">onProgress</span>?: <span class="function">(<span class="params"><span class="attr">step</span>: <span class="built_in">number</span>, <span class="attr">total</span>: <span class="built_in">number</span>, <span class="attr">message</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">onProgress</span>?: (step: <span class="built_in">number</span>, total: <span class="built_in">number</span>, message: <span class="built_in">string</span>) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onProgress</span> = onProgress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">nextStep</span>(<span class="params"><span class="attr">message</span>?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentStep</span>++;</span><br><span class="line">        <span class="keyword">const</span> stepMessage = message || <span class="variable language_">this</span>.<span class="property">steps</span>[<span class="variable language_">this</span>.<span class="property">currentStep</span> - <span class="number">1</span>] || <span class="string">&quot;å¤„ç†ä¸­...&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onProgress</span>?.(<span class="variable language_">this</span>.<span class="property">currentStep</span>, <span class="variable language_">this</span>.<span class="property">steps</span>.<span class="property">length</span>, stepMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">trackRedemption</span>(</span><br><span class="line">        <span class="attr">wallet</span>: anchor.<span class="property">Wallet</span>,</span><br><span class="line">        <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span></span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;å¼€å§‹éªŒè¯ç”¨æˆ·ETFä½™é¢...&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">validateUserEtfBalance</span>(wallet, config.<span class="property">etfAddress</span>, config.<span class="property">amount</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;è·å–ETFé…ç½®ä¿¡æ¯...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(config.<span class="property">etfAddress</span>);</span><br><span class="line">            <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;æ£€æŸ¥ç”¨æˆ·ä»£å¸æ¥æ”¶è´¦æˆ·...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> setupTx = <span class="keyword">await</span> <span class="title function_">ensureUserTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (setupTx) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;åˆ›å»ºç¼ºå¤±çš„ä»£å¸è´¦æˆ·...&quot;</span>);</span><br><span class="line">                <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">                    provider.<span class="property">connection</span>,</span><br><span class="line">                    setupTx,</span><br><span class="line">                    [wallet.<span class="property">payer</span>]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;æ„å»ºèµå›äº¤æ˜“...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> &#123; transaction &#125; = <span class="keyword">await</span> <span class="title function_">buildRedemptionTransaction</span>(</span><br><span class="line">                wallet,</span><br><span class="line">                config,</span><br><span class="line">                etfInfo,</span><br><span class="line">                etfCoreAddress</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;å‘é€äº¤æ˜“åˆ°åŒºå—é“¾...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> signature = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">sendTransaction</span>(</span><br><span class="line">                transaction,</span><br><span class="line">                [wallet.<span class="property">payer</span>]</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;ç­‰å¾…äº¤æ˜“ç¡®è®¤...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> confirmation = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">confirmTransaction</span>(&#123;</span><br><span class="line">                signature,</span><br><span class="line">                ...<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>(),</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (confirmation.<span class="property">value</span>.<span class="property">err</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`äº¤æ˜“å¤±è´¥: <span class="subst">$&#123;confirmation.value.err&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;éªŒè¯èµå›ç»“æœ...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">buildRedemptionResult</span>(</span><br><span class="line">                signature,</span><br><span class="line">                confirmation,</span><br><span class="line">                config,</span><br><span class="line">                etfInfo</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;èµå›å®Œæˆï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">onProgress</span>?.(<span class="variable language_">this</span>.<span class="property">currentStep</span>, <span class="variable language_">this</span>.<span class="property">steps</span>.<span class="property">length</span>, <span class="string">`é”™è¯¯: <span class="subst">$&#123;error.message&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">buildRedemptionResult</span>(</span><br><span class="line">        <span class="attr">signature</span>: <span class="built_in">string</span>,</span><br><span class="line">        <span class="attr">confirmation</span>: <span class="built_in">any</span>,</span><br><span class="line">        <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span><br><span class="line">        <span class="attr">etfInfo</span>: <span class="built_in">any</span></span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">            <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            signature,</span><br><span class="line">            <span class="attr">slot</span>: confirmation.<span class="property">context</span>.<span class="property">slot</span>,</span><br><span class="line">            <span class="attr">blockTime</span>: txDetails?.<span class="property">blockTime</span> || <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">fee</span>: txDetails?.<span class="property">meta</span>?.<span class="property">fee</span> || <span class="number">0</span>,</span><br><span class="line">            <span class="attr">computeUnitsUsed</span>: txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span> || <span class="number">0</span>,</span><br><span class="line">            <span class="attr">underlyingAssetsReceived</span>: etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">c</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">                <span class="attr">token</span>: c.<span class="property">token</span>,</span><br><span class="line">                <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(c.<span class="property">weight</span>).<span class="title function_">mul</span>(config.<span class="property">amount</span>).<span class="title function_">div</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">100</span>)),</span><br><span class="line">                <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">            &#125;)),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> redemptionTracker = <span class="keyword">new</span> <span class="title class_">EtfRedemptionTracker</span>(<span class="function">(<span class="params">step, total, message</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">$&#123;step&#125;</span>/<span class="subst">$&#123;total&#125;</span>] <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥æ›´æ–°UIè¿›åº¦æ¡</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> redemptionTracker.<span class="title function_">trackRedemption</span>(wallet, &#123;</span><br><span class="line">    <span class="attr">etfAddress</span>: etfMintAddress,</span><br><span class="line">    <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">600000000</span>),</span><br><span class="line">    <span class="attr">slippageTolerance</span>: <span class="number">0.005</span>, <span class="comment">// 0.5%</span></span><br><span class="line">    <span class="attr">deadline</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// 5åˆ†é’Ÿåè¿‡æœŸ</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-æ¶æ„å±‚é¢ä¼˜åŒ–å»ºè®®"><a href="#3-æ¶æ„å±‚é¢ä¼˜åŒ–å»ºè®®" class="headerlink" title="3. æ¶æ„å±‚é¢ä¼˜åŒ–å»ºè®®"></a>3. æ¶æ„å±‚é¢ä¼˜åŒ–å»ºè®®</h3><h4 id="A-æ¨¡å—åŒ–é‡æ„"><a href="#A-æ¨¡å—åŒ–é‡æ„" class="headerlink" title="A. æ¨¡å—åŒ–é‡æ„"></a>A. æ¨¡å—åŒ–é‡æ„</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»ºè®®çš„æ¨¡å—ç»“æ„</span></span><br><span class="line"><span class="comment">// src/</span></span><br><span class="line"><span class="comment">// â”œâ”€â”€ lib.rs                 // ä¸»ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="comment">// â”œâ”€â”€ instructions/          // æŒ‡ä»¤å¤„ç†æ¨¡å—</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ mod.rs</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ create_etf.rs      // ETFåˆ›å»º</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ mint_etf.rs        // ETFè´­ä¹°</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ burn_etf.rs        // ETFèµå›</span></span><br><span class="line"><span class="comment">// â”‚   â””â”€â”€ manage_etf.rs      // ETFç®¡ç†</span></span><br><span class="line"><span class="comment">// â”œâ”€â”€ state/                 // çŠ¶æ€å®šä¹‰æ¨¡å—</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ mod.rs</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ etf_token.rs       // ETFçŠ¶æ€</span></span><br><span class="line"><span class="comment">// â”‚   â””â”€â”€ events.rs          // äº‹ä»¶å®šä¹‰</span></span><br><span class="line"><span class="comment">// â”œâ”€â”€ utils/                 // å·¥å…·å‡½æ•°æ¨¡å—</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ mod.rs</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ calculations.rs    // è®¡ç®—å·¥å…·</span></span><br><span class="line"><span class="comment">// â”‚   â”œâ”€â”€ validations.rs     // éªŒè¯å·¥å…·</span></span><br><span class="line"><span class="comment">// â”‚   â””â”€â”€ constants.rs       // å¸¸é‡å®šä¹‰</span></span><br><span class="line"><span class="comment">// â””â”€â”€ errors/                // é”™è¯¯å®šä¹‰æ¨¡å—</span></span><br><span class="line"><span class="comment">//     â”œâ”€â”€ mod.rs</span></span><br><span class="line"><span class="comment">//     â””â”€â”€ etf_errors.rs      // ETFç›¸å…³é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/calculations.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfCalculations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfCalculations</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redemption_amounts</span>(</span><br><span class="line">        constituent: &amp;[EtfTokenConstituent],</span><br><span class="line">        total_amount: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;(Pubkey, <span class="type">u64</span>)&gt; &#123;</span><br><span class="line">        constituent</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map</span>(|x| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">amount</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">safe_multiply_and_divide</span>(</span><br><span class="line">                    x.weight <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">                    total_amount,</span><br><span class="line">                    <span class="number">100</span></span><br><span class="line">                ).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Calculation overflow&quot;</span>);</span><br><span class="line">                (x.token, amount)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">collect</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">safe_multiply_and_divide</span>(a: <span class="type">u64</span>, b: <span class="type">u64</span>, divisor: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">        a.<span class="title function_ invoke__">checked_mul</span>(b)?.<span class="title function_ invoke__">checked_div</span>(divisor)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_weight_sum</span>(weights: &amp;[<span class="type">u32</span>]) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        weights.<span class="title function_ invoke__">iter</span>().sum::&lt;<span class="type">u32</span>&gt;() == <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/validations.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfValidations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfValidations</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_request</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">        ctx: &amp;Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">        lamports: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// åŸºæœ¬éªŒè¯</span></span><br><span class="line">        require!(lamports &gt; <span class="number">0</span>, EtfError::InvalidAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½™é¢éªŒè¯</span></span><br><span class="line">        require!(</span><br><span class="line">            ctx.accounts.etf_token_ata.amount &gt;= lamports,</span><br><span class="line">            EtfError::InsufficientBalance</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// çŠ¶æ€éªŒè¯</span></span><br><span class="line">        require!(</span><br><span class="line">            !ctx.accounts.etf_token_info.is_paused.<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>),</span><br><span class="line">            EtfError::RedemptionPaused</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_accounts_mapping</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">        accounts: &amp;HashMap&lt;Pubkey, AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">        expected_accounts: &amp;[Pubkey],</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">expected</span> <span class="keyword">in</span> expected_accounts &#123;</span><br><span class="line">            require!(</span><br><span class="line">                accounts.<span class="title function_ invoke__">contains_key</span>(expected),</span><br><span class="line">                EtfError::MissingAccount &#123; account: *expected &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-é…ç½®åŒ–ç®¡ç†"><a href="#B-é…ç½®åŒ–ç®¡ç†" class="headerlink" title="B. é…ç½®åŒ–ç®¡ç†"></a>B. é…ç½®åŒ–ç®¡ç†</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é…ç½®æ–‡ä»¶æ”¯æŒ</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfConfig</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> admin: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> fee_collector: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> redemption_fee_bps: <span class="type">u16</span>,      <span class="comment">// èµå›è´¹ç‡ï¼ˆåŸºç‚¹ï¼‰</span></span><br><span class="line">    <span class="keyword">pub</span> min_redemption: <span class="type">u64</span>,          <span class="comment">// æœ€å°èµå›é‡</span></span><br><span class="line">    <span class="keyword">pub</span> max_redemption: <span class="type">u64</span>,          <span class="comment">// æœ€å¤§èµå›é‡</span></span><br><span class="line">    <span class="keyword">pub</span> redemption_delay: <span class="type">i64</span>,        <span class="comment">// èµå›å»¶è¿Ÿï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="keyword">pub</span> emergency_pause_enabled: <span class="type">bool</span>, <span class="comment">// æ˜¯å¦å¯ç”¨ç´§æ€¥æš‚åœ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfConfig</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;etf_config&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_amount</span>(&amp;<span class="keyword">self</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        require!(amount &gt;= <span class="keyword">self</span>.min_redemption, EtfError::BelowMinRedemption);</span><br><span class="line">        require!(amount &lt;= <span class="keyword">self</span>.max_redemption, EtfError::ExceedsMaxRedemption);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_fee</span>(&amp;<span class="keyword">self</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">        amount * <span class="keyword">self</span>.redemption_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10_000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€ä½³å®è·µæ€»ç»“"><a href="#æœ€ä½³å®è·µæ€»ç»“" class="headerlink" title="æœ€ä½³å®è·µæ€»ç»“"></a>æœ€ä½³å®è·µæ€»ç»“</h2><h3 id="1-å¼€å‘æµç¨‹å»ºè®®"><a href="#1-å¼€å‘æµç¨‹å»ºè®®" class="headerlink" title="1. å¼€å‘æµç¨‹å»ºè®®"></a>1. å¼€å‘æµç¨‹å»ºè®®</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ğŸ”„ å¼€å‘ç”Ÿå‘½å‘¨æœŸï¼š</span><br><span class="line"></span><br><span class="line">1. è®¾è®¡é˜¶æ®µ</span><br><span class="line">   â”œâ”€â”€ å®šä¹‰ETFéœ€æ±‚å’Œçº¦æŸ</span><br><span class="line">   â”œâ”€â”€ è®¾è®¡è´¦æˆ·ç»“æ„å’Œæƒé™æ¨¡å‹</span><br><span class="line">   â”œâ”€â”€ è§„åˆ’é”™è¯¯å¤„ç†ç­–ç•¥</span><br><span class="line">   â””â”€â”€ åˆ¶å®šæµ‹è¯•è®¡åˆ’</span><br><span class="line"></span><br><span class="line">2. å®ç°é˜¶æ®µ</span><br><span class="line">   â”œâ”€â”€ ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span><br><span class="line">   â”œâ”€â”€ å®ç°å…¨é¢çš„è¾“å…¥éªŒè¯</span><br><span class="line">   â”œâ”€â”€ æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•</span><br><span class="line">   â””â”€â”€ ç¼–å†™å•å…ƒæµ‹è¯•</span><br><span class="line"></span><br><span class="line">3. æµ‹è¯•é˜¶æ®µ</span><br><span class="line">   â”œâ”€â”€ æœ¬åœ°å¼€å‘ç½‘æµ‹è¯•</span><br><span class="line">   â”œâ”€â”€ Devneté›†æˆæµ‹è¯•</span><br><span class="line">   â”œâ”€â”€ è¾¹ç•Œæƒ…å†µæµ‹è¯•</span><br><span class="line">   â””â”€â”€ æ€§èƒ½å‹åŠ›æµ‹è¯•</span><br><span class="line"></span><br><span class="line">4. éƒ¨ç½²é˜¶æ®µ</span><br><span class="line">   â”œâ”€â”€ Mainnet-betaéªŒè¯</span><br><span class="line">   â”œâ”€â”€ ç›‘æ§å’Œå‘Šè­¦è®¾ç½®</span><br><span class="line">   â”œâ”€â”€ ç”¨æˆ·æ–‡æ¡£å‡†å¤‡</span><br><span class="line">   â””â”€â”€ ç¤¾åŒºåé¦ˆæ”¶é›†</span><br></pre></td></tr></table></figure>

<h3 id="2-å®‰å…¨æ£€æŸ¥æ¸…å•"><a href="#2-å®‰å…¨æ£€æŸ¥æ¸…å•" class="headerlink" title="2. å®‰å…¨æ£€æŸ¥æ¸…å•"></a>2. å®‰å…¨æ£€æŸ¥æ¸…å•</h3><ul>
<li>âœ… <strong>æƒé™éªŒè¯</strong>: ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·èƒ½æ‰§è¡Œèµå›</li>
<li>âœ… <strong>ä½™é¢æ£€æŸ¥</strong>: éªŒè¯ç”¨æˆ·æœ‰è¶³å¤Ÿçš„ETFä»£å¸</li>
<li>âœ… <strong>åŸå­æ€§</strong>: æ‰€æœ‰æ“ä½œåœ¨å•ä¸€äº‹åŠ¡ä¸­å®Œæˆ</li>
<li>âœ… <strong>æº¢å‡ºä¿æŠ¤</strong>: é˜²æ­¢æ•°å€¼è®¡ç®—æº¢å‡º</li>
<li>âœ… <strong>é‡å…¥ä¿æŠ¤</strong>: é˜²æ­¢é‡å…¥æ”»å‡»</li>
<li>âœ… <strong>çŠ¶æ€ä¸€è‡´æ€§</strong>: ç¡®ä¿ç¨‹åºçŠ¶æ€å§‹ç»ˆä¸€è‡´</li>
<li>âœ… <strong>é”™è¯¯å¤„ç†</strong>: æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯</li>
<li>âœ… <strong>äº‹ä»¶æ—¥å¿—</strong>: è®°å½•é‡è¦æ“ä½œçš„äº‹ä»¶</li>
</ul>
<h3 id="3-æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"><a href="#3-æ€§èƒ½ä¼˜åŒ–è¦ç‚¹" class="headerlink" title="3. æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"></a>3. æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h3><ul>
<li>âš¡ <strong>è®¡ç®—å•å…ƒç®¡ç†</strong>: æ ¹æ®ETFå¤æ‚åº¦åŠ¨æ€è°ƒæ•´</li>
<li>âš¡ <strong>æ‰¹é‡æ“ä½œ</strong>: å‡å°‘ä¸å¿…è¦çš„RPCè°ƒç”¨</li>
<li>âš¡ <strong>è´¦æˆ·é¢„æ£€</strong>: æå‰éªŒè¯è´¦æˆ·å­˜åœ¨æ€§</li>
<li>âš¡ <strong>ç¼“å­˜ç­–ç•¥</strong>: ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®</li>
<li>âš¡ <strong>å¹¶å‘å¤„ç†</strong>: åˆç†åˆ©ç”¨å¼‚æ­¥æ“ä½œ</li>
</ul>
<h3 id="4-ç”¨æˆ·ä½“éªŒå…³æ³¨ç‚¹"><a href="#4-ç”¨æˆ·ä½“éªŒå…³æ³¨ç‚¹" class="headerlink" title="4. ç”¨æˆ·ä½“éªŒå…³æ³¨ç‚¹"></a>4. ç”¨æˆ·ä½“éªŒå…³æ³¨ç‚¹</h3><ul>
<li>ğŸ¯ <strong>è¿›åº¦åé¦ˆ</strong>: å®æ—¶æ˜¾ç¤ºæ“ä½œè¿›åº¦</li>
<li>ğŸ¯ <strong>é”™è¯¯æç¤º</strong>: æä¾›æ¸…æ™°çš„é”™è¯¯è¯´æ˜</li>
<li>ğŸ¯ <strong>æˆæœ¬é€æ˜</strong>: æ˜¾ç¤ºé¢„ä¼°äº¤æ˜“æˆæœ¬</li>
<li>ğŸ¯ <strong>ç»“æœéªŒè¯</strong>: ç¡®è®¤æ“ä½œç»“æœçš„æ­£ç¡®æ€§</li>
<li>ğŸ¯ <strong>å†å²è®°å½•</strong>: æä¾›æ“ä½œå†å²æŸ¥è¯¢</li>
</ul>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>ETFèµå›åŠŸèƒ½æ˜¯æ•´ä¸ªETFç³»ç»Ÿä¸­çš„å…³é”®ç»„ä»¶ï¼Œå®ƒç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿéšæ—¶å°†æŒæœ‰çš„ETFä»£å¸è½¬æ¢å›åº•å±‚èµ„äº§ã€‚æœ¬æ•™ç¨‹é€šè¿‡è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å’Œæ·±å…¥çš„æŠ€æœ¯åˆ†æï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨Solanaä¸Šå®ç°å®‰å…¨ã€é«˜æ•ˆçš„ETFèµå›æœºåˆ¶ã€‚</p>
<p><strong>æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹å›é¡¾</strong>ï¼š</p>
<ul>
<li>ğŸ” <strong>PDAæƒé™æ§åˆ¶</strong>: ç¡®ä¿åªæœ‰ETFåˆçº¦èƒ½å¤Ÿè½¬ç§»æ‰˜ç®¡èµ„äº§</li>
<li>âš–ï¸ <strong>æ¯”ä¾‹åˆ†é…ç®—æ³•</strong>: æŒ‰æƒé‡å‡†ç¡®è¿”è¿˜åº•å±‚èµ„äº§</li>
<li>ğŸ”¥ <strong>ä»£å¸é”€æ¯æœºåˆ¶</strong>: ç»´æŠ¤ETFä»£å¸ä¾›åº”é‡çš„å‡†ç¡®æ€§</li>
<li>ğŸ›¡ï¸ <strong>åŸå­æ€§ä¿éšœ</strong>: é˜²æ­¢éƒ¨åˆ†æ‰§è¡Œå¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´</li>
<li>ğŸ“Š <strong>è¯¦ç»†æ—¥å¿—è®°å½•</strong>: ä¾¿äºè°ƒè¯•å’Œå®¡è®¡</li>
</ul>
<p><strong>ä¸è´­ä¹°åŠŸèƒ½çš„å¯¹æ¯”</strong>ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è´­ä¹°(Mint): ç”¨æˆ·èµ„äº§ â†’ ETFæ‰˜ç®¡ + é“¸é€ ETFä»£å¸</span><br><span class="line">èµå›(Burn): ETFæ‰˜ç®¡ â†’ ç”¨æˆ·èµ„äº§ + é”€æ¯ETFä»£å¸</span><br><span class="line"></span><br><span class="line">ä¸¤ä¸ªæ“ä½œå½¢æˆå®Œç¾çš„å¯¹ç§°æ€§ï¼Œç¡®ä¿èµ„äº§æ€»é‡å®ˆæ’</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æœ¬æ•™ç¨‹çš„å­¦ä¹ ï¼Œå¼€å‘è€…å¯ä»¥ï¼š</p>
<ol>
<li>ç†è§£ETFèµå›çš„æ ¸å¿ƒæœºåˆ¶å’Œå®‰å…¨è¦æ±‚</li>
<li>æŒæ¡Solanaç¨‹åºå¼€å‘çš„é«˜çº§æŠ€å·§</li>
<li>å­¦ä¼šå¤„ç†å¤æ‚çš„å¤šè´¦æˆ·äº¤äº’åœºæ™¯  </li>
<li>å»ºç«‹å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ç­–ç•¥</li>
</ol>
<p>è¿™ä¸ªå®ç°ä¸ºæ„å»ºæ›´å¤æ‚çš„DeFiäº§å“æä¾›äº†åšå®åŸºç¡€ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨åŒºå—é“¾ä¸Šå®ç°ä¼ ç»Ÿé‡‘èäº§å“çš„æ•°å­—åŒ–åˆ›æ–°ã€‚</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/" rel="prev" title="Solanaå®æˆ˜-ETFçš„è´­ä¹°">
                  <i class="fa fa-angle-left"></i> Solanaå®æˆ˜-ETFçš„è´­ä¹°
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E6%8B%93%E5%B1%95/" rel="next" title="Solanaå®æˆ˜-ETFçš„æ‹“å±•">
                  Solanaå®æˆ˜-ETFçš„æ‹“å±• <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">samxie</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
