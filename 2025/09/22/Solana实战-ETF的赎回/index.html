<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="本教程将详细介绍如何在Solana上实现ETF代币的赎回功能，包括代币销毁、按比例返还底层资产和完整的错误处理机制">
<meta property="og:type" content="article">
<meta property="og:title" content="Solana实战-ETF的赎回">
<meta property="og:url" content="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/index.html">
<meta property="og:site_name" content="samxie52">
<meta property="og:description" content="本教程将详细介绍如何在Solana上实现ETF代币的赎回功能，包括代币销毁、按比例返还底层资产和完整的错误处理机制">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-22T02:56:26.000Z">
<meta property="article:modified_time" content="2025-09-22T03:09:04.058Z">
<meta property="article:author" content="samxie">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/","path":"2025/09/22/Solana实战-ETF的赎回/","title":"Solana实战-ETF的赎回"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Solana实战-ETF的赎回 | samxie52</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">samxie52</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41-ETF%E4%BB%A3%E5%B8%81%E9%94%80%E6%AF%81%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">步骤1: ETF代币销毁逻辑实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B%E5%AF%B9%E6%AF%94"><span class="nav-number">2.1.</span> <span class="nav-text">1. 权限模型对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B5%84%E4%BA%A7%E6%B5%81%E5%90%91%E5%AF%B9%E6%AF%94"><span class="nav-number">2.2.</span> <span class="nav-text">2. 资产流向对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-PDA%E7%AD%BE%E5%90%8D%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">2.3.</span> <span class="nav-text">3. PDA签名机制深度解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%AA%8C%E8%AF%81"><span class="nav-number">2.4.</span> <span class="nav-text">4. 数量计算验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42-%E6%B3%A8%E5%86%8CETF%E8%B5%8E%E5%9B%9E%E6%8C%87%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">步骤2: 注册ETF赎回指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A4%8D%E7%94%A8%E8%B4%A6%E6%88%B7%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">1. 复用账户结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8F%82%E6%95%B0%E7%AE%80%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">2. 参数简化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B5%8E%E5%9B%9E%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">步骤3: 客户端赎回实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B4%A6%E6%88%B7%E9%A1%BA%E5%BA%8F%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-number">4.1.</span> <span class="nav-text">1. 账户顺序的重要性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%94%99%E8%AF%AF%E9%A2%84%E9%98%B2%E6%9C%BA%E5%88%B6"><span class="nav-number">4.2.</span> <span class="nav-text">2. 错误预防机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%B4%A6%E6%88%B7%E5%AD%98%E5%9C%A8%E6%80%A7%E9%AA%8C%E8%AF%81"><span class="nav-number">4.3.</span> <span class="nav-text">3. 账户存在性验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44-%E5%AE%8C%E6%95%B4%E8%B5%8E%E5%9B%9E%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">步骤4: 完整赎回流程示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">技术深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B5%8E%E5%9B%9E%E6%93%8D%E4%BD%9C%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="nav-number">6.1.</span> <span class="nav-text">1. 赎回操作的原子性保障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%8B%E5%8A%A1%E5%AE%8C%E6%95%B4%E6%80%A7"><span class="nav-number">6.1.1.</span> <span class="nav-text">A. 事务完整性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">6.1.2.</span> <span class="nav-text">B. 状态一致性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">2. 权限验证机制深度分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-PDA%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">6.2.1.</span> <span class="nav-text">A. PDA权限控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="nav-number">6.2.2.</span> <span class="nav-text">B. 用户权限验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E7%9A%84%E7%B2%BE%E7%A1%AE%E6%80%A7"><span class="nav-number">6.3.</span> <span class="nav-text">3. 数量计算的精确性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%9D%83%E9%87%8D%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F"><span class="nav-number">6.3.1.</span> <span class="nav-text">A. 权重计算公式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%B2%BE%E5%BA%A6%E5%A4%84%E7%90%86%E8%80%83%E8%99%91"><span class="nav-number">6.3.2.</span> <span class="nav-text">B. 精度处理考虑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%B2%BE%E5%BA%A6%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">6.3.3.</span> <span class="nav-text">C. 精度优化建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">6.4.</span> <span class="nav-text">4. 错误处理机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.4.1.</span> <span class="nav-text">A. 常见错误类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E9%94%99%E8%AF%AF%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5"><span class="nav-number">6.4.2.</span> <span class="nav-text">B. 错误恢复策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">6.5.</span> <span class="nav-text">5. 性能优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E4%BC%98%E5%8C%96"><span class="nav-number">6.5.1.</span> <span class="nav-text">A. 批量操作优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E8%AE%A1%E7%AE%97%E5%8D%95%E5%85%83%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4"><span class="nav-number">6.5.2.</span> <span class="nav-text">B. 计算单元动态调整</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E8%B4%A6%E6%88%B7%E9%A2%84%E5%8F%96%E4%BC%98%E5%8C%96"><span class="nav-number">6.5.3.</span> <span class="nav-text">C. 账户预取优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.</span> <span class="nav-text">安全性考虑与最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB%E9%98%B2%E6%8A%A4"><span class="nav-number">7.1.</span> <span class="nav-text">1. 重入攻击防护</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%E9%A1%BA%E5%BA%8F"><span class="nav-number">7.1.1.</span> <span class="nav-text">A. 状态检查顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-number">7.1.2.</span> <span class="nav-text">B. 状态一致性检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BB%B7%E6%A0%BC%E6%93%8D%E7%BA%B5%E9%98%B2%E6%8A%A4"><span class="nav-number">7.2.</span> <span class="nav-text">2. 价格操纵防护</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E8%B5%8E%E5%9B%9E%E9%99%90%E5%88%B6%E6%9C%BA%E5%88%B6"><span class="nav-number">7.2.1.</span> <span class="nav-text">A. 赎回限制机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E4%BB%B7%E6%A0%BC%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-number">7.2.2.</span> <span class="nav-text">B. 价格验证机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%81%E5%8A%A8%E6%80%A7%E9%A3%8E%E9%99%A9%E7%AE%A1%E7%90%86"><span class="nav-number">7.3.</span> <span class="nav-text">3. 流动性风险管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%89%98%E7%AE%A1%E8%B5%84%E4%BA%A7%E5%85%85%E8%B6%B3%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-number">7.3.1.</span> <span class="nav-text">A. 托管资产充足性检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%B4%A7%E6%80%A5%E6%9A%82%E5%81%9C%E6%9C%BA%E5%88%B6"><span class="nav-number">7.3.2.</span> <span class="nav-text">B. 紧急暂停机制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AE%AE"><span class="nav-number">8.</span> <span class="nav-text">扩展功能建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E5%88%86%E8%B5%8E%E5%9B%9E%E4%B8%8E%E5%AE%8C%E6%95%B4%E8%B5%8E%E5%9B%9E"><span class="nav-number">8.1.</span> <span class="nav-text">1. 部分赎回与完整赎回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BB%B6%E8%BF%9F%E8%B5%8E%E5%9B%9E%E6%9C%BA%E5%88%B6"><span class="nav-number">8.2.</span> <span class="nav-text">2. 延迟赎回机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%B5%8E%E5%9B%9E%E8%B4%B9%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">8.3.</span> <span class="nav-text">3. 赎回费用机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%B5%8E%E5%9B%9E%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95"><span class="nav-number">8.4.</span> <span class="nav-text">4. 赎回历史记录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4%E6%8C%87%E5%8D%97"><span class="nav-number">9.</span> <span class="nav-text">故障排除指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%9C%BA%E6%99%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">9.1.</span> <span class="nav-text">1. 常见错误场景及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E2%80%9CInvalidAccounts%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.1.</span> <span class="nav-text">A. “InvalidAccounts” 错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E2%80%9CInsufficientBalance%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.2.</span> <span class="nav-text">B. “InsufficientBalance” 错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E2%80%9CTokenAccountNotFoundError%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">9.1.3.</span> <span class="nav-text">C. “TokenAccountNotFoundError” 错误</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.</span> <span class="nav-text">2. 调试技巧与工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">9.2.1.</span> <span class="nav-text">A. 交易日志分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%8A%B6%E6%80%81%E9%AA%8C%E8%AF%81%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.2.</span> <span class="nav-text">B. 状态验证工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-number">9.3.</span> <span class="nav-text">3. 性能监控与优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">9.3.1.</span> <span class="nav-text">A. 交易成本分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E6%89%B9%E9%87%8F%E8%B5%8E%E5%9B%9E%E4%BC%98%E5%8C%96"><span class="nav-number">9.3.2.</span> <span class="nav-text">B. 批量赎回优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.</span> <span class="nav-text">代码优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Rust%E7%A8%8B%E5%BA%8F%E7%AB%AF%E4%BC%98%E5%8C%96"><span class="nav-number">10.1.</span> <span class="nav-text">1. Rust程序端优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%A2%9E%E5%BC%BA"><span class="nav-number">10.1.1.</span> <span class="nav-text">A. 错误处理增强</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.1.2.</span> <span class="nav-text">B. 性能优化建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-TypeScript%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%98%E5%8C%96"><span class="nav-number">10.2.</span> <span class="nav-text">2. TypeScript客户端优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E5%A2%9E%E5%BC%BA"><span class="nav-number">10.2.1.</span> <span class="nav-text">A. 类型安全增强</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E4%BC%98%E5%8C%96"><span class="nav-number">10.2.2.</span> <span class="nav-text">B. 用户体验优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9E%B6%E6%9E%84%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">10.3.</span> <span class="nav-text">3. 架构层面优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%A8%A1%E5%9D%97%E5%8C%96%E9%87%8D%E6%9E%84"><span class="nav-number">10.3.1.</span> <span class="nav-text">A. 模块化重构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E9%85%8D%E7%BD%AE%E5%8C%96%E7%AE%A1%E7%90%86"><span class="nav-number">10.3.2.</span> <span class="nav-text">B. 配置化管理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="nav-number">11.</span> <span class="nav-text">最佳实践总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E5%BB%BA%E8%AE%AE"><span class="nav-number">11.1.</span> <span class="nav-text">1. 开发流程建议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95"><span class="nav-number">11.2.</span> <span class="nav-text">2. 安全检查清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A6%81%E7%82%B9"><span class="nav-number">11.3.</span> <span class="nav-text">3. 性能优化要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E5%85%B3%E6%B3%A8%E7%82%B9"><span class="nav-number">11.4.</span> <span class="nav-text">4. 用户体验关注点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">12.</span> <span class="nav-text">结论</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">samxie</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="samxie">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="samxie52">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Solana实战-ETF的赎回 | samxie52">
      <meta itemprop="description" content="本教程将详细介绍如何在Solana上实现ETF代币的赎回功能，包括代币销毁、按比例返还底层资产和完整的错误处理机制">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Solana实战-ETF的赎回
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-22 10:56:26 / 修改时间：11:09:04" itemprop="dateCreated datePublished" datetime="2025-09-22T10:56:26+08:00">2025-09-22</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">本教程将详细介绍如何在Solana上实现ETF代币的赎回功能，包括代币销毁、按比例返还底层资产和完整的错误处理机制</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>ETF赎回的核心机制</strong></p>
<p>在区块链ETF系统中，赎回ETF代币的过程实际上是<strong>购买的逆向操作</strong>：</p>
<ol>
<li><strong>代币销毁</strong>：销毁用户持有的ETF代币</li>
<li><strong>资产释放</strong>：从ETF合约托管账户中按权重比例转移底层代币给用户</li>
<li><strong>价值保持</strong>：确保用户获得的底层资产价值与销毁的ETF代币价值相等</li>
</ol>
<p><strong>本教程实现的功能</strong>：</p>
<ul>
<li>验证用户持有足够的ETF代币余额</li>
<li>按权重比例从ETF托管账户转移底层代币到用户账户</li>
<li>销毁相应数量的ETF代币</li>
<li>处理复杂的账户权限和PDA签名机制</li>
</ul>
<p><strong>赎回与购买的对比</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ETF购买流程：</span><br><span class="line">用户底层代币 → ETF托管账户</span><br><span class="line">同时：无 → 用户获得ETF代币</span><br><span class="line"></span><br><span class="line">ETF赎回流程：</span><br><span class="line">ETF托管账户 → 用户底层代币账户  </span><br><span class="line">同时：用户ETF代币 → 销毁</span><br></pre></td></tr></table></figure>

<h2 id="步骤1-ETF代币销毁逻辑实现"><a href="#步骤1-ETF代币销毁逻辑实现" class="headerlink" title="步骤1: ETF代币销毁逻辑实现"></a>步骤1: ETF代币销毁逻辑实现</h2><p><strong>目的</strong>：实现完整的ETF赎回流程，包括底层资产转移和ETF代币销毁。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/programs/counter/src/instructions/etf_token_burn.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::get_associated_token_address, </span><br><span class="line">    token::&#123;burn, transfer, Burn, Transfer&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::&#123;</span><br><span class="line">    accounts_ix::EtfTokenTransaction, </span><br><span class="line">    states::&#123;EtfToken, TokenMintError&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🔥 ETF代币赎回的核心实现函数</span></span><br><span class="line"><span class="comment">// 这个函数处理ETF代币的销毁和底层资产的返还</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// 要赎回的ETF代币数量（以最小单位计算）</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 🔐 准备ETF信息账户(PDA)的签名种子</span></span><br><span class="line">    <span class="comment">// ETF托管账户的代币转移需要PDA签名授权</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// &quot;etf_token_v3&quot; - 固定前缀</span></span><br><span class="line">        m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// mint账户地址</span></span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],        <span class="comment">// bump值，确保PDA签名有效</span></span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📋 构建剩余账户的快速查找映射表</span></span><br><span class="line">    <span class="comment">// remaining_accounts包含所有底层代币的用户账户和ETF托管账户</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">        .remaining_accounts</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))    <span class="comment">// 将账户地址作为key，账户信息作为value</span></span><br><span class="line">        .collect::&lt;HashMap&lt;_, _&gt;&gt;();        <span class="comment">// 创建HashMap用于O(1)时间复杂度的查找</span></span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;📊 Processing &#123;&#125; constituent tokens for redemption&quot;</span>, ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">len</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔄 遍历ETF的每个组成代币，执行资产返还</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 🔍 获取ETF托管的底层代币账户地址</span></span><br><span class="line">        <span class="comment">// 这是ETF合约控制的底层代币存储账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">from_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ETF信息账户地址（作为托管方）</span></span><br><span class="line">                &amp;x.token,                            <span class="comment">// 底层代币mint地址</span></span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// 如果找不到账户，返回错误</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 🔍 获取用户的底层代币关联账户地址</span></span><br><span class="line">        <span class="comment">// 这是用户接收返还代币的账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">to_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),  <span class="comment">// 用户地址</span></span><br><span class="line">                &amp;x.token,                       <span class="comment">// 底层代币mint地址</span></span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// 如果找不到账户，返回错误</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 💰 计算需要返还给用户的底层代币数量</span></span><br><span class="line">        <span class="comment">// 公式: (权重 / 100) * 赎回的ETF数量</span></span><br><span class="line">        <span class="comment">// 这确保了按比例返还底层资产</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 💸 执行底层代币转移操作</span></span><br><span class="line">        <span class="comment">// 从ETF托管账户转移到用户账户 - 这与购买时的方向相反</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// SPL Token程序</span></span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: from_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 转出账户（ETF托管）</span></span><br><span class="line">                    to: to_ata.<span class="title function_ invoke__">to_account_info</span>(),              <span class="comment">// 转入账户（用户）</span></span><br><span class="line">                    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// 转移授权者（ETF PDA）</span></span><br><span class="line">                &#125;,</span><br><span class="line">                signer_seeds  <span class="comment">// PDA签名，证明ETF合约有权限转移托管资产</span></span><br><span class="line">            ),</span><br><span class="line">            amount,  <span class="comment">// 转移数量</span></span><br><span class="line">        )?;</span><br><span class="line"></span><br><span class="line">        msg!(<span class="string">&quot;✅ Successfully transferred &#123;&#125; units of token &#123;&#125; from ETF to user&quot;</span>, </span><br><span class="line">             amount, x.token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔥 销毁用户的ETF代币</span></span><br><span class="line">    <span class="comment">// 这是赎回过程的最后一步，确保ETF代币供应量的正确性</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),   <span class="comment">// SPL Token程序</span></span><br><span class="line">            Burn &#123;</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// ETF代币mint</span></span><br><span class="line">                from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 用户的ETF代币账户</span></span><br><span class="line">                authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 销毁授权者（用户）</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        lamports,  <span class="comment">// 销毁的ETF代币数量</span></span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;🔥 Successfully burned &#123;&#125; ETF tokens from user account &#123;&#125;&quot;</span>, </span><br><span class="line">         lamports, ctx.accounts.etf_token_ata.<span class="title function_ invoke__">key</span>());</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>核心逻辑解析</strong>：</p>
<h3 id="1-权限模型对比"><a href="#1-权限模型对比" class="headerlink" title="1. 权限模型对比"></a>1. 权限模型对比</h3><p><strong>购买时的权限流</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 购买：用户授权转移底层代币</span></span><br><span class="line">Transfer &#123;</span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// 用户签名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 购买：PDA授权铸造ETF代币  </span></span><br><span class="line">MintTo &#123;</span><br><span class="line">    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// PDA签名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>赎回时的权限流</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赎回：PDA授权转移托管资产</span></span><br><span class="line">Transfer &#123;</span><br><span class="line">    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// PDA签名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 赎回：用户授权销毁ETF代币</span></span><br><span class="line">Burn &#123;</span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// 用户签名  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-资产流向对比"><a href="#2-资产流向对比" class="headerlink" title="2. 资产流向对比"></a>2. 资产流向对比</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">购买流程：</span><br><span class="line">用户USDC账户 → ETF托管USDC账户</span><br><span class="line">用户SOL账户  → ETF托管SOL账户</span><br><span class="line">无          → 用户ETF代币账户</span><br><span class="line"></span><br><span class="line">赎回流程：</span><br><span class="line">ETF托管USDC账户 → 用户USDC账户</span><br><span class="line">ETF托管SOL账户  → 用户SOL账户  </span><br><span class="line">用户ETF代币账户 → 销毁</span><br></pre></td></tr></table></figure>

<h3 id="3-PDA签名机制深度解析"><a href="#3-PDA签名机制深度解析" class="headerlink" title="3. PDA签名机制深度解析"></a>3. PDA签名机制深度解析</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">    EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// 类型标识符</span></span><br><span class="line">    m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// 绑定特定ETF</span></span><br><span class="line">    &amp;[ctx.bumps.etf_token_info],        <span class="comment">// 确保地址唯一性</span></span><br><span class="line">]];</span><br></pre></td></tr></table></figure>

<p><strong>为什么需要PDA签名</strong>：</p>
<ul>
<li>ETF合约需要能够控制托管的底层资产</li>
<li>只有正确的PDA才能代表ETF合约执行转移操作</li>
<li>防止恶意合约或用户盗取托管资产</li>
</ul>
<h3 id="4-数量计算验证"><a href="#4-数量计算验证" class="headerlink" title="4. 数量计算验证"></a>4. 数量计算验证</h3><p><strong>赎回数量计算示例</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">用户赎回 1000个ETF代币，ETF组成为：</span><br><span class="line">- SOL (权重40%): 返还 40 * 1000 / 100 = 400个SOL</span><br><span class="line">- USDC (权重30%): 返还 30 * 1000 / 100 = 300个USDC</span><br><span class="line">- BTC (权重20%): 返还 20 * 1000 / 100 = 200个BTC  </span><br><span class="line">- ETH (权重10%): 返还 10 * 1000 / 100 = 100个ETH</span><br><span class="line"></span><br><span class="line">验证: 40% + 30% + 20% + 10% = 100% ✓</span><br></pre></td></tr></table></figure>

<h2 id="步骤2-注册ETF赎回指令"><a href="#步骤2-注册ETF赎回指令" class="headerlink" title="步骤2: 注册ETF赎回指令"></a>步骤2: 注册ETF赎回指令</h2><p><strong>目的</strong>：在主程序中暴露ETF赎回功能的公共接口。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/programs/counter/src/lib.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 🔥 ETF代币赎回的公共接口</span></span><br><span class="line"><span class="comment">// 这个函数暴露给客户端，用于赎回ETF代币并获得底层资产</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// 要赎回的ETF代币数量</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 调用具体的业务逻辑实现</span></span><br><span class="line">    <span class="comment">// 保持接口简洁，将复杂逻辑封装在独立模块中</span></span><br><span class="line">    instructions::<span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口设计考虑</strong>：</p>
<h3 id="1-复用账户结构"><a href="#1-复用账户结构" class="headerlink" title="1. 复用账户结构"></a>1. 复用账户结构</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赎回和购买使用相同的账户结构体</span></span><br><span class="line">Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>：</p>
<ul>
<li><strong>代码复用</strong>：减少重复的账户定义</li>
<li><strong>一致性</strong>：保持购买和赎回操作的一致性</li>
<li><strong>维护性</strong>：只需要维护一套账户验证逻辑</li>
</ul>
<h3 id="2-参数简化"><a href="#2-参数简化" class="headerlink" title="2. 参数简化"></a>2. 参数简化</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lamports: <span class="type">u64</span>,  <span class="comment">// 单一参数，简化接口</span></span><br></pre></td></tr></table></figure>

<p><strong>设计理念</strong>：</p>
<ul>
<li>用户只需要指定要赎回的ETF数量</li>
<li>底层资产的分配由程序自动计算</li>
<li>减少用户操作的复杂性</li>
</ul>
<h2 id="步骤3-客户端赎回实现"><a href="#步骤3-客户端赎回实现" class="headerlink" title="步骤3: 客户端赎回实现"></a>步骤3: 客户端赎回实现</h2><p><strong>目的</strong>：提供完整的客户端调用示例，处理账户管理和交易发送。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/example/api/etf_token.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&quot;./const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">BN</span> &#125; <span class="keyword">from</span> <span class="string">&quot;bn.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@solana/web3.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getAssociatedTokenAddressSync &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/spl-token&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; deriveEtfokenInfoAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./address&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🔥 ETF代币赎回的完整客户端实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurn</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,      <span class="comment">// 用户钱包</span></span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,      <span class="comment">// ETF代币的mint地址</span></span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span>,           <span class="comment">// 赎回数量（最小单位）</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 📍 派生ETF信息账户地址</span></span><br><span class="line">    <span class="comment">// 使用确定性算法生成ETF配置信息的存储地址</span></span><br><span class="line">    <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(etfAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📖 获取ETF配置信息</span></span><br><span class="line">    <span class="comment">// 从链上读取ETF的组成代币和权重配置</span></span><br><span class="line">    <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📊 ETF Configuration for redemption:&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">constituent</span>: etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> (&#123;</span><br><span class="line">            <span class="attr">token</span>: c.<span class="property">token</span>.<span class="title function_">toString</span>(),</span><br><span class="line">            <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">        &#125;)),</span><br><span class="line">        <span class="attr">totalConstituents</span>: etfInfo.<span class="property">constituent</span>.<span class="property">length</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📝 构建剩余账户列表</span></span><br><span class="line">    <span class="comment">// 包含所有底层代币的用户账户和ETF托管账户</span></span><br><span class="line">    <span class="comment">// 注意：顺序很重要！必须与程序中的处理顺序一致</span></span><br><span class="line">    <span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment">// 用户的底层代币接收账户（赎回时接收返还的代币）</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">            <span class="comment">// ETF合约的底层代币托管账户（赎回时转出代币的源账户）</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">        ]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📋 Remaining accounts for redemption:&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">totalAccounts</span>: remainingAccounts.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">accountsPerToken</span>: <span class="number">2</span>, <span class="comment">// 每个代币需要2个账户：用户账户 + ETF托管账户</span></span><br><span class="line">        <span class="attr">expectedPairs</span>: etfInfo.<span class="property">constituent</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🛠️ 构建ETF赎回指令</span></span><br><span class="line">    <span class="keyword">const</span> ix = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">        .<span class="title function_">etfTokenBurn</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(lamports))           <span class="comment">// 赎回数量</span></span><br><span class="line">        .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">            <span class="attr">etfTokenMintAccount</span>: etfAddress,      <span class="comment">// ETF代币mint地址</span></span><br><span class="line">            <span class="comment">// authority会自动从钱包推断，无需手动指定</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">remainingAccounts</span>(</span><br><span class="line">            <span class="comment">// 添加所有底层代币相关账户</span></span><br><span class="line">            remainingAccounts.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123; </span><br><span class="line">                <span class="attr">pubkey</span>: item, </span><br><span class="line">                <span class="attr">isWritable</span>: <span class="literal">true</span>,    <span class="comment">// 需要写入权限（转移代币）</span></span><br><span class="line">                <span class="attr">isSigner</span>: <span class="literal">false</span>      <span class="comment">// 不需要签名（由PDA或用户签名）</span></span><br><span class="line">            &#125;)),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">transaction</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ⚡ 设置计算单元限制</span></span><br><span class="line">    <span class="comment">// ETF赎回涉及多个代币转移和代币销毁，需要足够的计算资源</span></span><br><span class="line">    <span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">        <span class="attr">units</span>: <span class="number">400_000</span>,  <span class="comment">// 40万计算单元，足够处理复杂的多代币操作</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📦 构建并发送最终交易</span></span><br><span class="line">    <span class="keyword">const</span> tx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>().<span class="title function_">add</span>(ix).<span class="title function_">add</span>(modifyComputeUnits);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀 Sending ETF redemption transaction...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送交易并等待确认</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">        provider.<span class="property">connection</span>,</span><br><span class="line">        tx,</span><br><span class="line">        [wallet.<span class="property">payer</span>]  <span class="comment">// 交易签名者</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端实现要点</strong>：</p>
<h3 id="1-账户顺序的重要性"><a href="#1-账户顺序的重要性" class="headerlink" title="1. 账户顺序的重要性"></a>1. 账户顺序的重要性</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关键：账户顺序必须与程序中的处理逻辑一致</span></span><br><span class="line"><span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="comment">// 第一个：用户账户（接收返还代币）</span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="comment">// 第二个：ETF托管账户（转出代币）  </span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>程序端对应的处理</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 程序中的账户查找逻辑必须与客户端顺序匹配</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">from_ata</span> = accounts.<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">    &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ETF托管账户</span></span><br><span class="line">    &amp;x.token,</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">to_ata</span> = accounts.<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">    &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),       <span class="comment">// 用户账户</span></span><br><span class="line">    &amp;x.token,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<h3 id="2-错误预防机制"><a href="#2-错误预防机制" class="headerlink" title="2. 错误预防机制"></a>2. 错误预防机制</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加余额检查</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkUserEtfBalance</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">requiredAmount</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; requiredAmount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Insufficient ETF balance. Required: <span class="subst">$&#123;requiredAmount&#125;</span>, Available: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ Sufficient ETF balance: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETF token account not found or insufficient balance: <span class="subst">$&#123;e&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在赎回前调用检查</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">checkUserEtfBalance</span>(wallet, etfAddress, lamports);</span><br></pre></td></tr></table></figure>

<h3 id="3-账户存在性验证"><a href="#3-账户存在性验证" class="headerlink" title="3. 账户存在性验证"></a>3. 账户存在性验证</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加用户底层代币账户检查</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ensureUserTokenAccounts</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">constituents</span>: <span class="built_in">any</span>[]</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> setupTx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> constituents) &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建用户的底层代币接收账户</span></span><br><span class="line">                setupTx.<span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">createAssociatedTokenAccountInstruction</span>(</span><br><span class="line">                        wallet.<span class="property">payer</span>.<span class="property">publicKey</span>,</span><br><span class="line">                        userAta,</span><br><span class="line">                        wallet.<span class="property">publicKey</span>,</span><br><span class="line">                        token,</span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (setupTx.<span class="property">instructions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">            provider.<span class="property">connection</span>,</span><br><span class="line">            setupTx,</span><br><span class="line">            [wallet.<span class="property">payer</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="步骤4-完整赎回流程示例"><a href="#步骤4-完整赎回流程示例" class="headerlink" title="步骤4: 完整赎回流程示例"></a>步骤4: 完整赎回流程示例</h2><p><strong>目的</strong>：展示从ETF创建到赎回的完整使用流程。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/example/index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; deriveEtfTokenMintAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./api/address&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useDefaultWallet, useVisitorWallet &#125; <span class="keyword">from</span> <span class="string">&quot;./api/const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createTokenMintAccount, etfTokenMint, etfTokenBurn &#125; <span class="keyword">from</span> <span class="string">&quot;./api/etf_token&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span>;</span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 🔑 初始化钱包</span></span><br><span class="line">    <span class="keyword">const</span> defaultWallet = <span class="title function_">useDefaultWallet</span>();  <span class="comment">// ETF管理者钱包</span></span><br><span class="line">    <span class="keyword">const</span> visitorWallet = <span class="title function_">useVisitorWallet</span>();  <span class="comment">// ETF用户钱包</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📋 定义ETF参数</span></span><br><span class="line">    <span class="keyword">const</span> [name, <span class="built_in">symbol</span>, description, url] = [</span><br><span class="line">        <span class="string">&quot;yama4&quot;</span>,                    <span class="comment">// ETF名称</span></span><br><span class="line">        <span class="string">&quot;YAMA4&quot;</span>,                   <span class="comment">// ETF符号</span></span><br><span class="line">        <span class="string">&quot;yama4 description&quot;</span>,       <span class="comment">// ETF描述</span></span><br><span class="line">        <span class="string">&quot;https://note-public-img.oss-cn-beijing.aliyuncs.com/nya/nya.json&quot;</span>  <span class="comment">// 元数据URL</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🏗️ ETF创建示例（注释状态，演示用）</span></span><br><span class="line">    <span class="comment">// 创建一个包含两种底层代币的ETF，权重分别为20%和80%</span></span><br><span class="line">    <span class="comment">// const r1 = await createTokenMintAccount(</span></span><br><span class="line">    <span class="comment">//     defaultWallet,</span></span><br><span class="line">    <span class="comment">//     name,</span></span><br><span class="line">    <span class="comment">//     symbol,</span></span><br><span class="line">    <span class="comment">//     description,</span></span><br><span class="line">    <span class="comment">//     url,</span></span><br><span class="line">    <span class="comment">//     [</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // 底层代币1：权重20%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;4NQZAkYZdWZNBYW1JCoDgjZn9So1GaVz7wu3WLRUup7e&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 20,</span></span><br><span class="line">    <span class="comment">//         &#125;,</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // 底层代币2：权重80%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;7mVM7bRnnHNVoLUT6HL8pq2NoLBi84dm2JtwSCqdPgLm&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 80,</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     ]</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🎯 获取ETF地址</span></span><br><span class="line">    <span class="comment">// 使用符号派生ETF mint账户地址</span></span><br><span class="line">    <span class="keyword">const</span> [etf,] = <span class="title function_">deriveEtfTokenMintAccount</span>(<span class="built_in">symbol</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🏷️ ETF Address: <span class="subst">$&#123;etf&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 💰 购买ETF代币（注释状态，演示完整流程）</span></span><br><span class="line">    <span class="comment">// 先购买600,000,000个最小单位的ETF代币</span></span><br><span class="line">    <span class="comment">// const r2 = await etfTokenMint(</span></span><br><span class="line">    <span class="comment">//     defaultWallet,      // 购买者钱包</span></span><br><span class="line">    <span class="comment">//     etf,               // ETF代币地址</span></span><br><span class="line">    <span class="comment">//     600000000          // 购买数量（lamports）</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line">    <span class="comment">// console.log(`✅ ETF Mint Transaction: $&#123;r2&#125;`);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔥 执行ETF赎回</span></span><br><span class="line">    <span class="comment">// 赎回600,000,000个最小单位的ETF代币，获得对应的底层资产</span></span><br><span class="line">    <span class="keyword">const</span> r3 = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(</span><br><span class="line">        defaultWallet,      <span class="comment">// 赎回者钱包</span></span><br><span class="line">        etf,               <span class="comment">// ETF代币地址  </span></span><br><span class="line">        <span class="number">600000000</span>          <span class="comment">// 赎回数量（lamports）</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🔥 ETF Burn Transaction: <span class="subst">$&#123;r3&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 📊 交易完成后的状态检查建议</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📋 Transaction completed. Recommended next steps:&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1. Check user&#x27;s bottom token balances&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2. Verify ETF token balance reduction&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3. Confirm ETF total supply decrease&quot;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p><strong>完整流程时间线</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1️⃣ 创建ETF</span><br><span class="line">   ├── 定义底层代币组合 (如: SOL 40%, USDC 60%)</span><br><span class="line">   ├── 设置ETF元数据 (名称、符号、描述)</span><br><span class="line">   └── 部署ETF合约</span><br><span class="line"></span><br><span class="line">2️⃣ 购买ETF (用户积累ETF代币)</span><br><span class="line">   ├── 用户提供底层代币 (400 SOL + 600 USDC)</span><br><span class="line">   ├── 底层代币转入ETF托管</span><br><span class="line">   └── 用户收到 1000 个ETF代币</span><br><span class="line"></span><br><span class="line">3️⃣ 赎回ETF (本教程重点)</span><br><span class="line">   ├── 用户提交赎回请求 (赎回 500 个ETF代币)</span><br><span class="line">   ├── ETF合约返还底层资产 (200 SOL + 300 USDC)</span><br><span class="line">   └── 销毁对应的ETF代币 (500 个)</span><br><span class="line"></span><br><span class="line">4️⃣ 结果验证</span><br><span class="line">   ├── 用户余额: 500 个ETF + 200 SOL + 300 USDC  </span><br><span class="line">   ├── ETF托管余额: 200 SOL + 300 USDC</span><br><span class="line">   └── ETF总供应量: 减少 500 个</span><br></pre></td></tr></table></figure>

<h2 id="技术深度解析"><a href="#技术深度解析" class="headerlink" title="技术深度解析"></a>技术深度解析</h2><h3 id="1-赎回操作的原子性保障"><a href="#1-赎回操作的原子性保障" class="headerlink" title="1. 赎回操作的原子性保障"></a>1. 赎回操作的原子性保障</h3><h4 id="A-事务完整性"><a href="#A-事务完整性" class="headerlink" title="A. 事务完整性"></a>A. 事务完整性</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有操作在单一事务中完成，要么全部成功，要么全部失败</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">    <span class="comment">// 转移底层资产给用户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// 如果任何一个转移失败，整个交易回滚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 销毁ETF代币</span></span><br><span class="line"><span class="title function_ invoke__">burn</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// 如果销毁失败，整个交易回滚</span></span><br></pre></td></tr></table></figure>

<h4 id="B-状态一致性"><a href="#B-状态一致性" class="headerlink" title="B. 状态一致性"></a>B. 状态一致性</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">成功场景：</span><br><span class="line">- 所有底层资产都成功转移给用户 ✓</span><br><span class="line">- ETF代币成功销毁 ✓</span><br><span class="line">- ETF总供应量正确减少 ✓</span><br><span class="line"></span><br><span class="line">失败场景：</span><br><span class="line">- 任何底层资产转移失败 → 整个交易回滚 ✓</span><br><span class="line">- ETF代币销毁失败 → 整个交易回滚 ✓</span><br><span class="line">- 用户不会损失任何资产 ✓</span><br></pre></td></tr></table></figure>

<h3 id="2-权限验证机制深度分析"><a href="#2-权限验证机制深度分析" class="headerlink" title="2. 权限验证机制深度分析"></a>2. 权限验证机制深度分析</h3><h4 id="A-PDA权限控制"><a href="#A-PDA权限控制" class="headerlink" title="A. PDA权限控制"></a>A. PDA权限控制</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETF合约通过PDA控制托管资产</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">    EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// 类型标识</span></span><br><span class="line">    m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// ETF特定标识</span></span><br><span class="line">    &amp;[ctx.bumps.etf_token_info],        <span class="comment">// 唯一性保证</span></span><br><span class="line">]];</span><br></pre></td></tr></table></figure>

<p><strong>安全性保障</strong>：</p>
<ul>
<li>只有正确的ETF程序实例才能生成有效的PDA签名</li>
<li>防止恶意程序盗取托管资产</li>
<li>确保每个ETF的资产隔离</li>
</ul>
<h4 id="B-用户权限验证"><a href="#B-用户权限验证" class="headerlink" title="B. 用户权限验证"></a>B. 用户权限验证</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户必须拥有足够的ETF代币才能赎回</span></span><br><span class="line">Burn &#123;</span><br><span class="line">    from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 用户的ETF账户</span></span><br><span class="line">    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 用户签名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>验证层次</strong>：</p>
<ol>
<li><strong>签名验证</strong>：确认是代币所有者发起的操作</li>
<li><strong>余额验证</strong>：SPL Token自动检查是否有足够余额</li>
<li><strong>账户验证</strong>：确认操作的是正确的代币账户</li>
</ol>
<h3 id="3-数量计算的精确性"><a href="#3-数量计算的精确性" class="headerlink" title="3. 数量计算的精确性"></a>3. 数量计算的精确性</h3><h4 id="A-权重计算公式"><a href="#A-权重计算公式" class="headerlink" title="A. 权重计算公式"></a>A. 权重计算公式</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h4 id="B-精度处理考虑"><a href="#B-精度处理考虑" class="headerlink" title="B. 精度处理考虑"></a>B. 精度处理考虑</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">潜在问题：整数除法可能导致精度丢失</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">- 用户赎回 1000 个ETF代币  </span><br><span class="line">- 某代币权重 33%</span><br><span class="line">- 计算: 33 * 1000 / 100 = 330 ✓</span><br><span class="line"></span><br><span class="line">边界情况：</span><br><span class="line">- 用户赎回 100 个ETF代币</span><br><span class="line">- 某代币权重 33%  </span><br><span class="line">- 计算: 33 * 100 / 100 = 33 ✓</span><br><span class="line"></span><br><span class="line">极端情况：</span><br><span class="line">- 用户赎回 10 个ETF代币</span><br><span class="line">- 某代币权重 33%</span><br><span class="line">- 计算: 33 * 10 / 100 = 3.3 → 3 (精度丢失)</span><br></pre></td></tr></table></figure>

<h4 id="C-精度优化建议"><a href="#C-精度优化建议" class="headerlink" title="C. 精度优化建议"></a>C. 精度优化建议</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议使用更高精度的计算</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redeem_amount</span>(weight: <span class="type">u32</span>, lamports: <span class="type">u64</span>, precision: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    <span class="comment">// 使用更大的精度基数，如10000而不是100</span></span><br><span class="line">    weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / precision</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例：权重3300表示33%，基数10000</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">amount</span> = <span class="title function_ invoke__">calculate_redeem_amount</span>(<span class="number">3300</span>, lamports, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-错误处理机制"><a href="#4-错误处理机制" class="headerlink" title="4. 错误处理机制"></a>4. 错误处理机制</h3><h4 id="A-常见错误类型"><a href="#A-常见错误类型" class="headerlink" title="A. 常见错误类型"></a>A. 常见错误类型</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 账户相关错误</span></span><br><span class="line">TokenMintError::InvalidAccounts    <span class="comment">// 账户地址不匹配或丢失</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 余额相关错误（SPL Token自动检查）</span></span><br><span class="line"><span class="comment">// - InsufficientBalance: ETF代币余额不足</span></span><br><span class="line"><span class="comment">// - InsufficientFunds: 托管账户底层资产不足</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 权限相关错误（Anchor自动检查）</span></span><br><span class="line"><span class="comment">// - Unauthorized: 签名验证失败</span></span><br><span class="line"><span class="comment">// - ConstraintRaw: 账户约束验证失败</span></span><br></pre></td></tr></table></figure>

<h4 id="B-错误恢复策略"><a href="#B-错误恢复策略" class="headerlink" title="B. 错误恢复策略"></a>B. 错误恢复策略</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端错误处理和重试机制</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurnWithRetry</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">maxRetries</span>: <span class="built_in">number</span> = <span class="number">3</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> attempt = <span class="number">1</span>; attempt &lt;= maxRetries; attempt++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`❌ Attempt <span class="subst">$&#123;attempt&#125;</span> failed:`</span>, error.<span class="property">message</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;TokenAccountNotFoundError&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 创建缺失的用户代币接收账户</span></span><br><span class="line">                <span class="keyword">await</span> <span class="title function_">ensureUserTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// 重试</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;InsufficientBalance&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`用户ETF余额不足，无法赎回<span class="subst">$&#123;lamports&#125;</span>个代币`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (attempt === maxRetries) &#123;</span><br><span class="line">                <span class="keyword">throw</span> error; <span class="comment">// 最后一次尝试失败，抛出原始错误</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 等待一段时间后重试</span></span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span> * attempt));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-性能优化策略"><a href="#5-性能优化策略" class="headerlink" title="5. 性能优化策略"></a>5. 性能优化策略</h3><h4 id="A-批量操作优化"><a href="#A-批量操作优化" class="headerlink" title="A. 批量操作优化"></a>A. 批量操作优化</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实现：逐个处理每个底层代币</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// 每个代币一个CPI调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化建议：考虑批量转移（需要自定义实现）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">batch_transfer_constituent_tokens</span>(</span><br><span class="line">    ctx: &amp;Context&lt;EtfTokenTransaction&gt;,</span><br><span class="line">    amounts: &amp;[<span class="type">u64</span>],</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 批量处理多个转移操作，减少CPI调用开销</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-计算单元动态调整"><a href="#B-计算单元动态调整" class="headerlink" title="B. 计算单元动态调整"></a>B. 计算单元动态调整</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据ETF复杂度动态计算所需计算单元</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">calculateComputeUnits</span> = (<span class="params"><span class="attr">constituentCount</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseUnits = <span class="number">150_000</span>;        <span class="comment">// 基础操作单元</span></span><br><span class="line">    <span class="keyword">const</span> perTokenUnits = <span class="number">50_000</span>;     <span class="comment">// 每个底层代币的额外单元</span></span><br><span class="line">    <span class="keyword">const</span> burnUnits = <span class="number">25_000</span>;         <span class="comment">// 代币销毁操作单元</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(</span><br><span class="line">        <span class="number">1_400_000</span>,  <span class="comment">// Solana最大限制</span></span><br><span class="line">        baseUnits + (constituentCount * perTokenUnits) + burnUnits</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用动态计算的计算单元</span></span><br><span class="line"><span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line"><span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">    <span class="attr">units</span>: computeUnits,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="C-账户预取优化"><a href="#C-账户预取优化" class="headerlink" title="C. 账户预取优化"></a>C. 账户预取优化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预取所有相关账户信息，减少RPC调用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">preloadAccountInfo</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">addresses</span>: <span class="title class_">PublicKey</span>[]</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> accountInfos = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getMultipleAccountsInfo</span>(addresses);</span><br><span class="line">    <span class="keyword">return</span> addresses.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, addr, index</span>) =&gt;</span> &#123;</span><br><span class="line">        acc[addr.<span class="title function_">toString</span>()] = accountInfos[index];</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;, &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">AccountInfo</span>&lt;<span class="title class_">Buffer</span>&gt; | <span class="literal">null</span>&gt;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="安全性考虑与最佳实践"><a href="#安全性考虑与最佳实践" class="headerlink" title="安全性考虑与最佳实践"></a>安全性考虑与最佳实践</h2><h3 id="1-重入攻击防护"><a href="#1-重入攻击防护" class="headerlink" title="1. 重入攻击防护"></a>1. 重入攻击防护</h3><h4 id="A-状态检查顺序"><a href="#A-状态检查顺序" class="headerlink" title="A. 状态检查顺序"></a>A. 状态检查顺序</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确的操作顺序：先检查，后修改状态</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_secure</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. 预先验证所有条件</span></span><br><span class="line">    require!(lamports &gt; <span class="number">0</span>, TokenMintError::InvalidAmount);</span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">len</span>() &gt; <span class="number">0</span>,</span><br><span class="line">        TokenMintError::EmptyConstituent</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 执行所有转移操作</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 最后销毁ETF代币（不可逆操作）</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(<span class="comment">/* ... */</span>)?;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-状态一致性检查"><a href="#B-状态一致性检查" class="headerlink" title="B. 状态一致性检查"></a>B. 状态一致性检查</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加的状态验证</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_state</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// 验证权重总和</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">total_weight</span>: <span class="type">u32</span> = <span class="keyword">self</span>.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|c| c.weight).<span class="title function_ invoke__">sum</span>();</span><br><span class="line">        require!(total_weight == <span class="number">100</span>, TokenMintError::InvalidWeightSum);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证没有重复的代币</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">seen_tokens</span> = std::collections::HashSet::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.constituent &#123;</span><br><span class="line">            require!(</span><br><span class="line">                seen_tokens.<span class="title function_ invoke__">insert</span>(constituent.token),</span><br><span class="line">                TokenMintError::DuplicateToken</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-价格操纵防护"><a href="#2-价格操纵防护" class="headerlink" title="2. 价格操纵防护"></a>2. 价格操纵防护</h3><h4 id="A-赎回限制机制"><a href="#A-赎回限制机制" class="headerlink" title="A. 赎回限制机制"></a>A. 赎回限制机制</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加的赎回限制</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfRedemptionLimits</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> min_redemption: <span class="type">u64</span>,        <span class="comment">// 最小赎回量</span></span><br><span class="line">    <span class="keyword">pub</span> max_redemption_per_tx: <span class="type">u64</span>, <span class="comment">// 单次最大赎回量</span></span><br><span class="line">    <span class="keyword">pub</span> daily_redemption_limit: <span class="type">u64</span>,<span class="comment">// 日赎回限制</span></span><br><span class="line">    <span class="keyword">pub</span> redemption_fee_bps: <span class="type">u16</span>,    <span class="comment">// 赎回费用（基点）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_limits</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    limits: &amp;EtfRedemptionLimits,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 验证赎回限制</span></span><br><span class="line">    require!(lamports &gt;= limits.min_redemption, TokenMintError::BelowMinRedemption);</span><br><span class="line">    require!(lamports &lt;= limits.max_redemption_per_tx, TokenMintError::ExceedsMaxRedemption);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算并收取赎回费用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = lamports * limits.redemption_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">net_redemption</span> = lamports - fee;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行赎回逻辑</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, net_redemption)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-价格验证机制"><a href="#B-价格验证机制" class="headerlink" title="B. 价格验证机制"></a>B. 价格验证机制</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集成价格预言机验证</span></span><br><span class="line"><span class="keyword">use</span> pyth_solana_receiver_sdk::price_update::PriceUpdateV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_price_check</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithOracle&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    max_price_deviation_bps: <span class="type">u16</span>, <span class="comment">// 最大价格偏差</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 验证底层资产价格的合理性</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total_value</span> = <span class="number">0u64</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i, constituent) <span class="keyword">in</span> ctx.accounts.etf_token_info.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="comment">// 获取价格数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_feed</span> = &amp;ctx.remaining_accounts[i];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_update</span> = PriceUpdateV2::<span class="title function_ invoke__">try_deserialize</span>(&amp;<span class="keyword">mut</span> price_feed.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算该代币的价值</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">token_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">token_value</span> = token_amount * price_update.price <span class="keyword">as</span> <span class="type">u64</span>;</span><br><span class="line">        total_value += token_value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证总价值与ETF价格的一致性</span></span><br><span class="line">    <span class="comment">// 实际实现需要ETF本身的价格数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行标准赎回流程</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">into</span>(), lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-流动性风险管理"><a href="#3-流动性风险管理" class="headerlink" title="3. 流动性风险管理"></a>3. 流动性风险管理</h3><h4 id="A-托管资产充足性检查"><a href="#A-托管资产充足性检查" class="headerlink" title="A. 托管资产充足性检查"></a>A. 托管资产充足性检查</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在赎回前验证托管资产是否充足</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_custody_balances</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: &amp;Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">required_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取ETF托管账户余额</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">custody_ata</span> = <span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">            &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">            &amp;constituent.token,</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里需要实际获取账户余额进行验证</span></span><br><span class="line">        <span class="comment">// let custody_balance = get_account_balance(custody_ata)?;</span></span><br><span class="line">        <span class="comment">// require!(custody_balance &gt;= required_amount, TokenMintError::InsufficientCustodyBalance);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-紧急暂停机制"><a href="#B-紧急暂停机制" class="headerlink" title="B. 紧急暂停机制"></a>B. 紧急暂停机制</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETF状态管理</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> mint_account: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> constituent: <span class="type">Vec</span>&lt;EtfTokenConstituent&gt;,</span><br><span class="line">    <span class="keyword">pub</span> is_paused: <span class="type">bool</span>,           <span class="comment">// 紧急暂停标志</span></span><br><span class="line">    <span class="keyword">pub</span> emergency_admin: Pubkey,   <span class="comment">// 紧急管理员</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 紧急暂停赎回</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">emergency_pause_redemption</span>(</span><br><span class="line">    ctx: Context&lt;EmergencyPause&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">key</span>() == ctx.accounts.etf_token_info.emergency_admin,</span><br><span class="line">        TokenMintError::UnauthorizedEmergencyAction</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.etf_token_info.is_paused = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    msg!(<span class="string">&quot;🚨 ETF redemption has been emergency paused&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在赎回函数中检查暂停状态</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_pause_check</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    require!(!ctx.accounts.etf_token_info.is_paused, TokenMintError::RedemptionPaused);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="扩展功能建议"><a href="#扩展功能建议" class="headerlink" title="扩展功能建议"></a>扩展功能建议</h2><h3 id="1-部分赎回与完整赎回"><a href="#1-部分赎回与完整赎回" class="headerlink" title="1. 部分赎回与完整赎回"></a>1. 部分赎回与完整赎回</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 部分赎回：用户指定赎回数量</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">partial_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// 部分赎回数量</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 按比例返还底层资产</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 完整赎回：赎回用户持有的所有ETF代币</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">full_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取用户的ETF代币余额</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_balance</span> = ctx.accounts.etf_token_ata.amount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 赎回全部余额</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, user_balance)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-延迟赎回机制"><a href="#2-延迟赎回机制" class="headerlink" title="2. 延迟赎回机制"></a>2. 延迟赎回机制</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延迟赎回状态</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PendingRedemption</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> request_time: <span class="type">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> execution_time: <span class="type">i64</span>,  <span class="comment">// 预计执行时间</span></span><br><span class="line">    <span class="keyword">pub</span> is_executed: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交赎回请求</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">request_redemption</span>(</span><br><span class="line">    ctx: Context&lt;RequestRedemption&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    delay_seconds: <span class="type">i64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_time</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.pending_redemption.<span class="title function_ invoke__">set_inner</span>(PendingRedemption &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount: lamports,</span><br><span class="line">        request_time: current_time,</span><br><span class="line">        execution_time: current_time + delay_seconds,</span><br><span class="line">        is_executed: <span class="literal">false</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    msg!(<span class="string">&quot;📋 Redemption request submitted, will execute at: &#123;&#125;&quot;</span>, current_time + delay_seconds);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行延迟赎回</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">execute_pending_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_time</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pending</span> = &amp;ctx.accounts.pending_redemption;</span><br><span class="line">    </span><br><span class="line">    require!(!pending.is_executed, TokenMintError::AlreadyExecuted);</span><br><span class="line">    require!(current_time &gt;= pending.execution_time, TokenMintError::TooEarly);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行赎回</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx, pending.amount)?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标记为已执行</span></span><br><span class="line">    ctx.accounts.pending_redemption.is_executed = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-赎回费用机制"><a href="#3-赎回费用机制" class="headerlink" title="3. 赎回费用机制"></a>3. 赎回费用机制</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 费用计算和收取</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_fees</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithFees&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    fee_recipient: Pubkey,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee_bps</span> = <span class="number">50</span>; <span class="comment">// 0.5% 赎回费</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee_amount</span> = lamports * fee_bps / <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">net_amount</span> = lamports - fee_amount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 收取费用：将费用对应的ETF代币转给费用接收者</span></span><br><span class="line">    <span class="keyword">if</span> fee_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    to: ctx.accounts.fee_recipient_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                &#125;,</span><br><span class="line">            ),</span><br><span class="line">            fee_amount,</span><br><span class="line">        )?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行净额赎回</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">into</span>(), net_amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-赎回历史记录"><a href="#4-赎回历史记录" class="headerlink" title="4. 赎回历史记录"></a>4. 赎回历史记录</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赎回记录结构</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RedemptionHistory</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_burned: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> underlying_assets: <span class="type">Vec</span>&lt;AssetRedemption&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(AnchorSerialize, AnchorDeserialize, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">AssetRedemption</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> token_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_received: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> weight_at_redemption: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录赎回历史</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_with_history</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenBurnWithHistory&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 执行标准赎回</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_burn</span>(ctx.accounts.<span class="title function_ invoke__">clone</span>().<span class="title function_ invoke__">into</span>(), lamports)?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录赎回历史</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">underlying_assets</span>: <span class="type">Vec</span>&lt;AssetRedemption&gt; = ctx.accounts.etf_token_info.constituent</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|c| AssetRedemption &#123;</span><br><span class="line">            token_mint: c.token,</span><br><span class="line">            amount_received: c.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>,</span><br><span class="line">            weight_at_redemption: c.weight,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    </span><br><span class="line">    ctx.accounts.redemption_history.<span class="title function_ invoke__">set_inner</span>(RedemptionHistory &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount_burned: lamports,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">        underlying_assets,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="故障排除指南"><a href="#故障排除指南" class="headerlink" title="故障排除指南"></a>故障排除指南</h2><h3 id="1-常见错误场景及解决方案"><a href="#1-常见错误场景及解决方案" class="headerlink" title="1. 常见错误场景及解决方案"></a>1. 常见错误场景及解决方案</h3><h4 id="A-“InvalidAccounts”-错误"><a href="#A-“InvalidAccounts”-错误" class="headerlink" title="A. “InvalidAccounts” 错误"></a>A. “InvalidAccounts” 错误</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：剩余账户顺序或地址不匹配</span></span><br><span class="line"><span class="comment">// 检查步骤：</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">debugAccountOrder</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">etfInfo</span>: <span class="built_in">any</span>, <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>, <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🔍 调试账户顺序:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    etfInfo.<span class="property">constituent</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`代币 <span class="subst">$&#123;index + <span class="number">1</span>&#125;</span> (<span class="subst">$&#123;item.token&#125;</span>):`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  用户ATA: <span class="subst">$&#123;userAta&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  ETF托管ATA: <span class="subst">$&#123;etfAta&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  权重: <span class="subst">$&#123;item.weight&#125;</span>%`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：确保账户顺序与程序期望一致</span></span><br><span class="line"><span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),      <span class="comment">// 用户账户</span></span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),  <span class="comment">// ETF托管账户</span></span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="B-“InsufficientBalance”-错误"><a href="#B-“InsufficientBalance”-错误" class="headerlink" title="B. “InsufficientBalance” 错误"></a>B. “InsufficientBalance” 错误</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题1：用户ETF代币余额不足</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkEtfBalance</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>, <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>, <span class="attr">required</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`📊 用户ETF余额: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`📊 需要赎回: <span class="subst">$&#123;required&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; required) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETF余额不足！需要: <span class="subst">$&#123;required&#125;</span>, 可用: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;❌ 获取ETF余额失败:&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;ETF代币账户不存在或无法访问&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 问题2：ETF托管账户底层资产不足</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkCustodyBalances</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">etfInfo</span>: <span class="built_in">any</span>, <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span>, <span class="attr">redeemAmount</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🔍 检查ETF托管账户余额:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> constituent <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(constituent.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> requiredAmount = constituent.<span class="property">weight</span> * redeemAmount / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`代币 <span class="subst">$&#123;constituent.token&#125;</span>:`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  托管余额: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  需要转出: <span class="subst">$&#123;requiredAmount&#125;</span>`</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (account.<span class="property">amount</span> &lt; requiredAmount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ETF托管资产不足！代币: <span class="subst">$&#123;constituent.token&#125;</span>, 需要: <span class="subst">$&#123;requiredAmount&#125;</span>, 可用: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`❌ 检查托管余额失败 (<span class="subst">$&#123;constituent.token&#125;</span>):`</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="C-“TokenAccountNotFoundError”-错误"><a href="#C-“TokenAccountNotFoundError”-错误" class="headerlink" title="C. “TokenAccountNotFoundError” 错误"></a>C. “TokenAccountNotFoundError” 错误</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：用户缺少底层代币接收账户</span></span><br><span class="line"><span class="comment">// 解决方案：自动创建缺失账户</span></span><br><span class="line"><span class="keyword">const</span> createMissingTokenAccounts = <span class="title function_">async</span> (</span><br><span class="line">    <span class="attr">wallet</span>: anchor.<span class="property">Wallet</span>, </span><br><span class="line">    <span class="attr">constituents</span>: <span class="built_in">any</span>[]</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span> | <span class="literal">null</span>&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> setupTx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>();</span><br><span class="line">    <span class="keyword">let</span> needsSetup = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> constituents) &#123;</span><br><span class="line">        <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ 用户代币账户已存在: <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🏗️ 需要创建代币账户: <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">                setupTx.<span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">createAssociatedTokenAccountInstruction</span>(</span><br><span class="line">                        wallet.<span class="property">payer</span>.<span class="property">publicKey</span>,  <span class="comment">// 付费者</span></span><br><span class="line">                        userAta,                 <span class="comment">// 要创建的账户</span></span><br><span class="line">                        wallet.<span class="property">publicKey</span>,        <span class="comment">// 账户所有者</span></span><br><span class="line">                        token,                   <span class="comment">// 代币mint</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">                needsSetup = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (needsSetup) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀 发送账户创建交易...&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> signature = <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">            provider.<span class="property">connection</span>,</span><br><span class="line">            setupTx,</span><br><span class="line">            [wallet.<span class="property">payer</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ 账户创建完成: <span class="subst">$&#123;signature&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> signature;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在赎回前调用</span></span><br><span class="line"><span class="keyword">const</span> setupSignature = <span class="keyword">await</span> <span class="title function_">createMissingTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line"><span class="keyword">if</span> (setupSignature) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;⏳ 等待账户创建确认...&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">2000</span>)); <span class="comment">// 等待确认</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-调试技巧与工具"><a href="#2-调试技巧与工具" class="headerlink" title="2. 调试技巧与工具"></a>2. 调试技巧与工具</h3><h4 id="A-交易日志分析"><a href="#A-交易日志分析" class="headerlink" title="A. 交易日志分析"></a>A. 交易日志分析</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 详细的交易执行和日志分析</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">executeRedemptionWithLogging</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀 开始执行ETF赎回...&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`📊 参数: ETF=<span class="subst">$&#123;etfAddress&#125;</span>, 数量=<span class="subst">$&#123;lamports&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> signature = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ 交易成功: <span class="subst">$&#123;signature&#125;</span>`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取详细的交易日志</span></span><br><span class="line">        <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">            <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">            <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (txDetails?.<span class="property">meta</span>?.<span class="property">logMessages</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📋 交易日志:&quot;</span>);</span><br><span class="line">            txDetails.<span class="property">meta</span>.<span class="property">logMessages</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">log, index</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  <span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>. <span class="subst">$&#123;log&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分析计算单元使用情况</span></span><br><span class="line">        <span class="keyword">if</span> (txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`⚡ 计算单元消耗: <span class="subst">$&#123;txDetails.meta.computeUnitsConsumed&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> signature;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;❌ 赎回失败:&quot;</span>, error);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 尝试解析Anchor错误</span></span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;0x&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> errorCode = error.<span class="property">message</span>.<span class="title function_">match</span>(<span class="regexp">/0x[0-9a-fA-F]+/</span>)?.[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🔍 错误代码: <span class="subst">$&#123;errorCode&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-状态验证工具"><a href="#B-状态验证工具" class="headerlink" title="B. 状态验证工具"></a>B. 状态验证工具</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赎回前后状态对比工具</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">captureEtfState</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> state = &#123;</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">        <span class="attr">userEtfBalance</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">userTokenBalances</span>: &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;,</span><br><span class="line">        <span class="attr">etfCustodyBalances</span>: &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户ETF余额</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        state.<span class="property">userEtfBalance</span> = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;用户ETF账户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户底层代币余额</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">            state.<span class="property">userTokenBalances</span>[token.<span class="title function_">toString</span>()] = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            state.<span class="property">userTokenBalances</span>[token.<span class="title function_">toString</span>()] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ETF托管余额</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">            state.<span class="property">etfCustodyBalances</span>[token.<span class="title function_">toString</span>()] = <span class="title class_">Number</span>(account.<span class="property">amount</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            state.<span class="property">etfCustodyBalances</span>[token.<span class="title function_">toString</span>()] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> stateBefore = <span class="keyword">await</span> <span class="title function_">captureEtfState</span>(wallet, etfAddress, etfCoreAddress, etfInfo);</span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> <span class="title function_">etfTokenBurn</span>(wallet, etfAddress, lamports);</span><br><span class="line"><span class="keyword">const</span> stateAfter = <span class="keyword">await</span> <span class="title function_">captureEtfState</span>(wallet, etfAddress, etfCoreAddress, etfInfo);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📊 状态对比:&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;赎回前:&quot;</span>, stateBefore);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;赎回后:&quot;</span>, stateAfter);</span><br></pre></td></tr></table></figure>

<h3 id="3-性能监控与优化"><a href="#3-性能监控与优化" class="headerlink" title="3. 性能监控与优化"></a>3. 性能监控与优化</h3><h4 id="A-交易成本分析"><a href="#A-交易成本分析" class="headerlink" title="A. 交易成本分析"></a>A. 交易成本分析</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 估算赎回交易的总成本</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">estimateRedemptionCost</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseFee = <span class="number">5000</span>; <span class="comment">// 基础交易费用 (lamports)</span></span><br><span class="line">    <span class="keyword">const</span> computeUnitPrice = <span class="number">1000</span>; <span class="comment">// 每计算单元价格 (micro-lamports)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算所需计算单元</span></span><br><span class="line">    <span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">const</span> computeFee = computeUnits * computeUnitPrice / <span class="number">1_000_000</span>; <span class="comment">// 转换为lamports</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 估算账户创建成本（如果需要）</span></span><br><span class="line">    <span class="keyword">let</span> accountCreationCost = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 这里应该检查哪些账户需要创建</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> totalCost = baseFee + computeFee + accountCreationCost;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;💰 交易成本估算:&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  基础费用: <span class="subst">$&#123;baseFee&#125;</span> lamports (<span class="subst">$&#123;baseFee / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  计算费用: <span class="subst">$&#123;computeFee&#125;</span> lamports (<span class="subst">$&#123;computeFee / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  账户创建: <span class="subst">$&#123;accountCreationCost&#125;</span> lamports (<span class="subst">$&#123;accountCreationCost / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  总成本: <span class="subst">$&#123;totalCost&#125;</span> lamports (<span class="subst">$&#123;totalCost / <span class="number">1e9</span>&#125;</span> SOL)`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> totalCost;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-批量赎回优化"><a href="#B-批量赎回优化" class="headerlink" title="B. 批量赎回优化"></a>B. 批量赎回优化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量处理多个用户的赎回请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">batchRedemption</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">redemptionRequests</span>: <span class="title class_">Array</span>&lt;&#123;</span></span><br><span class="line"><span class="params">        wallet: anchor.Wallet,</span></span><br><span class="line"><span class="params">        etfAddress: PublicKey,</span></span><br><span class="line"><span class="params">        amount: <span class="built_in">number</span></span></span><br><span class="line"><span class="params">    &#125;&gt;</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 按ETF地址分组，优化RPC调用</span></span><br><span class="line">    <span class="keyword">const</span> groupedRequests = redemptionRequests.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, req</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> key = req.<span class="property">etfAddress</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">if</span> (!acc[key]) acc[key] = [];</span><br><span class="line">        acc[key].<span class="title function_">push</span>(req);</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;, &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="keyword">typeof</span> redemptionRequests&gt;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [etfAddress, requests] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(groupedRequests)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🔄 处理ETF <span class="subst">$&#123;etfAddress&#125;</span> 的 <span class="subst">$&#123;requests.length&#125;</span> 个赎回请求`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 预加载ETF信息，避免重复查询</span></span><br><span class="line">        <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(<span class="keyword">new</span> <span class="title class_">PublicKey</span>(etfAddress));</span><br><span class="line">        <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 并行处理同一ETF的多个赎回请求</span></span><br><span class="line">        <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(</span><br><span class="line">            requests.<span class="title function_">map</span>(<span class="function"><span class="params">req</span> =&gt;</span> </span><br><span class="line">                <span class="title function_">etfTokenBurn</span>(req.<span class="property">wallet</span>, req.<span class="property">etfAddress</span>, req.<span class="property">amount</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        results.<span class="title function_">push</span>(...batchResults);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 统计结果</span></span><br><span class="line">    <span class="keyword">const</span> successful = results.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>).<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> failed = results.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">status</span> === <span class="string">&#x27;rejected&#x27;</span>).<span class="property">length</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`📊 批量赎回完成: 成功 <span class="subst">$&#123;successful&#125;</span>, 失败 <span class="subst">$&#123;failed&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="代码优化建议"><a href="#代码优化建议" class="headerlink" title="代码优化建议"></a>代码优化建议</h2><h3 id="1-Rust程序端优化"><a href="#1-Rust程序端优化" class="headerlink" title="1. Rust程序端优化"></a>1. Rust程序端优化</h3><h4 id="A-错误处理增强"><a href="#A-错误处理增强" class="headerlink" title="A. 错误处理增强"></a>A. 错误处理增强</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前代码的改进建议</span></span><br><span class="line"><span class="keyword">use</span> thiserror::Error;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Error, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">EtfRedemptionError</span> &#123;</span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Invalid account provided: &#123;account&#125;&quot;</span>)]</span></span><br><span class="line">    InvalidAccount &#123; account: <span class="type">String</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Insufficient ETF token balance: required &#123;required&#125;, available &#123;available&#125;&quot;</span>)]</span></span><br><span class="line">    InsufficientEtfBalance &#123; required: <span class="type">u64</span>, available: <span class="type">u64</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Insufficient custody balance for token &#123;token&#125;: required &#123;required&#125;, available &#123;available&#125;&quot;</span>)]</span></span><br><span class="line">    InsufficientCustodyBalance &#123; token: <span class="type">String</span>, required: <span class="type">u64</span>, available: <span class="type">u64</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;Weight calculation overflow for token &#123;token&#125;&quot;</span>)]</span></span><br><span class="line">    WeightCalculationOverflow &#123; token: <span class="type">String</span> &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[error(<span class="string">&quot;ETF redemption is currently paused&quot;</span>)]</span></span><br><span class="line">    RedemptionPaused,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改进后的赎回函数</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_burn_enhanced</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 输入验证</span></span><br><span class="line">    require!(lamports &gt; <span class="number">0</span>, EtfRedemptionError::InvalidAmount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查ETF是否暂停</span></span><br><span class="line">    require!(</span><br><span class="line">        !ctx.accounts.etf_token_info.is_paused.<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>),</span><br><span class="line">        EtfRedemptionError::RedemptionPaused</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 预先验证用户ETF余额</span></span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.etf_token_ata.amount &gt;= lamports,</span><br><span class="line">        EtfRedemptionError::InsufficientEtfBalance &#123;</span><br><span class="line">            required: lamports,</span><br><span class="line">            available: ctx.accounts.etf_token_ata.amount</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 现有的赎回逻辑...</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        m.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],</span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">        .remaining_accounts</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">        .collect::&lt;HashMap&lt;_, _&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行转移操作，添加更详细的错误信息</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">from_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">                &amp;x.token,</span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(EtfRedemptionError::InvalidAccount &#123; </span><br><span class="line">                account: <span class="built_in">format!</span>(<span class="string">&quot;ETF custody account for token &#123;&#125;&quot;</span>, x.token) </span><br><span class="line">            &#125;)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">to_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;<span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">                &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">                &amp;x.token,</span><br><span class="line">            ))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(EtfRedemptionError::InvalidAccount &#123; </span><br><span class="line">                account: <span class="built_in">format!</span>(<span class="string">&quot;User account for token &#123;&#125;&quot;</span>, x.token) </span><br><span class="line">            &#125;)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行转移</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: from_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    to: to_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                    authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                &#125;,</span><br><span class="line">                signer_seeds,</span><br><span class="line">            ),</span><br><span class="line">            amount</span><br><span class="line">        ).<span class="title function_ invoke__">map_err</span>(|_| EtfRedemptionError::InsufficientCustodyBalance &#123;</span><br><span class="line">            token: x.token.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            required: amount,</span><br><span class="line">            available: <span class="number">0</span>, <span class="comment">// 这里应该获取实际余额</span></span><br><span class="line">        &#125;)?;</span><br><span class="line"></span><br><span class="line">        msg!(<span class="string">&quot;✅ Transferred &#123;&#125; units of token &#123;&#125; from ETF to user&quot;</span>, amount, x.token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁ETF代币</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            Burn &#123;</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                from: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        lamports,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;🔥 Successfully burned &#123;&#125; ETF tokens&quot;</span>, lamports);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发出赎回事件</span></span><br><span class="line">    emit!(RedemptionEvent &#123;</span><br><span class="line">        user: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        etf_mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount_burned: lamports,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 赎回事件定义</span></span><br><span class="line"><span class="meta">#[event]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RedemptionEvent</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> amount_burned: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">i64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-性能优化建议"><a href="#B-性能优化建议" class="headerlink" title="B. 性能优化建议"></a>B. 性能优化建议</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预计算优化</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="comment">// 缓存权重计算结果</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redemption_amounts</span>(&amp;<span class="keyword">self</span>, lamports: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;(Pubkey, <span class="type">u64</span>)&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.constituent</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map</span>(|x| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">amount</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line">                (x.token, amount)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">collect</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证权重总和（应该在ETF创建时验证，而不是每次赎回时验证）</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_weights</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">total_weight</span>: <span class="type">u32</span> = <span class="keyword">self</span>.constituent.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|c| c.weight).<span class="title function_ invoke__">sum</span>();</span><br><span class="line">        require!(total_weight == <span class="number">100</span>, TokenMintError::InvalidWeightSum);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量操作优化</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">batch_transfer_for_redemption</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    token_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    transfers: <span class="type">Vec</span>&lt;TransferParams&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 批量执行转移操作，减少CPI调用次数</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">transfer_params</span> <span class="keyword">in</span> transfers &#123;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">                token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">                transfer_params.transfer_accounts,</span><br><span class="line">                signer_seeds,</span><br><span class="line">            ),</span><br><span class="line">            transfer_params.amount,</span><br><span class="line">        )?;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-TypeScript客户端优化"><a href="#2-TypeScript客户端优化" class="headerlink" title="2. TypeScript客户端优化"></a>2. TypeScript客户端优化</h3><h4 id="A-类型安全增强"><a href="#A-类型安全增强" class="headerlink" title="A. 类型安全增强"></a>A. 类型安全增强</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义严格的类型接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EtfRedemptionConfig</span> &#123;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">amount</span>: <span class="variable constant_">BN</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">slippageTolerance</span>?: <span class="built_in">number</span>; <span class="comment">// 滑点容忍度</span></span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">deadline</span>?: <span class="built_in">number</span>; <span class="comment">// 截止时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EtfRedemptionResult</span> &#123;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">signature</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">slot</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">blockTime</span>: <span class="built_in">number</span> | <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">fee</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">computeUnitsUsed</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">underlyingAssetsReceived</span>: <span class="title class_">Array</span>&lt;&#123;</span><br><span class="line">        <span class="attr">token</span>: <span class="title class_">PublicKey</span>;</span><br><span class="line">        <span class="attr">amount</span>: <span class="variable constant_">BN</span>;</span><br><span class="line">        <span class="attr">weight</span>: <span class="built_in">number</span>;</span><br><span class="line">    &#125;&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改进的赎回函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenBurnTyped</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 输入验证</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">amount</span>.<span class="title function_">lte</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;赎回数量必须大于0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(config.<span class="property">etfAddress</span>);</span><br><span class="line">    <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查截止时间</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">deadline</span> &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() &gt; config.<span class="property">deadline</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;交易已超过截止时间&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 预先验证用户余额</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">validateUserEtfBalance</span>(wallet, config.<span class="property">etfAddress</span>, config.<span class="property">amount</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建交易</span></span><br><span class="line">    <span class="keyword">const</span> &#123; transaction, computeUnits &#125; = <span class="keyword">await</span> <span class="title function_">buildRedemptionTransaction</span>(</span><br><span class="line">        wallet,</span><br><span class="line">        config,</span><br><span class="line">        etfInfo,</span><br><span class="line">        etfCoreAddress</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送交易</span></span><br><span class="line">    <span class="keyword">const</span> signature = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">sendTransaction</span>(transaction, [wallet.<span class="property">payer</span>], &#123;</span><br><span class="line">        <span class="attr">skipPreflight</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">preflightCommitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待确认</span></span><br><span class="line">    <span class="keyword">const</span> confirmation = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">confirmTransaction</span>(&#123;</span><br><span class="line">        signature,</span><br><span class="line">        <span class="attr">blockhash</span>: (<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>()).<span class="property">blockhash</span>,</span><br><span class="line">        <span class="attr">lastValidBlockHeight</span>: (<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>()).<span class="property">lastValidBlockHeight</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (confirmation.<span class="property">value</span>.<span class="property">err</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`交易失败: <span class="subst">$&#123;confirmation.value.err&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取交易详情</span></span><br><span class="line">    <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">        <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算接收到的底层资产</span></span><br><span class="line">    <span class="keyword">const</span> underlyingAssetsReceived = etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">token</span>: c.<span class="property">token</span>,</span><br><span class="line">        <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(c.<span class="property">weight</span>).<span class="title function_">mul</span>(config.<span class="property">amount</span>).<span class="title function_">div</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">100</span>)),</span><br><span class="line">        <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        signature,</span><br><span class="line">        <span class="attr">slot</span>: confirmation.<span class="property">context</span>.<span class="property">slot</span>,</span><br><span class="line">        <span class="attr">blockTime</span>: txDetails?.<span class="property">blockTime</span> || <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">fee</span>: txDetails?.<span class="property">meta</span>?.<span class="property">fee</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">computeUnitsUsed</span>: txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span> || <span class="number">0</span>,</span><br><span class="line">        underlyingAssetsReceived,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">validateUserEtfBalance</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">requiredAmount</span>: BN</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEtfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(etfAddress, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userEtfAta);</span><br><span class="line">        <span class="keyword">const</span> balance = <span class="keyword">new</span> <span class="title function_">BN</span>(account.<span class="property">amount</span>.<span class="title function_">toString</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (balance.<span class="title function_">lt</span>(requiredAmount)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">                <span class="string">`ETF余额不足: 需要 <span class="subst">$&#123;requiredAmount.toString()&#125;</span>, 可用 <span class="subst">$&#123;balance.toString()&#125;</span>`</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;ETF代币账户不存在，用户可能从未持有此ETF代币&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">buildRedemptionTransaction</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">etfCoreAddress</span>: <span class="title class_">PublicKey</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">transaction</span>: <span class="title class_">Transaction</span>, <span class="attr">computeUnits</span>: <span class="built_in">number</span> &#125;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> [</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> ix = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">        .<span class="title function_">etfTokenBurn</span>(config.<span class="property">amount</span>)</span><br><span class="line">        .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">            <span class="attr">etfTokenMintAccount</span>: config.<span class="property">etfAddress</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">remainingAccounts</span>(</span><br><span class="line">            remainingAccounts.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123;</span><br><span class="line">                <span class="attr">pubkey</span>: item,</span><br><span class="line">                <span class="attr">isWritable</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">isSigner</span>: <span class="literal">false</span>,</span><br><span class="line">            &#125;))</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">instruction</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">const</span> modifyComputeUnits = <span class="title class_">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">        <span class="attr">units</span>: computeUnits,</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> transaction = <span class="keyword">new</span> <span class="title class_">Transaction</span>().<span class="title function_">add</span>(ix).<span class="title function_">add</span>(modifyComputeUnits);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置最近的区块哈希</span></span><br><span class="line">    <span class="keyword">const</span> &#123; blockhash &#125; = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>();</span><br><span class="line">    transaction.<span class="property">recentBlockhash</span> = blockhash;</span><br><span class="line">    transaction.<span class="property">feePayer</span> = wallet.<span class="property">payer</span>.<span class="property">publicKey</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; transaction, computeUnits &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-用户体验优化"><a href="#B-用户体验优化" class="headerlink" title="B. 用户体验优化"></a>B. 用户体验优化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赎回进度跟踪</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EtfRedemptionTracker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> steps = [</span><br><span class="line">        <span class="string">&quot;验证用户余额&quot;</span>,</span><br><span class="line">        <span class="string">&quot;检查托管资产&quot;</span>,</span><br><span class="line">        <span class="string">&quot;创建缺失账户&quot;</span>,</span><br><span class="line">        <span class="string">&quot;构建交易&quot;</span>,</span><br><span class="line">        <span class="string">&quot;发送交易&quot;</span>,</span><br><span class="line">        <span class="string">&quot;等待确认&quot;</span>,</span><br><span class="line">        <span class="string">&quot;验证结果&quot;</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> currentStep = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">onProgress</span>?: <span class="function">(<span class="params"><span class="attr">step</span>: <span class="built_in">number</span>, <span class="attr">total</span>: <span class="built_in">number</span>, <span class="attr">message</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">onProgress</span>?: (step: <span class="built_in">number</span>, total: <span class="built_in">number</span>, message: <span class="built_in">string</span>) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onProgress</span> = onProgress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">nextStep</span>(<span class="params"><span class="attr">message</span>?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentStep</span>++;</span><br><span class="line">        <span class="keyword">const</span> stepMessage = message || <span class="variable language_">this</span>.<span class="property">steps</span>[<span class="variable language_">this</span>.<span class="property">currentStep</span> - <span class="number">1</span>] || <span class="string">&quot;处理中...&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onProgress</span>?.(<span class="variable language_">this</span>.<span class="property">currentStep</span>, <span class="variable language_">this</span>.<span class="property">steps</span>.<span class="property">length</span>, stepMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">trackRedemption</span>(</span><br><span class="line">        <span class="attr">wallet</span>: anchor.<span class="property">Wallet</span>,</span><br><span class="line">        <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span></span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;开始验证用户ETF余额...&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">validateUserEtfBalance</span>(wallet, config.<span class="property">etfAddress</span>, config.<span class="property">amount</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;获取ETF配置信息...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(config.<span class="property">etfAddress</span>);</span><br><span class="line">            <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;检查用户代币接收账户...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> setupTx = <span class="keyword">await</span> <span class="title function_">ensureUserTokenAccounts</span>(wallet, etfInfo.<span class="property">constituent</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (setupTx) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;创建缺失的代币账户...&quot;</span>);</span><br><span class="line">                <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">                    provider.<span class="property">connection</span>,</span><br><span class="line">                    setupTx,</span><br><span class="line">                    [wallet.<span class="property">payer</span>]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;构建赎回交易...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> &#123; transaction &#125; = <span class="keyword">await</span> <span class="title function_">buildRedemptionTransaction</span>(</span><br><span class="line">                wallet,</span><br><span class="line">                config,</span><br><span class="line">                etfInfo,</span><br><span class="line">                etfCoreAddress</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;发送交易到区块链...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> signature = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">sendTransaction</span>(</span><br><span class="line">                transaction,</span><br><span class="line">                [wallet.<span class="property">payer</span>]</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;等待交易确认...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> confirmation = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">confirmTransaction</span>(&#123;</span><br><span class="line">                signature,</span><br><span class="line">                ...<span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getLatestBlockhash</span>(),</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (confirmation.<span class="property">value</span>.<span class="property">err</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`交易失败: <span class="subst">$&#123;confirmation.value.err&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;验证赎回结果...&quot;</span>);</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">buildRedemptionResult</span>(</span><br><span class="line">                signature,</span><br><span class="line">                confirmation,</span><br><span class="line">                config,</span><br><span class="line">                etfInfo</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">nextStep</span>(<span class="string">&quot;赎回完成！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">onProgress</span>?.(<span class="variable language_">this</span>.<span class="property">currentStep</span>, <span class="variable language_">this</span>.<span class="property">steps</span>.<span class="property">length</span>, <span class="string">`错误: <span class="subst">$&#123;error.message&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">buildRedemptionResult</span>(</span><br><span class="line">        <span class="attr">signature</span>: <span class="built_in">string</span>,</span><br><span class="line">        <span class="attr">confirmation</span>: <span class="built_in">any</span>,</span><br><span class="line">        <span class="attr">config</span>: <span class="title class_">EtfRedemptionConfig</span>,</span><br><span class="line">        <span class="attr">etfInfo</span>: <span class="built_in">any</span></span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;<span class="title class_">EtfRedemptionResult</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(signature, &#123;</span><br><span class="line">            <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            signature,</span><br><span class="line">            <span class="attr">slot</span>: confirmation.<span class="property">context</span>.<span class="property">slot</span>,</span><br><span class="line">            <span class="attr">blockTime</span>: txDetails?.<span class="property">blockTime</span> || <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">fee</span>: txDetails?.<span class="property">meta</span>?.<span class="property">fee</span> || <span class="number">0</span>,</span><br><span class="line">            <span class="attr">computeUnitsUsed</span>: txDetails?.<span class="property">meta</span>?.<span class="property">computeUnitsConsumed</span> || <span class="number">0</span>,</span><br><span class="line">            <span class="attr">underlyingAssetsReceived</span>: etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">c</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">                <span class="attr">token</span>: c.<span class="property">token</span>,</span><br><span class="line">                <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(c.<span class="property">weight</span>).<span class="title function_">mul</span>(config.<span class="property">amount</span>).<span class="title function_">div</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">100</span>)),</span><br><span class="line">                <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">            &#125;)),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> redemptionTracker = <span class="keyword">new</span> <span class="title class_">EtfRedemptionTracker</span>(<span class="function">(<span class="params">step, total, message</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">$&#123;step&#125;</span>/<span class="subst">$&#123;total&#125;</span>] <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 这里可以更新UI进度条</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> redemptionTracker.<span class="title function_">trackRedemption</span>(wallet, &#123;</span><br><span class="line">    <span class="attr">etfAddress</span>: etfMintAddress,</span><br><span class="line">    <span class="attr">amount</span>: <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">600000000</span>),</span><br><span class="line">    <span class="attr">slippageTolerance</span>: <span class="number">0.005</span>, <span class="comment">// 0.5%</span></span><br><span class="line">    <span class="attr">deadline</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// 5分钟后过期</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-架构层面优化建议"><a href="#3-架构层面优化建议" class="headerlink" title="3. 架构层面优化建议"></a>3. 架构层面优化建议</h3><h4 id="A-模块化重构"><a href="#A-模块化重构" class="headerlink" title="A. 模块化重构"></a>A. 模块化重构</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议的模块结构</span></span><br><span class="line"><span class="comment">// src/</span></span><br><span class="line"><span class="comment">// ├── lib.rs                 // 主程序入口</span></span><br><span class="line"><span class="comment">// ├── instructions/          // 指令处理模块</span></span><br><span class="line"><span class="comment">// │   ├── mod.rs</span></span><br><span class="line"><span class="comment">// │   ├── create_etf.rs      // ETF创建</span></span><br><span class="line"><span class="comment">// │   ├── mint_etf.rs        // ETF购买</span></span><br><span class="line"><span class="comment">// │   ├── burn_etf.rs        // ETF赎回</span></span><br><span class="line"><span class="comment">// │   └── manage_etf.rs      // ETF管理</span></span><br><span class="line"><span class="comment">// ├── state/                 // 状态定义模块</span></span><br><span class="line"><span class="comment">// │   ├── mod.rs</span></span><br><span class="line"><span class="comment">// │   ├── etf_token.rs       // ETF状态</span></span><br><span class="line"><span class="comment">// │   └── events.rs          // 事件定义</span></span><br><span class="line"><span class="comment">// ├── utils/                 // 工具函数模块</span></span><br><span class="line"><span class="comment">// │   ├── mod.rs</span></span><br><span class="line"><span class="comment">// │   ├── calculations.rs    // 计算工具</span></span><br><span class="line"><span class="comment">// │   ├── validations.rs     // 验证工具</span></span><br><span class="line"><span class="comment">// │   └── constants.rs       // 常量定义</span></span><br><span class="line"><span class="comment">// └── errors/                // 错误定义模块</span></span><br><span class="line"><span class="comment">//     ├── mod.rs</span></span><br><span class="line"><span class="comment">//     └── etf_errors.rs      // ETF相关错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/calculations.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfCalculations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfCalculations</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_redemption_amounts</span>(</span><br><span class="line">        constituent: &amp;[EtfTokenConstituent],</span><br><span class="line">        total_amount: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;(Pubkey, <span class="type">u64</span>)&gt; &#123;</span><br><span class="line">        constituent</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map</span>(|x| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">amount</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">safe_multiply_and_divide</span>(</span><br><span class="line">                    x.weight <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">                    total_amount,</span><br><span class="line">                    <span class="number">100</span></span><br><span class="line">                ).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Calculation overflow&quot;</span>);</span><br><span class="line">                (x.token, amount)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">collect</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">safe_multiply_and_divide</span>(a: <span class="type">u64</span>, b: <span class="type">u64</span>, divisor: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">        a.<span class="title function_ invoke__">checked_mul</span>(b)?.<span class="title function_ invoke__">checked_div</span>(divisor)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_weight_sum</span>(weights: &amp;[<span class="type">u32</span>]) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        weights.<span class="title function_ invoke__">iter</span>().sum::&lt;<span class="type">u32</span>&gt;() == <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/validations.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfValidations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfValidations</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_request</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">        ctx: &amp;Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">        lamports: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// 基本验证</span></span><br><span class="line">        require!(lamports &gt; <span class="number">0</span>, EtfError::InvalidAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 余额验证</span></span><br><span class="line">        require!(</span><br><span class="line">            ctx.accounts.etf_token_ata.amount &gt;= lamports,</span><br><span class="line">            EtfError::InsufficientBalance</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 状态验证</span></span><br><span class="line">        require!(</span><br><span class="line">            !ctx.accounts.etf_token_info.is_paused.<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>),</span><br><span class="line">            EtfError::RedemptionPaused</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_accounts_mapping</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">        accounts: &amp;HashMap&lt;Pubkey, AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">        expected_accounts: &amp;[Pubkey],</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">expected</span> <span class="keyword">in</span> expected_accounts &#123;</span><br><span class="line">            require!(</span><br><span class="line">                accounts.<span class="title function_ invoke__">contains_key</span>(expected),</span><br><span class="line">                EtfError::MissingAccount &#123; account: *expected &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-配置化管理"><a href="#B-配置化管理" class="headerlink" title="B. 配置化管理"></a>B. 配置化管理</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置文件支持</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfConfig</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> admin: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> fee_collector: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> redemption_fee_bps: <span class="type">u16</span>,      <span class="comment">// 赎回费率（基点）</span></span><br><span class="line">    <span class="keyword">pub</span> min_redemption: <span class="type">u64</span>,          <span class="comment">// 最小赎回量</span></span><br><span class="line">    <span class="keyword">pub</span> max_redemption: <span class="type">u64</span>,          <span class="comment">// 最大赎回量</span></span><br><span class="line">    <span class="keyword">pub</span> redemption_delay: <span class="type">i64</span>,        <span class="comment">// 赎回延迟（秒）</span></span><br><span class="line">    <span class="keyword">pub</span> emergency_pause_enabled: <span class="type">bool</span>, <span class="comment">// 是否启用紧急暂停</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfConfig</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;etf_config&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_redemption_amount</span>(&amp;<span class="keyword">self</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        require!(amount &gt;= <span class="keyword">self</span>.min_redemption, EtfError::BelowMinRedemption);</span><br><span class="line">        require!(amount &lt;= <span class="keyword">self</span>.max_redemption, EtfError::ExceedsMaxRedemption);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_fee</span>(&amp;<span class="keyword">self</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">        amount * <span class="keyword">self</span>.redemption_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10_000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最佳实践总结"><a href="#最佳实践总结" class="headerlink" title="最佳实践总结"></a>最佳实践总结</h2><h3 id="1-开发流程建议"><a href="#1-开发流程建议" class="headerlink" title="1. 开发流程建议"></a>1. 开发流程建议</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">🔄 开发生命周期：</span><br><span class="line"></span><br><span class="line">1. 设计阶段</span><br><span class="line">   ├── 定义ETF需求和约束</span><br><span class="line">   ├── 设计账户结构和权限模型</span><br><span class="line">   ├── 规划错误处理策略</span><br><span class="line">   └── 制定测试计划</span><br><span class="line"></span><br><span class="line">2. 实现阶段</span><br><span class="line">   ├── 编写核心业务逻辑</span><br><span class="line">   ├── 实现全面的输入验证</span><br><span class="line">   ├── 添加详细的日志记录</span><br><span class="line">   └── 编写单元测试</span><br><span class="line"></span><br><span class="line">3. 测试阶段</span><br><span class="line">   ├── 本地开发网测试</span><br><span class="line">   ├── Devnet集成测试</span><br><span class="line">   ├── 边界情况测试</span><br><span class="line">   └── 性能压力测试</span><br><span class="line"></span><br><span class="line">4. 部署阶段</span><br><span class="line">   ├── Mainnet-beta验证</span><br><span class="line">   ├── 监控和告警设置</span><br><span class="line">   ├── 用户文档准备</span><br><span class="line">   └── 社区反馈收集</span><br></pre></td></tr></table></figure>

<h3 id="2-安全检查清单"><a href="#2-安全检查清单" class="headerlink" title="2. 安全检查清单"></a>2. 安全检查清单</h3><ul>
<li>✅ <strong>权限验证</strong>: 确保只有授权用户能执行赎回</li>
<li>✅ <strong>余额检查</strong>: 验证用户有足够的ETF代币</li>
<li>✅ <strong>原子性</strong>: 所有操作在单一事务中完成</li>
<li>✅ <strong>溢出保护</strong>: 防止数值计算溢出</li>
<li>✅ <strong>重入保护</strong>: 防止重入攻击</li>
<li>✅ <strong>状态一致性</strong>: 确保程序状态始终一致</li>
<li>✅ <strong>错误处理</strong>: 提供详细的错误信息</li>
<li>✅ <strong>事件日志</strong>: 记录重要操作的事件</li>
</ul>
<h3 id="3-性能优化要点"><a href="#3-性能优化要点" class="headerlink" title="3. 性能优化要点"></a>3. 性能优化要点</h3><ul>
<li>⚡ <strong>计算单元管理</strong>: 根据ETF复杂度动态调整</li>
<li>⚡ <strong>批量操作</strong>: 减少不必要的RPC调用</li>
<li>⚡ <strong>账户预检</strong>: 提前验证账户存在性</li>
<li>⚡ <strong>缓存策略</strong>: 缓存频繁访问的数据</li>
<li>⚡ <strong>并发处理</strong>: 合理利用异步操作</li>
</ul>
<h3 id="4-用户体验关注点"><a href="#4-用户体验关注点" class="headerlink" title="4. 用户体验关注点"></a>4. 用户体验关注点</h3><ul>
<li>🎯 <strong>进度反馈</strong>: 实时显示操作进度</li>
<li>🎯 <strong>错误提示</strong>: 提供清晰的错误说明</li>
<li>🎯 <strong>成本透明</strong>: 显示预估交易成本</li>
<li>🎯 <strong>结果验证</strong>: 确认操作结果的正确性</li>
<li>🎯 <strong>历史记录</strong>: 提供操作历史查询</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>ETF赎回功能是整个ETF系统中的关键组件，它确保用户能够随时将持有的ETF代币转换回底层资产。本教程通过详细的代码示例和深入的技术分析，展示了如何在Solana上实现安全、高效的ETF赎回机制。</p>
<p><strong>核心技术要点回顾</strong>：</p>
<ul>
<li>🔐 <strong>PDA权限控制</strong>: 确保只有ETF合约能够转移托管资产</li>
<li>⚖️ <strong>比例分配算法</strong>: 按权重准确返还底层资产</li>
<li>🔥 <strong>代币销毁机制</strong>: 维护ETF代币供应量的准确性</li>
<li>🛡️ <strong>原子性保障</strong>: 防止部分执行导致的状态不一致</li>
<li>📊 <strong>详细日志记录</strong>: 便于调试和审计</li>
</ul>
<p><strong>与购买功能的对比</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">购买(Mint): 用户资产 → ETF托管 + 铸造ETF代币</span><br><span class="line">赎回(Burn): ETF托管 → 用户资产 + 销毁ETF代币</span><br><span class="line"></span><br><span class="line">两个操作形成完美的对称性，确保资产总量守恒</span><br></pre></td></tr></table></figure>

<p>通过本教程的学习，开发者可以：</p>
<ol>
<li>理解ETF赎回的核心机制和安全要求</li>
<li>掌握Solana程序开发的高级技巧</li>
<li>学会处理复杂的多账户交互场景  </li>
<li>建立完善的错误处理和用户体验优化策略</li>
</ol>
<p>这个实现为构建更复杂的DeFi产品提供了坚实基础，展示了如何在区块链上实现传统金融产品的数字化创新。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/" rel="prev" title="Solana实战-ETF的购买">
                  <i class="fa fa-angle-left"></i> Solana实战-ETF的购买
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E6%8B%93%E5%B1%95/" rel="next" title="Solana实战-ETF的拓展">
                  Solana实战-ETF的拓展 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">samxie</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
