<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="本教程将详细介绍如何在Solana上实现ETF代币的购买功能，包括账户验证、资产转移和代币铸造的完整流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Solana实战-ETF的购买">
<meta property="og:url" content="http://example.com/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/index.html">
<meta property="og:site_name" content="samxie52">
<meta property="og:description" content="本教程将详细介绍如何在Solana上实现ETF代币的购买功能，包括账户验证、资产转移和代币铸造的完整流程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-21T07:34:11.000Z">
<meta property="article:modified_time" content="2025-09-21T10:37:35.212Z">
<meta property="article:author" content="samxie">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/","path":"2025/09/21/Solana实战-ETF的购买/","title":"Solana实战-ETF的购买"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Solana实战-ETF的购买 | samxie52</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">samxie52</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41-%E5%AE%9A%E4%B9%89ETF%E4%BA%A4%E6%98%93%E8%B4%A6%E6%88%B7%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">步骤1: 定义ETF交易账户结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PDA%E8%B4%A6%E6%88%B7%E9%AA%8C%E8%AF%81"><span class="nav-number">2.1.</span> <span class="nav-text">1. PDA账户验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ATA%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E6%9C%BA%E5%88%B6"><span class="nav-number">2.2.</span> <span class="nav-text">2. ATA自动创建机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42-%E5%AE%9E%E7%8E%B0ETF%E4%BB%A3%E5%B8%81%E9%93%B8%E9%80%A0%E9%80%BB%E8%BE%91"><span class="nav-number">3.</span> <span class="nav-text">步骤2: 实现ETF代币铸造逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9D%83%E9%87%8D%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">1. 权重计算公式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B4%A6%E6%88%B7%E6%9F%A5%E6%89%BE%E4%BC%98%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">2. 账户查找优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-CPI%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">3.3.</span> <span class="nav-text">3. CPI调用链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43-%E6%B3%A8%E5%86%8CETF%E9%93%B8%E9%80%A0%E6%8C%87%E4%BB%A4"><span class="nav-number">4.</span> <span class="nav-text">步骤3: 注册ETF铸造指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%AD%E4%B9%B0%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.</span> <span class="nav-text">步骤4: 客户端购买实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B4%A6%E6%88%B7%E9%A2%84%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="nav-number">5.1.</span> <span class="nav-text">1. 账户预检查机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%A1%E7%AE%97%E5%8D%95%E5%85%83%E9%99%90%E5%88%B6"><span class="nav-number">5.2.</span> <span class="nav-text">2. 计算单元限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%89%A9%E4%BD%99%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-number">5.3.</span> <span class="nav-text">3. 剩余账户管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A45-%E5%AE%8C%E6%95%B4%E8%B4%AD%E4%B9%B0%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.</span> <span class="nav-text">步骤5: 完整购买流程示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">7.</span> <span class="nav-text">技术深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%B5%84%E4%BA%A7%E8%BD%AC%E7%A7%BB%E6%9C%BA%E5%88%B6"><span class="nav-number">7.1.</span> <span class="nav-text">1. 资产转移机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E5%8E%9F%E5%AD%90%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="nav-number">7.1.1.</span> <span class="nav-text">A. 原子性保证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E9%93%BE"><span class="nav-number">7.1.2.</span> <span class="nav-text">B. 权限验证链</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="nav-number">7.2.</span> <span class="nav-text">2. 账户状态管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-ATA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">7.2.1.</span> <span class="nav-text">A. ATA生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E7%A7%9F%E9%87%91%E8%80%83%E8%99%91"><span class="nav-number">7.2.2.</span> <span class="nav-text">B. 租金考虑</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-number">7.3.</span> <span class="nav-text">3. 错误处理策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%9C%BA%E6%99%AF"><span class="nav-number">7.3.1.</span> <span class="nav-text">A. 常见错误场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E9%94%99%E8%AF%AF%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6"><span class="nav-number">7.3.2.</span> <span class="nav-text">B. 错误恢复机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">7.4.</span> <span class="nav-text">4. 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E4%BC%98%E5%8C%96"><span class="nav-number">7.4.1.</span> <span class="nav-text">A. 批量操作优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E8%AE%A1%E7%AE%97%E5%8D%95%E5%85%83%E4%BC%98%E5%8C%96"><span class="nav-number">7.4.2.</span> <span class="nav-text">B. 计算单元优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91"><span class="nav-number">8.</span> <span class="nav-text">安全性考虑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB%E9%98%B2%E6%8A%A4"><span class="nav-number">8.1.</span> <span class="nav-text">1. 重入攻击防护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BB%B7%E6%A0%BC%E6%93%8D%E7%BA%B5%E9%98%B2%E6%8A%A4"><span class="nav-number">8.2.</span> <span class="nav-text">2. 价格操纵防护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%BB%91%E7%82%B9%E4%BF%9D%E6%8A%A4"><span class="nav-number">8.3.</span> <span class="nav-text">3. 滑点保护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AE%AE"><span class="nav-number">9.</span> <span class="nav-text">扩展功能建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8A%A8%E6%80%81%E6%9D%83%E9%87%8D%E8%B0%83%E6%95%B4"><span class="nav-number">9.1.</span> <span class="nav-text">1. 动态权重调整</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%83%A8%E5%88%86%E8%B5%8E%E5%9B%9E%E5%8A%9F%E8%83%BD"><span class="nav-number">9.2.</span> <span class="nav-text">2. 部分赎回功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%B4%B9%E7%94%A8%E6%94%B6%E5%8F%96%E6%9C%BA%E5%88%B6"><span class="nav-number">9.3.</span> <span class="nav-text">3. 费用收取机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BB%B7%E6%A0%BC%E9%A2%84%E8%A8%80%E6%9C%BA%E9%9B%86%E6%88%90"><span class="nav-number">9.4.</span> <span class="nav-text">4. 价格预言机集成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%B5%81%E5%8A%A8%E6%80%A7%E6%B1%A0%E9%9B%86%E6%88%90"><span class="nav-number">9.5.</span> <span class="nav-text">5. 流动性池集成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4%E6%8C%87%E5%8D%97"><span class="nav-number">10.</span> <span class="nav-text">故障排除指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">10.1.</span> <span class="nav-text">1. 常见错误及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E2%80%9CTokenAccountNotFoundError%E2%80%9D"><span class="nav-number">10.1.1.</span> <span class="nav-text">A. “TokenAccountNotFoundError”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E2%80%9CInsufficientBalance%E2%80%9D"><span class="nav-number">10.1.2.</span> <span class="nav-text">B. “InsufficientBalance”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E2%80%9CInvalidAccounts%E2%80%9D"><span class="nav-number">10.1.3.</span> <span class="nav-text">C. “InvalidAccounts”</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="nav-number">10.2.</span> <span class="nav-text">2. 调试技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">10.2.1.</span> <span class="nav-text">A. 交易日志分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="nav-number">10.2.2.</span> <span class="nav-text">B. 账户状态检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-number">10.3.</span> <span class="nav-text">3. 性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-%E4%BA%A4%E6%98%93%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">10.3.1.</span> <span class="nav-text">A. 交易成本分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-Gas%E4%BD%BF%E7%94%A8%E4%BC%98%E5%8C%96"><span class="nav-number">10.3.2.</span> <span class="nav-text">B. Gas使用优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="nav-number">11.</span> <span class="nav-text">最佳实践总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="nav-number">11.1.</span> <span class="nav-text">1. 代码结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91"><span class="nav-number">11.2.</span> <span class="nav-text">2. 安全考虑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C"><span class="nav-number">11.3.</span> <span class="nav-text">3. 用户体验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%89%A9%E5%B1%95%E6%80%A7"><span class="nav-number">11.4.</span> <span class="nav-text">4. 扩展性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">12.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">samxie</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/21/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B4%AD%E4%B9%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="samxie">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="samxie52">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Solana实战-ETF的购买 | samxie52">
      <meta itemprop="description" content="本教程将详细介绍如何在Solana上实现ETF代币的购买功能，包括账户验证、资产转移和代币铸造的完整流程">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Solana实战-ETF的购买
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-21 15:34:11 / 修改时间：18:37:35" itemprop="dateCreated datePublished" datetime="2025-09-21T15:34:11+08:00">2025-09-21</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">本教程将详细介绍如何在Solana上实现ETF代币的购买功能，包括账户验证、资产转移和代币铸造的完整流程</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>ETF购买的核心机制</strong></p>
<p>在区块链ETF系统中，购买ETF代币的过程实际上是一个<strong>资产兑换</strong>过程：</p>
<ol>
<li><strong>资产投入</strong>：用户按照ETF的组成比例投入相应的底层代币</li>
<li><strong>资产托管</strong>：底层代币转移到ETF合约控制的账户中</li>
<li><strong>代币铸造</strong>：根据投入资产的价值铸造相应数量的ETF代币给用户</li>
</ol>
<p><strong>本教程实现的功能</strong>：</p>
<ul>
<li>验证用户持有足够的底层代币余额</li>
<li>按权重比例转移底层代币到ETF合约账户</li>
<li>铸造相应数量的ETF代币给用户</li>
<li>处理关联代币账户(ATA)的自动创建</li>
</ul>
<h2 id="步骤1-定义ETF交易账户结构"><a href="#步骤1-定义ETF交易账户结构" class="headerlink" title="步骤1: 定义ETF交易账户结构"></a>步骤1: 定义ETF交易账户结构</h2><p><strong>目的</strong>：定义ETF购买交易所需的所有账户，确保安全的资产转移和代币铸造。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/programs/counter/src/accounts_ix/etf_token_transaction.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;associated_token::AssociatedToken, token::&#123;Mint, Token, TokenAccount&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::EtfToken;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🏗️ ETF交易所需的账户结构体</span></span><br><span class="line"><span class="comment">// 这个结构体定义了ETF购买操作需要的所有账户</span></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfTokenTransaction</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ETF信息账户（只读）</span></span><br><span class="line">    <span class="comment">// 存储ETF的配置信息，包括组成代币和权重配置</span></span><br><span class="line">    <span class="meta">#[account(  </span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::SEED_PREFIX.as_bytes(),    // <span class="string">&quot;etf_token_v3&quot;</span> - 固定前缀</span></span><br><span class="line"><span class="meta">            etf_token_mint_account.key().as_ref(), // mint账户地址作为种子</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,  <span class="comment">// 自动寻找有效的bump值，确保PDA地址正确</span></span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_token_info: Account&lt;<span class="symbol">&#x27;info</span>, EtfToken&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户的ETF代币关联账户（ATA）</span></span><br><span class="line">    <span class="comment">// 用于接收新铸造的ETF代币</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,                              // 如果账户不存在，自动创建</span></span><br><span class="line"><span class="meta">        payer = authority,                           // 创建费用由交易发起者支付</span></span><br><span class="line"><span class="meta">        associated_token::mint = etf_token_mint_account,  // 指定关联的mint账户</span></span><br><span class="line"><span class="meta">        associated_token::authority = authority,     // 账户所有者为交易发起者</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> etf_token_ata: Account&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ETF代币的mint账户（可变）</span></span><br><span class="line">    <span class="comment">// 需要可变权限用于铸造新的ETF代币</span></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> etf_token_mint_account: Account&lt;<span class="symbol">&#x27;info</span>, Mint&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 交易发起者和签名者（可变）</span></span><br><span class="line">    <span class="comment">// 需要可变权限用于支付交易费用和转移代币</span></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> authority: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必需的程序账户</span></span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,              <span class="comment">// SPL Token程序</span></span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;, <span class="comment">// 关联代币程序</span></span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,            <span class="comment">// 系统程序（用于创建账户）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>账户设计要点解析</strong>：</p>
<h3 id="1-PDA账户验证"><a href="#1-PDA账户验证" class="headerlink" title="1. PDA账户验证"></a>1. PDA账户验证</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seeds = [</span><br><span class="line">    EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// 固定类型标识</span></span><br><span class="line">    etf_token_mint_account.<span class="title function_ invoke__">key</span>().<span class="title function_ invoke__">as_ref</span>(), <span class="comment">// 动态关联标识</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p><strong>作用</strong>：</p>
<ul>
<li>确保ETF信息账户地址的唯一性和确定性</li>
<li>只有知道正确种子的程序才能生成有效地址</li>
<li>防止恶意账户冒充ETF信息</li>
</ul>
<h3 id="2-ATA自动创建机制"><a href="#2-ATA自动创建机制" class="headerlink" title="2. ATA自动创建机制"></a>2. ATA自动创建机制</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">init_if_needed,                          <span class="comment">// 智能创建策略</span></span><br><span class="line">payer = authority,                       <span class="comment">// 明确费用承担者</span></span><br></pre></td></tr></table></figure>
<p><strong>优势</strong>：</p>
<ul>
<li>用户无需预先创建代币账户</li>
<li>简化用户操作流程</li>
<li>自动处理账户租金</li>
</ul>
<h2 id="步骤2-实现ETF代币铸造逻辑"><a href="#步骤2-实现ETF代币铸造逻辑" class="headerlink" title="步骤2: 实现ETF代币铸造逻辑"></a>步骤2: 实现ETF代币铸造逻辑</h2><p><strong>目的</strong>：实现完整的ETF购买流程，包括底层资产验证、转移和ETF代币铸造。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/programs/counter/src/instructions/etf_token_mint.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::get_associated_token_address,</span><br><span class="line">    token::&#123;mint_to, transfer, MintTo, Transfer&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::EtfToken;</span><br><span class="line"><span class="keyword">use</span> crate::&#123;accounts_ix::EtfTokenTransaction, states::TokenMintError&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🚀 ETF代币铸造的核心实现函数</span></span><br><span class="line"><span class="comment">// 这是ETF购买功能的主要业务逻辑</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_mint</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// 用户想要购买的ETF代币数量（以最小单位计算）</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 📋 构建剩余账户的快速查找映射表</span></span><br><span class="line">    <span class="comment">// remaining_accounts包含所有底层代币的用户账户和ETF托管账户</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">        .remaining_accounts</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))    <span class="comment">// 将账户地址作为key，账户信息作为value</span></span><br><span class="line">        .collect::&lt;HashMap&lt;_, _&gt;&gt;();        <span class="comment">// 创建HashMap用于O(1)时间复杂度的查找</span></span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;📊 Processing accounts: &#123;:?&#125;&quot;</span>, accounts);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔄 遍历ETF的每个组成代币，执行资产转移</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="comment">// 💰 计算用户需要转移的底层代币数量</span></span><br><span class="line">        <span class="comment">// 公式: (权重 / 100) * 购买数量</span></span><br><span class="line">        <span class="comment">// 注意: 这里假设权重以百分比形式存储(如权重20表示20%)</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amounts</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 🔍 获取用户的底层代币关联账户地址</span></span><br><span class="line">        <span class="comment">// 这是用户持有该底层代币的账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">user_token_ata</span> = <span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">            &amp;ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),  <span class="comment">// 用户地址</span></span><br><span class="line">            &amp;x.token,                       <span class="comment">// 底层代币mint地址</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 🔍 获取ETF合约的底层代币关联账户地址  </span></span><br><span class="line">        <span class="comment">// 这是ETF合约托管该底层代币的账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">etf_token_ata</span> = <span class="title function_ invoke__">get_associated_token_address</span>(</span><br><span class="line">            &amp;ctx.accounts.etf_token_info.<span class="title function_ invoke__">key</span>(),  <span class="comment">// ETF信息账户地址（作为托管方）</span></span><br><span class="line">            &amp;x.token,                            <span class="comment">// 底层代币mint地址</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 📦 从映射表中获取用户的底层代币账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">from_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;user_token_ata)</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// 如果找不到账户，返回错误</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 📦 从映射表中获取ETF的底层代币托管账户</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">to_ata</span> = accounts</span><br><span class="line">            .<span class="title function_ invoke__">get</span>(&amp;etf_token_ata)</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?;  <span class="comment">// 如果找不到账户，返回错误</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 💸 执行底层代币转移操作</span></span><br><span class="line">        <span class="comment">// 从用户账户转移到ETF托管账户</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">            CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">                ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// SPL Token程序</span></span><br><span class="line">                Transfer &#123;</span><br><span class="line">                    from: from_ata.<span class="title function_ invoke__">to_account_info</span>(),          <span class="comment">// 转出账户（用户）</span></span><br><span class="line">                    to: to_ata.<span class="title function_ invoke__">to_account_info</span>(),              <span class="comment">// 转入账户（ETF托管）</span></span><br><span class="line">                    authority: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(), <span class="comment">// 转移授权者（用户）</span></span><br><span class="line">                &#125;,</span><br><span class="line">            ),</span><br><span class="line">            amounts,  <span class="comment">// 转移数量</span></span><br><span class="line">        )?;</span><br><span class="line"></span><br><span class="line">        msg!(<span class="string">&quot;✅ Successfully transferred &#123;&#125; units of token: &#123;&#125;&quot;</span>, amounts, x.token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔐 准备ETF mint权限的PDA签名</span></span><br><span class="line">    <span class="comment">// 只有ETF信息账户（PDA）有权限铸造ETF代币</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),    <span class="comment">// &quot;etf_token_v3&quot;</span></span><br><span class="line">        m.<span class="title function_ invoke__">as_ref</span>(),                          <span class="comment">// mint账户地址</span></span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],        <span class="comment">// bump值，确保PDA签名有效</span></span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🪙 铸造ETF代币给用户</span></span><br><span class="line">    <span class="comment">// 根据用户投入的资产价值铸造相应数量的ETF代币</span></span><br><span class="line">    <span class="title function_ invoke__">mint_to</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),   <span class="comment">// SPL Token程序</span></span><br><span class="line">            MintTo &#123;</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),  <span class="comment">// ETF代币mint</span></span><br><span class="line">                to: ctx.accounts.etf_token_ata.<span class="title function_ invoke__">to_account_info</span>(),            <span class="comment">// 用户的ETF代币账户</span></span><br><span class="line">                authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),    <span class="comment">// mint权限（PDA）</span></span><br><span class="line">            &#125;, </span><br><span class="line">            signer_seeds  <span class="comment">// PDA签名，证明有权限进行mint操作</span></span><br><span class="line">        ), </span><br><span class="line">        lamports  <span class="comment">// 铸造的ETF代币数量</span></span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;🎉 Successfully minted &#123;&#125; ETF tokens to &#123;&#125;&quot;</span>, lamports, ctx.accounts.etf_token_ata.<span class="title function_ invoke__">key</span>());</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>核心算法解析</strong>：</p>
<h3 id="1-权重计算公式"><a href="#1-权重计算公式" class="headerlink" title="1. 权重计算公式"></a>1. 权重计算公式</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">amounts</span> = x.weight <span class="keyword">as</span> <span class="type">u64</span> * lamports / <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong>实际示例</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">假设用户要购买1000个ETF代币，某底层代币权重为30%:</span><br><span class="line">计算: 30 * 1000 / 100 = 300个底层代币</span><br><span class="line"></span><br><span class="line">权重配置示例:</span><br><span class="line">- SOL: 40% → 需要 400个SOL</span><br><span class="line">- USDC: 30% → 需要 300个USDC  </span><br><span class="line">- BTC: 20% → 需要 200个BTC</span><br><span class="line">- ETH: 10% → 需要 100个ETH</span><br></pre></td></tr></table></figure>

<h3 id="2-账户查找优化"><a href="#2-账户查找优化" class="headerlink" title="2. 账户查找优化"></a>2. 账户查找优化</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts</span> = ctx.remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">    .collect::&lt;HashMap&lt;_, _&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>性能优势</strong>：</p>
<ul>
<li><strong>O(1)查找时间</strong>：HashMap提供常数时间复杂度查找</li>
<li><strong>内存效率</strong>：避免重复遍历账户列表</li>
<li><strong>类型安全</strong>：编译时确保账户类型正确</li>
</ul>
<h3 id="3-CPI调用链"><a href="#3-CPI调用链" class="headerlink" title="3. CPI调用链"></a>3. CPI调用链</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">用户调用 → ETF程序 → SPL Token程序</span><br><span class="line">         ↓</span><br><span class="line">    1. transfer() - 转移底层代币</span><br><span class="line">    2. mint_to() - 铸造ETF代币</span><br></pre></td></tr></table></figure>

<p><strong>安全性保障</strong>：</p>
<ul>
<li>每个CPI调用都需要正确的权限验证</li>
<li>PDA签名确保只有程序能执行关键操作</li>
<li>原子性：要么全部成功，要么全部失败</li>
</ul>
<h2 id="步骤3-注册ETF铸造指令"><a href="#步骤3-注册ETF铸造指令" class="headerlink" title="步骤3: 注册ETF铸造指令"></a>步骤3: 注册ETF铸造指令</h2><p><strong>目的</strong>：在主程序中暴露ETF购买功能的公共接口。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/programs/counter/src/lib.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 🌐 ETF代币铸造的公共接口</span></span><br><span class="line"><span class="comment">// 这个函数暴露给客户端，用于购买ETF代币</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_mint</span>&lt;<span class="symbol">&#x27;info</span>&gt;(</span><br><span class="line">    ctx: Context&lt;<span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>, <span class="symbol">&#x27;_</span>,<span class="symbol">&#x27;info</span>, EtfTokenTransaction&lt;<span class="symbol">&#x27;info</span>&gt;&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,  <span class="comment">// 购买数量参数</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 调用具体的业务逻辑实现</span></span><br><span class="line">    <span class="comment">// 保持接口简洁，将复杂逻辑封装在独立模块中</span></span><br><span class="line">    instructions::<span class="title function_ invoke__">etf_token_mint</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口设计原则</strong>：</p>
<ul>
<li><strong>简洁性</strong>：公共接口保持最小化</li>
<li><strong>可维护性</strong>：业务逻辑与接口分离</li>
<li><strong>可扩展性</strong>：便于添加中间件和验证逻辑</li>
</ul>
<h2 id="步骤4-客户端购买实现"><a href="#步骤4-客户端购买实现" class="headerlink" title="步骤4: 客户端购买实现"></a>步骤4: 客户端购买实现</h2><p><strong>目的</strong>：提供完整的客户端调用示例，处理账户创建和交易发送。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/example/api/etf_token.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&quot;./const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">BN</span> &#125; <span class="keyword">from</span> <span class="string">&quot;bn.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@solana/web3.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createAssociatedTokenAccountInstruction,</span><br><span class="line">  getAccount,</span><br><span class="line">  getAssociatedTokenAddressSync,</span><br><span class="line">  getMint,</span><br><span class="line">  <span class="title class_">TokenAccountNotFoundError</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/spl-token&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; deriveEtfTokenMintAccount, deriveEtfokenInfoAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./address&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🛒 ETF代币购买的完整客户端实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">etfTokenMint</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,      <span class="comment">// 用户钱包</span></span></span><br><span class="line"><span class="params">    <span class="attr">etfAddress</span>: <span class="title class_">PublicKey</span>,      <span class="comment">// ETF代币的mint地址</span></span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span>,           <span class="comment">// 购买数量（最小单位）</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 📍 派生ETF信息账户地址</span></span><br><span class="line">    <span class="comment">// 使用确定性算法生成ETF配置信息的存储地址</span></span><br><span class="line">    <span class="keyword">const</span> [etfCoreAddress] = <span class="title function_">deriveEtfokenInfoAccount</span>(etfAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📖 获取ETF配置信息</span></span><br><span class="line">    <span class="comment">// 从链上读取ETF的组成代币和权重配置</span></span><br><span class="line">    <span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfCoreAddress);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📊 ETF Configuration:&quot;</span>, etfInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🏗️ 准备账户创建交易</span></span><br><span class="line">    <span class="comment">// 用于创建缺失的关联代币账户</span></span><br><span class="line">    <span class="keyword">const</span> setupTx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📝 构建剩余账户列表</span></span><br><span class="line">    <span class="comment">// 包含所有底层代币的用户账户和ETF托管账户</span></span><br><span class="line">    <span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment">// 用户的底层代币账户地址</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">            <span class="comment">// ETF合约的底层代币托管账户地址（allowOwnerOffCurve=true）</span></span><br><span class="line">            <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">        ]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔍 确保所有必要的关联代币账户都存在</span></span><br><span class="line">    <span class="comment">// 遍历每个底层代币，检查并创建ETF托管账户</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="comment">// 计算ETF托管账户地址</span></span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试获取账户信息，验证账户是否存在</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ Found ETF associated token account: <span class="subst">$&#123;etfAta&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">// 如果账户不存在，创建账户创建指令</span></span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                setupTx.<span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">createAssociatedTokenAccountInstruction</span>(</span><br><span class="line">                        wallet.<span class="property">payer</span>.<span class="property">publicKey</span>,  <span class="comment">// 费用支付者</span></span><br><span class="line">                        etfAta,                  <span class="comment">// 要创建的账户地址</span></span><br><span class="line">                        etfCoreAddress,          <span class="comment">// 账户所有者（ETF合约）</span></span><br><span class="line">                        token,                   <span class="comment">// 代币mint地址</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🏗️ Will create ETF associated token account: <span class="subst">$&#123;etfAta&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;📋 Remaining accounts:&quot;</span>, remainingAccounts);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🛠️ 构建ETF购买指令</span></span><br><span class="line">    <span class="keyword">const</span> ix = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">        .<span class="title function_">etfTokenMint</span>(<span class="keyword">new</span> <span class="title function_">BN</span>(lamports))           <span class="comment">// 购买数量</span></span><br><span class="line">        .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">            <span class="attr">etfTokenMintAccount</span>: etfAddress,      <span class="comment">// ETF代币mint地址</span></span><br><span class="line">            <span class="attr">authority</span>: wallet.<span class="property">publicKey</span>,          <span class="comment">// 交易发起者</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">remainingAccounts</span>(</span><br><span class="line">            <span class="comment">// 添加所有底层代币相关账户</span></span><br><span class="line">            remainingAccounts.<span class="title function_">map</span>(<span class="function">(<span class="params">address</span>) =&gt;</span> (&#123; </span><br><span class="line">                <span class="attr">pubkey</span>: address, </span><br><span class="line">                <span class="attr">isWritable</span>: <span class="literal">true</span>,    <span class="comment">// 需要写入权限（转移代币）</span></span><br><span class="line">                <span class="attr">isSigner</span>: <span class="literal">false</span>      <span class="comment">// 不需要签名</span></span><br><span class="line">            &#125;)),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">transaction</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔧 如果需要创建关联代币账户，先执行设置交易</span></span><br><span class="line">    <span class="keyword">if</span> (setupTx.<span class="property">instructions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀 Sending setup transaction to create associated token accounts...&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">            provider.<span class="property">connection</span>,</span><br><span class="line">            setupTx,</span><br><span class="line">            [wallet.<span class="property">payer</span>]  <span class="comment">// 签名者</span></span><br><span class="line">        );</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;✅ Setup transaction completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ⚡ 设置计算单元限制</span></span><br><span class="line">    <span class="comment">// ETF购买涉及多个代币转移，需要更多计算资源</span></span><br><span class="line">    <span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">        <span class="attr">units</span>: <span class="number">400_000</span>,  <span class="comment">// 40万计算单元，足够处理复杂的多代币操作</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📦 构建并发送最终交易</span></span><br><span class="line">    <span class="keyword">const</span> tx = <span class="keyword">new</span> anchor.<span class="property">web3</span>.<span class="title class_">Transaction</span>().<span class="title function_">add</span>(ix).<span class="title function_">add</span>(modifyComputeUnits);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">        provider.<span class="property">connection</span>,</span><br><span class="line">        tx,</span><br><span class="line">        [wallet.<span class="property">payer</span>]  <span class="comment">// 交易签名者</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端实现要点</strong>：</p>
<h3 id="1-账户预检查机制"><a href="#1-账户预检查机制" class="headerlink" title="1. 账户预检查机制"></a>1. 账户预检查机制</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Found account: <span class="subst">$&#123;etfAta&#125;</span>`</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">        <span class="comment">// 自动创建缺失账户</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>：</p>
<ul>
<li><strong>用户体验优化</strong>：自动处理账户创建</li>
<li><strong>交易成功率提升</strong>：避免因缺少账户导致失败</li>
<li><strong>Gas费优化</strong>：只创建必要的账户</li>
</ul>
<h3 id="2-计算单元限制"><a href="#2-计算单元限制" class="headerlink" title="2. 计算单元限制"></a>2. 计算单元限制</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">    <span class="attr">units</span>: <span class="number">400_000</span>,  <span class="comment">// 根据ETF复杂度调整</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>为什么需要</strong>：</p>
<ul>
<li>ETF购买涉及多个底层代币操作</li>
<li>每个代币转移都需要消耗计算单元</li>
<li>默认限制可能不足以完成复杂交易</li>
</ul>
<h3 id="3-剩余账户管理"><a href="#3-剩余账户管理" class="headerlink" title="3. 剩余账户管理"></a>3. 剩余账户管理</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> remainingAccounts = etfInfo.<span class="property">constituent</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, wallet.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="title function_">getAssociatedTokenAddressSync</span>(item.<span class="property">token</span>, etfCoreAddress, <span class="literal">true</span>),</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>设计考虑</strong>：</p>
<ul>
<li><strong>动态账户列表</strong>：根据ETF配置动态生成</li>
<li><strong>成对组织</strong>：用户账户和托管账户成对出现</li>
<li><strong>权限标记</strong>：正确设置可写和签名权限</li>
</ul>
<h2 id="步骤5-完整购买流程示例"><a href="#步骤5-完整购买流程示例" class="headerlink" title="步骤5: 完整购买流程示例"></a>步骤5: 完整购买流程示例</h2><p><strong>目的</strong>：展示从ETF创建到购买的完整使用流程。</p>
<p><strong>文件位置</strong>：<code>../ibuidl-etf-dapp/anchor/example/index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; deriveEtfTokenMintAccount &#125; <span class="keyword">from</span> <span class="string">&quot;./api/address&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useDefaultWallet, useVisitorWallet &#125; <span class="keyword">from</span> <span class="string">&quot;./api/const&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createTokenMintAccount, etfTokenMint &#125; <span class="keyword">from</span> <span class="string">&quot;./api/etf_token&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span>;</span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 🔑 初始化钱包</span></span><br><span class="line">    <span class="keyword">const</span> defaultWallet = <span class="title function_">useDefaultWallet</span>();  <span class="comment">// ETF创建者钱包</span></span><br><span class="line">    <span class="keyword">const</span> visitorWallet = <span class="title function_">useVisitorWallet</span>();  <span class="comment">// ETF购买者钱包</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📋 定义ETF参数</span></span><br><span class="line">    <span class="keyword">const</span> [name, <span class="built_in">symbol</span>, description, url] = [</span><br><span class="line">        <span class="string">&quot;yama4&quot;</span>,                    <span class="comment">// ETF名称</span></span><br><span class="line">        <span class="string">&quot;YAMA4&quot;</span>,                   <span class="comment">// ETF符号  </span></span><br><span class="line">        <span class="string">&quot;yama4 description&quot;</span>,       <span class="comment">// ETF描述</span></span><br><span class="line">        <span class="string">&quot;https://note-public-img.oss-cn-beijing.aliyuncs.com/nya/nya.json&quot;</span>  <span class="comment">// 元数据URL</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🏗️ ETF创建示例（注释掉的代码）</span></span><br><span class="line">    <span class="comment">// 这部分展示了如何创建一个包含两种底层代币的ETF</span></span><br><span class="line">    <span class="comment">// const r1 = await createTokenMintAccount(</span></span><br><span class="line">    <span class="comment">//     defaultWallet,</span></span><br><span class="line">    <span class="comment">//     name,</span></span><br><span class="line">    <span class="comment">//     symbol, </span></span><br><span class="line">    <span class="comment">//     description,</span></span><br><span class="line">    <span class="comment">//     url,</span></span><br><span class="line">    <span class="comment">//     [</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // 底层代币1：权重20%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;7mAKyqdEovoH5VJaRCFRVAuo4dHH2sk79s2pvxjF24mM&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 20,</span></span><br><span class="line">    <span class="comment">//         &#125;,</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             // 底层代币2：权重80%</span></span><br><span class="line">    <span class="comment">//             token: new anchor.web3.PublicKey(&quot;9z65UmYiVSpFbLHqA5di8K8ZvHkqAXdKd7NroNWdemZJ&quot;),</span></span><br><span class="line">    <span class="comment">//             weight: 80,</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     ]);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🎯 获取ETF地址</span></span><br><span class="line">    <span class="comment">// 使用符号派生ETF mint账户地址</span></span><br><span class="line">    <span class="keyword">const</span> [etf,] = <span class="title function_">deriveEtfTokenMintAccount</span>(<span class="built_in">symbol</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🏷️ ETF Address: <span class="subst">$&#123;etf&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 💰 执行ETF购买</span></span><br><span class="line">    <span class="comment">// 购买600,000,000个最小单位的ETF代币（相当于0.6个ETF代币，假设9位小数）</span></span><br><span class="line">    <span class="keyword">const</span> r2 = <span class="keyword">await</span> <span class="title function_">etfTokenMint</span>(</span><br><span class="line">        defaultWallet,      <span class="comment">// 购买者钱包</span></span><br><span class="line">        etf,               <span class="comment">// ETF代币地址</span></span><br><span class="line">        <span class="number">600000000</span>          <span class="comment">// 购买数量（lamports）</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`✅ ETF Mint Transaction: <span class="subst">$&#123;r2&#125;</span>`</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p><strong>数量计算示例</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">购买600,000,000 lamports = 0.6 ETF代币（9位小数）</span><br><span class="line"></span><br><span class="line">如果ETF包含以下底层代币：</span><br><span class="line">- 代币A (权重20%): 需要 600,000,000 * 20 / 100 = 120,000,000个最小单位</span><br><span class="line">- 代币B (权重80%): 需要 600,000,000 * 80 / 100 = 480,000,000个最小单位</span><br></pre></td></tr></table></figure>

<h2 id="技术深度解析"><a href="#技术深度解析" class="headerlink" title="技术深度解析"></a>技术深度解析</h2><h3 id="1-资产转移机制"><a href="#1-资产转移机制" class="headerlink" title="1. 资产转移机制"></a>1. 资产转移机制</h3><h4 id="A-原子性保证"><a href="#A-原子性保证" class="headerlink" title="A. 原子性保证"></a>A. 原子性保证</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有转移操作在单一交易中完成</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">    <span class="comment">// 转移底层代币</span></span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// 如果失败，整个交易回滚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 铸造ETF代币</span></span><br><span class="line"><span class="title function_ invoke__">mint_to</span>(<span class="comment">/* ... */</span>)?;  <span class="comment">// 如果失败，整个交易回滚</span></span><br></pre></td></tr></table></figure>

<p><strong>重要性</strong>：</p>
<ul>
<li>防止部分执行导致的资产损失</li>
<li>确保用户要么获得完整的ETF，要么保持原始状态</li>
<li>避免套利机会和价格操纵</li>
</ul>
<h4 id="B-权限验证链"><a href="#B-权限验证链" class="headerlink" title="B. 权限验证链"></a>B. 权限验证链</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户签名 → 授权代币转移 → 程序验证 → 执行转移</span><br><span class="line">PDA签名 → 授权代币铸造 → 程序验证 → 执行铸造</span><br></pre></td></tr></table></figure>

<h3 id="2-账户状态管理"><a href="#2-账户状态管理" class="headerlink" title="2. 账户状态管理"></a>2. 账户状态管理</h3><h4 id="A-ATA生命周期"><a href="#A-ATA生命周期" class="headerlink" title="A. ATA生命周期"></a>A. ATA生命周期</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 检查账户存在性</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 如果不存在，创建账户</span></span><br><span class="line"><span class="title function_">createAssociatedTokenAccountInstruction</span>(<span class="comment">/* ... */</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 在主交易中使用账户</span></span><br><span class="line">.<span class="title function_">remainingAccounts</span>([&#123; <span class="attr">pubkey</span>: etfAta, <span class="attr">isWritable</span>: <span class="literal">true</span>, <span class="attr">isSigner</span>: <span class="literal">false</span> &#125;])</span><br></pre></td></tr></table></figure>

<h4 id="B-租金考虑"><a href="#B-租金考虑" class="headerlink" title="B. 租金考虑"></a>B. 租金考虑</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">每个ATA账户需要约0.00203928 SOL的租金</span><br><span class="line">ETF包含n个底层代币，最多需要创建n个托管账户</span><br><span class="line">总租金成本 ≈ n * 0.00203928 SOL</span><br></pre></td></tr></table></figure>

<h3 id="3-错误处理策略"><a href="#3-错误处理策略" class="headerlink" title="3. 错误处理策略"></a>3. 错误处理策略</h3><h4 id="A-常见错误场景"><a href="#A-常见错误场景" class="headerlink" title="A. 常见错误场景"></a>A. 常见错误场景</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 账户缺失</span></span><br><span class="line">.<span class="title function_ invoke__">ok_or</span>(TokenMintError::InvalidAccounts)?</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 余额不足</span></span><br><span class="line"><span class="comment">// SPL Token程序会自动验证余额</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 权限不足  </span></span><br><span class="line"><span class="comment">// Anchor框架会自动验证签名权限</span></span><br></pre></td></tr></table></figure>

<h4 id="B-错误恢复机制"><a href="#B-错误恢复机制" class="headerlink" title="B. 错误恢复机制"></a>B. 错误恢复机制</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端重试逻辑</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">etfTokenMint</span>(<span class="comment">/* ... */</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&quot;TokenAccountNotFoundError&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 先创建缺失账户，然后重试</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-性能优化"><a href="#4-性能优化" class="headerlink" title="4. 性能优化"></a>4. 性能优化</h3><h4 id="A-批量操作优化"><a href="#A-批量操作优化" class="headerlink" title="A. 批量操作优化"></a>A. 批量操作优化</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用HashMap避免O(n²)复杂度</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">accounts</span> = ctx.remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">    .collect::&lt;HashMap&lt;_, _&gt;&gt;();  <span class="comment">// O(n)时间构建，O(1)查找</span></span><br></pre></td></tr></table></figure>

<h4 id="B-计算单元优化"><a href="#B-计算单元优化" class="headerlink" title="B. 计算单元优化"></a>B. 计算单元优化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据ETF复杂度动态调整</span></span><br><span class="line"><span class="keyword">const</span> computeUnits = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">200_000</span>, etfInfo.<span class="property">constituent</span>.<span class="property">length</span> * <span class="number">50_000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="安全性考虑"><a href="#安全性考虑" class="headerlink" title="安全性考虑"></a>安全性考虑</h2><h3 id="1-重入攻击防护"><a href="#1-重入攻击防护" class="headerlink" title="1. 重入攻击防护"></a>1. 重入攻击防护</h3><ul>
<li><strong>原子性操作</strong>：所有转移在单一交易中完成</li>
<li><strong>状态检查</strong>：操作前验证所有前置条件</li>
<li><strong>PDA控制</strong>：关键操作只能由程序PDA执行</li>
</ul>
<h3 id="2-价格操纵防护"><a href="#2-价格操纵防护" class="headerlink" title="2. 价格操纵防护"></a>2. 价格操纵防护</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加价格验证机制</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_fair_value</span>(&amp;<span class="keyword">self</span>, oracle_prices: &amp;[<span class="type">u64</span>]) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// 验证ETF价格与底层资产价格的合理性</span></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-滑点保护"><a href="#3-滑点保护" class="headerlink" title="3. 滑点保护"></a>3. 滑点保护</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议添加最大滑点限制</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_mint_with_slippage</span>(</span><br><span class="line">    ctx: Context&lt;EtfTokenTransaction&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">    max_slippage_bps: <span class="type">u16</span>,  <span class="comment">// 最大滑点（基点）</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 计算预期成本和实际成本，验证滑点范围</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="扩展功能建议"><a href="#扩展功能建议" class="headerlink" title="扩展功能建议"></a>扩展功能建议</h2><h3 id="1-动态权重调整"><a href="#1-动态权重调整" class="headerlink" title="1. 动态权重调整"></a>1. 动态权重调整</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">rebalance_etf</span>(</span><br><span class="line">    ctx: Context&lt;RebalanceETF&gt;,</span><br><span class="line">    new_weights: <span class="type">Vec</span>&lt;EtfTokenConstituent&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 实现ETF权重的动态调整</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-部分赎回功能"><a href="#2-部分赎回功能" class="headerlink" title="2. 部分赎回功能"></a>2. 部分赎回功能</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_redeem</span>(</span><br><span class="line">    ctx: Context&lt;EtfTokenRedeem&gt;,</span><br><span class="line">    etf_amount: <span class="type">u64</span>,  <span class="comment">// 要赎回的ETF代币数量</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 按比例赎回底层资产</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">redeem_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * etf_amount / <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 从ETF托管账户转移到用户账户</span></span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(<span class="comment">/* ... */</span>, redeem_amount)?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁相应数量的ETF代币</span></span><br><span class="line">    <span class="title function_ invoke__">burn</span>(<span class="comment">/* ... */</span>, etf_amount)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-费用收取机制"><a href="#3-费用收取机制" class="headerlink" title="3. 费用收取机制"></a>3. 费用收取机制</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfFees</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> management_fee_bps: <span class="type">u16</span>,    <span class="comment">// 管理费（年化基点）</span></span><br><span class="line">    <span class="keyword">pub</span> performance_fee_bps: <span class="type">u16</span>,   <span class="comment">// 绩效费（基点）</span></span><br><span class="line">    <span class="keyword">pub</span> entry_fee_bps: <span class="type">u16</span>,         <span class="comment">// 申购费（基点）</span></span><br><span class="line">    <span class="keyword">pub</span> exit_fee_bps: <span class="type">u16</span>,          <span class="comment">// 赎回费（基点）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_fees</span>(</span><br><span class="line">    etf_amount: <span class="type">u64</span>,</span><br><span class="line">    fees: &amp;EtfFees,</span><br><span class="line">    operation_type: OperationType,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> operation_type &#123;</span><br><span class="line">        OperationType::Purchase =&gt; etf_amount * fees.entry_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10000</span>,</span><br><span class="line">        OperationType::Redeem =&gt; etf_amount * fees.exit_fee_bps <span class="keyword">as</span> <span class="type">u64</span> / <span class="number">10000</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-价格预言机集成"><a href="#4-价格预言机集成" class="headerlink" title="4. 价格预言机集成"></a>4. 价格预言机集成</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pyth_solana_receiver_sdk::price_update::PriceUpdateV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_mint_with_oracle</span>(</span><br><span class="line">    ctx: Context&lt;EtfTokenMintWithOracle&gt;,</span><br><span class="line">    lamports: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 验证价格数据的有效性</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">price_feed</span> <span class="keyword">in</span> &amp;ctx.remaining_accounts &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_update</span> = PriceUpdateV2::<span class="title function_ invoke__">try_deserialize</span>(&amp;<span class="keyword">mut</span> price_feed.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line">        require!(price_update.<span class="title function_ invoke__">verify_price_feeds</span>().<span class="title function_ invoke__">is_ok</span>(), TokenMintError::InvalidPriceData);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行购买逻辑</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_mint</span>(ctx, lamports)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-流动性池集成"><a href="#5-流动性池集成" class="headerlink" title="5. 流动性池集成"></a>5. 流动性池集成</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">etf_token_mint_via_swap</span>(</span><br><span class="line">    ctx: Context&lt;EtfTokenMintViaSwap&gt;,</span><br><span class="line">    input_token: Pubkey,</span><br><span class="line">    input_amount: <span class="type">u64</span>,</span><br><span class="line">    minimum_etf_output: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. 将输入代币按比例兑换为底层资产</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">constituent</span> <span class="keyword">in</span> &amp;ctx.accounts.etf_token_info.constituent &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">target_amount</span> = constituent.weight <span class="keyword">as</span> <span class="type">u64</span> * minimum_etf_output / <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 通过DEX兑换获得目标代币</span></span><br><span class="line">        <span class="title function_ invoke__">swap_via_dex</span>(input_token, constituent.token, target_amount)?;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 使用兑换得到的底层资产铸造ETF</span></span><br><span class="line">    <span class="title function_ invoke__">etf_token_mint</span>(ctx, minimum_etf_output)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="故障排除指南"><a href="#故障排除指南" class="headerlink" title="故障排除指南"></a>故障排除指南</h2><h3 id="1-常见错误及解决方案"><a href="#1-常见错误及解决方案" class="headerlink" title="1. 常见错误及解决方案"></a>1. 常见错误及解决方案</h3><h4 id="A-“TokenAccountNotFoundError”"><a href="#A-“TokenAccountNotFoundError”" class="headerlink" title="A. “TokenAccountNotFoundError”"></a>A. “TokenAccountNotFoundError”</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误原因：缺少必要的关联代币账户</span></span><br><span class="line"><span class="comment">// 解决方案：确保所有底层代币的托管账户都已创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查代码：</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">            <span class="comment">// 需要创建账户</span></span><br><span class="line">            setupTx.<span class="title function_">add</span>(<span class="title function_">createAssociatedTokenAccountInstruction</span>(<span class="comment">/* ... */</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-“InsufficientBalance”"><a href="#B-“InsufficientBalance”" class="headerlink" title="B. “InsufficientBalance”"></a>B. “InsufficientBalance”</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误原因：用户底层代币余额不足</span></span><br><span class="line"><span class="comment">// 解决方案：检查用户余额并提供明确提示</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_user_balances</span>(</span><br><span class="line">    user_accounts: &amp;[TokenAccount],</span><br><span class="line">    required_amounts: &amp;[<span class="type">u64</span>],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (account, &amp;required) <span class="keyword">in</span> user_accounts.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">zip</span>(required_amounts) &#123;</span><br><span class="line">        require!(account.amount &gt;= required, TokenMintError::InsufficientBalance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-“InvalidAccounts”"><a href="#C-“InvalidAccounts”" class="headerlink" title="C. “InvalidAccounts”"></a>C. “InvalidAccounts”</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误原因：传入的账户不匹配或顺序错误</span></span><br><span class="line"><span class="comment">// 解决方案：确保remaining_accounts的顺序与ETF配置一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端验证代码：</span></span><br><span class="line"><span class="keyword">const</span> validateAccountOrder = (etfInfo: EtfToken, accounts: PublicKey[]) =&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">i</span> = <span class="number">0</span>; i &lt; etfInfo.constituent.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> expectedUserAta = <span class="title function_ invoke__">getAssociatedTokenAddressSync</span>(</span><br><span class="line">            etfInfo.constituent[i].token, </span><br><span class="line">            wallet.publicKey</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> expectedEtfAta = <span class="title function_ invoke__">getAssociatedTokenAddressSync</span>(</span><br><span class="line">            etfInfo.constituent[i].token, </span><br><span class="line">            etfCoreAddress, </span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">assert</span>(accounts[i * <span class="number">2</span>].<span class="title function_ invoke__">equals</span>(expectedUserAta), <span class="string">&quot;User ATA mismatch&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(accounts[i * <span class="number">2</span> + <span class="number">1</span>].<span class="title function_ invoke__">equals</span>(expectedEtfAta), <span class="string">&quot;ETF ATA mismatch&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-调试技巧"><a href="#2-调试技巧" class="headerlink" title="2. 调试技巧"></a>2. 调试技巧</h3><h4 id="A-交易日志分析"><a href="#A-交易日志分析" class="headerlink" title="A. 交易日志分析"></a>A. 交易日志分析</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用详细日志</span></span><br><span class="line"><span class="keyword">const</span> tx = <span class="keyword">await</span> anchor.<span class="property">web3</span>.<span class="title function_">sendAndConfirmTransaction</span>(</span><br><span class="line">    provider.<span class="property">connection</span>,</span><br><span class="line">    transaction,</span><br><span class="line">    signers,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">skipPreflight</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">preflightCommitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">        <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取交易详情</span></span><br><span class="line"><span class="keyword">const</span> txDetails = <span class="keyword">await</span> provider.<span class="property">connection</span>.<span class="title function_">getTransaction</span>(tx, &#123;</span><br><span class="line">    <span class="attr">commitment</span>: <span class="string">&quot;confirmed&quot;</span>,</span><br><span class="line">    <span class="attr">maxSupportedTransactionVersion</span>: <span class="number">0</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Transaction logs:&quot;</span>, txDetails?.<span class="property">meta</span>?.<span class="property">logMessages</span>);</span><br></pre></td></tr></table></figure>

<h4 id="B-账户状态检查"><a href="#B-账户状态检查" class="headerlink" title="B. 账户状态检查"></a>B. 账户状态检查</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查ETF信息</span></span><br><span class="line"><span class="keyword">const</span> etfInfo = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">etfToken</span>.<span class="title function_">fetch</span>(etfInfoAddress);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ETF Configuration:&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">creator</span>: etfInfo.<span class="property">creator</span>.<span class="title function_">toString</span>(),</span><br><span class="line">    <span class="attr">mintAccount</span>: etfInfo.<span class="property">mintAccount</span>.<span class="title function_">toString</span>(),</span><br><span class="line">    <span class="attr">constituent</span>: etfInfo.<span class="property">constituent</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">token</span>: c.<span class="property">token</span>.<span class="title function_">toString</span>(),</span><br><span class="line">        <span class="attr">weight</span>: c.<span class="property">weight</span>,</span><br><span class="line">    &#125;)),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查用户余额</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, wallet.<span class="property">publicKey</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> account = <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, userAta);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`User balance for <span class="subst">$&#123;token&#125;</span>: <span class="subst">$&#123;account.amount&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`No account found for token <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-性能监控"><a href="#3-性能监控" class="headerlink" title="3. 性能监控"></a>3. 性能监控</h3><h4 id="A-交易成本分析"><a href="#A-交易成本分析" class="headerlink" title="A. 交易成本分析"></a>A. 交易成本分析</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 估算交易成本</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">estimateTransactionCost</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">etfInfo</span>: <span class="title class_">EtfToken</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lamports</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseFee = <span class="number">5000</span>; <span class="comment">// 基础交易费用（lamports）</span></span><br><span class="line">    <span class="keyword">const</span> accountCreationFee = <span class="number">2039280</span>; <span class="comment">// ATA创建费用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> totalCost = baseFee;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查需要创建的账户数量</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123;token&#125; <span class="keyword">of</span> etfInfo.<span class="property">constituent</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> etfAta = <span class="title function_">getAssociatedTokenAddressSync</span>(token, etfCoreAddress, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">getAccount</span>(provider.<span class="property">connection</span>, etfAta);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">TokenAccountNotFoundError</span>) &#123;</span><br><span class="line">                totalCost += accountCreationFee;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> totalCost;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-Gas使用优化"><a href="#B-Gas使用优化" class="headerlink" title="B. Gas使用优化"></a>B. Gas使用优化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态计算所需计算单元</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">calculateComputeUnits</span> = (<span class="params"><span class="attr">constituentCount</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> baseUnits = <span class="number">100_000</span>;</span><br><span class="line">    <span class="keyword">const</span> perTokenUnits = <span class="number">50_000</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">1_400_000</span>, baseUnits + constituentCount * perTokenUnits);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> computeUnits = <span class="title function_">calculateComputeUnits</span>(etfInfo.<span class="property">constituent</span>.<span class="property">length</span>);</span><br><span class="line"><span class="keyword">const</span> modifyComputeUnits = anchor.<span class="property">web3</span>.<span class="property">ComputeBudgetProgram</span>.<span class="title function_">setComputeUnitLimit</span>(&#123;</span><br><span class="line">    <span class="attr">units</span>: computeUnits,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="最佳实践总结"><a href="#最佳实践总结" class="headerlink" title="最佳实践总结"></a>最佳实践总结</h2><h3 id="1-代码结构"><a href="#1-代码结构" class="headerlink" title="1. 代码结构"></a>1. 代码结构</h3><ul>
<li><strong>模块化设计</strong>：将不同功能分离到独立模块</li>
<li><strong>错误处理</strong>：提供清晰的错误信息和恢复机制</li>
<li><strong>文档注释</strong>：为每个关键函数提供详细说明</li>
</ul>
<h3 id="2-安全考虑"><a href="#2-安全考虑" class="headerlink" title="2. 安全考虑"></a>2. 安全考虑</h3><ul>
<li><strong>权限验证</strong>：每个操作都要验证调用者权限</li>
<li><strong>数据验证</strong>：验证所有输入参数的有效性</li>
<li><strong>原子性</strong>：确保复杂操作的原子性</li>
</ul>
<h3 id="3-用户体验"><a href="#3-用户体验" class="headerlink" title="3. 用户体验"></a>3. 用户体验</h3><ul>
<li><strong>自动化</strong>：自动处理账户创建等复杂操作</li>
<li><strong>透明性</strong>：提供清晰的操作反馈和状态信息</li>
<li><strong>错误恢复</strong>：提供友好的错误提示和恢复建议</li>
</ul>
<h3 id="4-扩展性"><a href="#4-扩展性" class="headerlink" title="4. 扩展性"></a>4. 扩展性</h3><ul>
<li><strong>配置化</strong>：使用配置参数而非硬编码值</li>
<li><strong>接口设计</strong>：设计清晰的公共接口</li>
<li><strong>版本管理</strong>：支持程序和数据结构的版本升级</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本教程详细介绍了Solana上ETF代币购买功能的完整实现，包括：</p>
<ol>
<li><strong>账户结构设计</strong>：定义了安全可靠的账户验证机制</li>
<li><strong>核心业务逻辑</strong>：实现了原子性的资产转移和代币铸造</li>
<li><strong>客户端集成</strong>：提供了完整的前端调用示例</li>
<li><strong>错误处理</strong>：建立了完善的错误检测和恢复机制</li>
<li><strong>性能优化</strong>：通过算法优化和资源管理提升效率</li>
</ol>
<p>通过这个实现，用户可以安全、高效地购买ETF代币，而开发者也获得了一个可扩展、可维护的代码基础。这为构建更复杂的DeFi产品奠定了坚实基础。</p>
<p><strong>关键技术要点回顾</strong>：</p>
<ul>
<li>✅ PDA权限控制确保安全性</li>
<li>✅ 原子性操作防止部分执行</li>
<li>✅ 自动账户管理提升用户体验</li>
<li>✅ 灵活的权重配置支持多样化投资策略</li>
<li>✅ 完善的错误处理机制提高稳定性</li>
</ul>
<p>这个ETF购买系统不仅展示了Solana程序开发的最佳实践，也为理解复杂DeFi协议的内部机制提供了宝贵的学习材料。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/20/Solana%E5%AE%9E%E6%88%98-%E5%88%9B%E5%BB%BAETF%E6%8C%87%E4%BB%A4%E7%9A%84%E8%B0%83%E7%94%A8/" rel="prev" title="Solana实战-创建ETF指令的调用">
                  <i class="fa fa-angle-left"></i> Solana实战-创建ETF指令的调用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/22/Solana%E5%AE%9E%E6%88%98-ETF%E7%9A%84%E8%B5%8E%E5%9B%9E/" rel="next" title="Solana实战-ETF的赎回">
                  Solana实战-ETF的赎回 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">samxie</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
